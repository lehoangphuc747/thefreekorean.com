<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện Tập Phụ Âm Tiếng Hàn (Cấu Trúc Mới - Cập Nhật Bài 1 Lần 3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Visualization & Content Choices:
    - Navigation: List of buttons for "Bài 1" through "Bài 5".
    - Exercise 1 (Comprehensive Single Syllable - Visual Groups):
        - Goal: Practice single syllables with direct consonant/vowel selection from visually grouped sections.
        - Viz/Presentation: Visually distinct sections for Plain Consonants, Aspirated Consonants, Tense Consonants, Basic Vowels, and Double Vowels, each containing their respective character buttons. Display for main/comparison syllables (comparison always shown if applicable). "Random Single Syllable" button (from all characters).
    - Exercises 2-4 (Sequence Reading): (Same as before)
    - Exercise 5 (Vocabulary Practice): (Same as before)
    - All text in Vietnamese.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4;
            color: #44403c;
        }
        .syllable-display-container, .sequence-display-container, .vocab-display-container {
            border: 2px solid #bfdbfe;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .syllable-char-display {
            font-size: 3rem; 
            line-height: 1.2;
            min-height: 60px;
        }
        .syllable-sequence-display, .vocab-word-display, .vocab-meaning-display {
            font-size: 2rem; 
            line-height: 1.5;
            min-height: 60px; 
            padding: 1rem;
            text-align: center;
        }
        .vocab-meaning-display {
            color: #3b82f6; 
        }
         .syllable-label, .group-label {
            font-size: 0.875rem; 
            color: #57534e;
            margin-bottom: 0.25rem;
            display: block;
        }
        .group-label {
            font-weight: 600; /* semibold */
            color: #1d4ed8; /* blue-700 */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #dbeafe; /* blue-200 */
        }
        .btn-char, .nav-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #93c5fd;
        }
        .btn-char:hover, .nav-btn:hover {
            background-color: #60a5fa;
            color: #eff6ff;
        }
        .btn-char.selected, .nav-btn.active {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            border-color: #2563eb;
        }
        .btn-action {
            background-color: #60a5fa;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .btn-action:hover {
            background-color: #3b82f6;
        }
        .exercise-section {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: none; 
        }
        .exercise-section.active {
            display: block; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #navigation-menu button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 0.5rem;
            padding: 0.75rem 1rem;
        }
        .character-grid {
            display: grid;
            gap: 0.5rem; /* Tailwind gap-2 */
        }
        /* Adjust grid columns for different character groups */
        #consonants-plain-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); } /* More flexible */
        #consonants-aspirated-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        #consonants-tense-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        #vowels-basic-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        #vowels-double-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }

        /* Vocabulary Section Enhancements */
        .vocab-mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .vocab-mode-btn {
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .vocab-mode-btn:hover {
            background-color: #d1d5db;
        }
        .vocab-mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .vocab-category-selector {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .vocab-category-btn {
            background-color: #f3f4f6;
            color: #6b7280;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        .vocab-category-btn:hover {
            background-color: #e5e7eb;
        }
        .vocab-category-btn.active {
            background-color: #dbeafe;
            color: #2563eb;
        }
        .vocab-quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .vocab-quiz-option {
            background-color: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .vocab-quiz-option:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .vocab-quiz-option.correct {
            background-color: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        .vocab-quiz-option.incorrect {
            background-color: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }
        .vocab-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .vocab-progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .vocab-progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        .vocab-feedback {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: 500;
        }
        .vocab-feedback.correct {
            background-color: #dcfce7;
            color: #15803d;
        }
        .vocab-feedback.incorrect {
            background-color: #fef2f2;
            color: #dc2626;
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .pulse {
            animation: pulse 0.6s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400,700&display=swap" rel="stylesheet">
    <script src="navigation.js"></script>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-6xl">        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-blue-700" style="font-family: 'Noto Sans KR', sans-serif;">Luyện Tập Phụ Âm Tiếng Hàn (Cấu Trúc Mới)</h1>
        </div>

        <div class="flex flex-col md:flex-row gap-8">
            <aside class="w-full md:w-1/4">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Mục Lục Bài Tập</h2>
                <nav id="navigation-menu">
                    </nav>
            </aside>

            <main class="w-full md:w-3/4">
                <div id="exercise-content-area">
                    </div>
            </main>
        </div>

        <footer class="text-center mt-12 py-6 border-t border-stone-300">
            <p class="text-sm text-stone-500">Ứng dụng luyện tập tổng hợp phụ âm tiếng Hàn. Phát triển bởi AI.</p>
        </footer>
    </div>

    <script>
        const exercises = [
            { id: 'ex_single_syllable', title: 'Bài 1: Luyện Phát Âm Đơn Âm Tiết (Tổng Hợp)', isSingleSyllablePractice: true },
            { id: 'ex_seq_easy', title: 'Bài 2: Đọc Chuỗi (Dễ)', isSequenceReading: true, sequenceParams: { countRange: [2, 3], consonantTypes: ['plain'], vowelGroupKey: 'basic_y' } },
            { id: 'ex_seq_medium', title: 'Bài 3: Đọc Chuỗi (Trung Bình)', isSequenceReading: true, sequenceParams: { countRange: [3, 4], consonantTypes: ['plain', 'aspirated'], vowelGroupKey: 'all' } },
            { id: 'ex_seq_hard', title: 'Bài 4: Đọc Chuỗi (Khó)', isSequenceReading: true, sequenceParams: { countRange: [4, 5], consonantTypes: ['plain', 'aspirated', 'tense'], vowelGroupKey: 'all' } },
            { id: 'ex_vocab', title: 'Bài 5: Luyện Từ Vựng', isVocabularyPractice: true }
        ];

        const allConsonantsWithTypes = [ 
            { char: 'ㄱ', type: 'plain' }, { char: 'ㄴ', type: 'plain' }, { char: 'ㄷ', type: 'plain' }, { char: 'ㄹ', type: 'plain' },
            { char: 'ㅁ', type: 'plain' }, { char: 'ㅂ', type: 'plain' }, { char: 'ㅅ', type: 'plain' }, { char: 'ㅇ', type: 'plain' },
            { char: 'ㅈ', type: 'plain' }, { char: 'ㅎ', type: 'plain' },
            { char: 'ㅋ', type: 'aspirated' }, { char: 'ㅌ', type: 'aspirated' }, { char: 'ㅍ', type: 'aspirated' }, { char: 'ㅊ', type: 'aspirated' },
            { char: 'ㄲ', type: 'tense' }, { char: 'ㄸ', type: 'tense' }, { char: 'ㅃ', type: 'tense' }, { char: 'ㅆ', type: 'tense' }, { char: 'ㅉ', type: 'tense' }
        ];
        
        const consonantGroupsForDisplay = { 
            plain: ['ㄱ', 'ㄴ', 'ㄷ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅅ', 'ㅇ', 'ㅈ', 'ㅎ'],
            aspirated: ['ㅋ', 'ㅌ', 'ㅍ', 'ㅊ'],
            tense: ['ㄲ', 'ㄸ', 'ㅃ', 'ㅆ', 'ㅉ']
        };

        const vowelGroupsForDisplay = { 
            basic: ['ㅏ', 'ㅑ', 'ㅓ', 'ㅕ', 'ㅗ', 'ㅛ', 'ㅜ', 'ㅠ', 'ㅡ', 'ㅣ'], 
            double: ['ㅐ', 'ㅒ', 'ㅔ', 'ㅖ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅢ'] 
        };
         const allVowelsForRandom = [...vowelGroupsForDisplay.basic, ...vowelGroupsForDisplay.double];
        
        const vowelGroupsForSequence = { // Used by sequence generation logic
            all: allVowelsForRandom,
            basic_y: vowelGroupsForDisplay.basic 
        };
        
        const aspiratedToPlainMap = {'ㅋ': 'ㄱ', 'ㅌ': 'ㄷ', 'ㅍ': 'ㅂ', 'ㅊ': 'ㅈ'};
        const tenseToPlainMap = {'ㄲ': 'ㄱ', 'ㄸ': 'ㄷ', 'ㅃ': 'ㅂ', 'ㅆ': 'ㅅ', 'ㅉ': 'ㅈ'};

        const syllableMaps = { 
            plain: {
                'ㄱ': {'ㅏ':'가', 'ㅐ':'개', 'ㅑ':'갸', 'ㅒ':'걔', 'ㅓ':'거', 'ㅔ':'게', 'ㅕ':'겨', 'ㅖ':'계', 'ㅗ':'고', 'ㅘ':'과', 'ㅙ':'괘', 'ㅚ':'괴', 'ㅛ':'교', 'ㅜ':'구', 'ㅝ':'궈', 'ㅞ':'궤', 'ㅟ':'귀', 'ㅠ':'규', 'ㅡ':'그', 'ㅢ':'긔', 'ㅣ':'기'},
                'ㄴ': {'ㅏ':'나', 'ㅐ':'내', 'ㅑ':'냐', 'ㅒ':'냬', 'ㅓ':'너', 'ㅔ':'네', 'ㅕ':'녀', 'ㅖ':'녜', 'ㅗ':'노', 'ㅘ':'놔', 'ㅙ':'놰', 'ㅚ':'뇌', 'ㅛ':'뇨', 'ㅜ':'누', 'ㅝ':'눠', 'ㅞ':'눼', 'ㅟ':'뉘', 'ㅠ':'뉴', 'ㅡ':'느', 'ㅢ':'늬', 'ㅣ':'니'},
                'ㄷ': {'ㅏ':'다', 'ㅐ':'대', 'ㅑ':'댜', 'ㅒ':'댸', 'ㅓ':'더', 'ㅔ':'데', 'ㅕ':'뎌', 'ㅖ':'뎨', 'ㅗ':'도', 'ㅘ':'돠', 'ㅙ':'돼', 'ㅚ':'되', 'ㅛ':'됴', 'ㅜ':'두', 'ㅝ':'둬', 'ㅞ':'뒈', 'ㅟ':'뒤', 'ㅠ':'듀', 'ㅡ':'드', 'ㅢ':'듸', 'ㅣ':'디'},
                'ㄹ': {'ㅏ':'라', 'ㅐ':'래', 'ㅑ':'랴', 'ㅒ':'럐', 'ㅓ':'러', 'ㅔ':'레', 'ㅕ':'려', 'ㅖ':'례', 'ㅗ':'로', 'ㅘ':'롸', 'ㅙ':'뢔', 'ㅚ':'뢰', 'ㅛ':'료', 'ㅜ':'루', 'ㅝ':'뤄', 'ㅞ':'뤠', 'ㅟ':'뤼', 'ㅠ':'류', 'ㅡ':'르', 'ㅢ':'릐', 'ㅣ':'리'},
                'ㅁ': {'ㅏ':'마', 'ㅐ':'매', 'ㅑ':'먀', 'ㅒ':'먜', 'ㅓ':'머', 'ㅔ':'메', 'ㅕ':'며', 'ㅖ':'몌', 'ㅗ':'모', 'ㅘ':'뫄', 'ㅙ':'뫠', 'ㅚ':'뫼', 'ㅛ':'묘', 'ㅜ':'무', 'ㅝ':'뭐', 'ㅞ':'뭬', 'ㅟ':'뮈', 'ㅠ':'뮤', 'ㅡ':'므', 'ㅢ':'믜', 'ㅣ':'미'},
                'ㅂ': {'ㅏ':'바', 'ㅐ':'배', 'ㅑ':'뱌', 'ㅒ':'뱨', 'ㅓ':'버', 'ㅔ':'베', 'ㅕ':'벼', 'ㅖ':'볘', 'ㅗ':'보', 'ㅘ':'봐', 'ㅙ':'봬', 'ㅚ':'뵈', 'ㅛ':'뵤', 'ㅜ':'부', 'ㅝ':'붜', 'ㅞ':'붸', 'ㅟ':'뷔', 'ㅠ':'뷰', 'ㅡ':'브', 'ㅢ':'븨', 'ㅣ':'비'},
                'ㅅ': {'ㅏ':'사', 'ㅐ':'새', 'ㅑ':'샤', 'ㅒ':'섀', 'ㅓ':'서', 'ㅔ':'세', 'ㅕ':'셔', 'ㅖ':'셰', 'ㅗ':'소', 'ㅘ':'솨', 'ㅙ':'쇄', 'ㅚ':'쇠', 'ㅛ':'쇼', 'ㅜ':'수', 'ㅝ':'숴', 'ㅞ':'쉐', 'ㅟ':'쉬', 'ㅠ':'슈', 'ㅡ':'스', 'ㅢ':'싀', 'ㅣ':'시'},
                'ㅇ': {'ㅏ':'아', 'ㅐ':'애', 'ㅑ':'야', 'ㅒ':'얘', 'ㅓ':'어', 'ㅔ':'에', 'ㅕ':'여', 'ㅖ':'예', 'ㅗ':'오', 'ㅘ':'와', 'ㅙ':'왜', 'ㅚ':'외', 'ㅛ':'요', 'ㅜ':'우', 'ㅝ':'워', 'ㅞ':'웨', 'ㅟ':'위', 'ㅠ':'유', 'ㅡ':'으', 'ㅢ':'의', 'ㅣ':'이'},
                'ㅈ': {'ㅏ':'자', 'ㅐ':'재', 'ㅑ':'쟈', 'ㅒ':'쟤', 'ㅓ':'저', 'ㅔ':'제', 'ㅕ':'져', 'ㅖ':'졔', 'ㅗ':'조', 'ㅘ':'좌', 'ㅙ':'좨', 'ㅚ':'죄', 'ㅛ':'죠', 'ㅜ':'주', 'ㅝ':'줘', 'ㅞ':'줴', 'ㅟ':'쥐', 'ㅠ':'쥬', 'ㅡ':'즈', 'ㅢ':'즤', 'ㅣ':'지'},
                'ㅎ': {'ㅏ':'하', 'ㅐ':'해', 'ㅑ':'햐', 'ㅒ':'햬', 'ㅓ':'허', 'ㅔ':'헤', 'ㅕ':'혀', 'ㅖ':'혜', 'ㅗ':'호', 'ㅘ':'화', 'ㅙ':'홰', 'ㅚ':'회', 'ㅛ':'효', 'ㅜ':'후', 'ㅝ':'훠', 'ㅞ':'훼', 'ㅟ':'휘', 'ㅠ':'휴', 'ㅡ':'흐', 'ㅢ':'희', 'ㅣ':'히'}
            },
            aspirated: {
                'ㅋ': {'ㅏ':'카', 'ㅐ':'캐', 'ㅑ':'캬', 'ㅒ':'컈', 'ㅓ':'커', 'ㅔ':'케', 'ㅕ':'켜', 'ㅖ':'켸', 'ㅗ':'코', 'ㅘ':'콰', 'ㅙ':'쾌', 'ㅚ':'쾨', 'ㅛ':'쿄', 'ㅜ':'쿠', 'ㅝ':'쿼', 'ㅞ':'퀘', 'ㅟ':'퀴', 'ㅠ':'큐', 'ㅡ':'크', 'ㅢ':'킈', 'ㅣ':'키'},
                'ㅌ': {'ㅏ':'타', 'ㅐ':'태', 'ㅑ':'탸', 'ㅒ':'턔', 'ㅓ':'터', 'ㅔ':'테', 'ㅕ':'텨', 'ㅖ':'톄', 'ㅗ':'토', 'ㅘ':'톼', 'ㅙ':'퇘', 'ㅚ':'퇴', 'ㅛ':'툐', 'ㅜ':'투', 'ㅝ':'퉈', 'ㅞ':'퉤', 'ㅟ':'튀', 'ㅠ':'튜', 'ㅡ':'트', 'ㅢ':'틔', 'ㅣ':'티'},
                'ㅍ': {'ㅏ':'파', 'ㅐ':'패', 'ㅑ':'퍄', 'ㅒ':'퍠', 'ㅓ':'퍼', 'ㅔ':'페', 'ㅕ':'펴', 'ㅖ':'폐', 'ㅗ':'포', 'ㅘ':'퐈', 'ㅙ':'퐤', 'ㅚ':'푀', 'ㅛ':'표', 'ㅜ':'푸', 'ㅝ':'풔', 'ㅞ':'풰', 'ㅟ':'퓌', 'ㅠ':'퓨', 'ㅡ':'프', 'ㅢ':'픠', 'ㅣ':'피'},
                'ㅊ': {'ㅏ':'차', 'ㅐ':'채', 'ㅑ':'챠', 'ㅒ':'챼', 'ㅓ':'처', 'ㅔ':'체', 'ㅕ':'쳐', 'ㅖ':'쳬', 'ㅗ':'초', 'ㅘ':'촤', 'ㅙ':'쵀', 'ㅚ':'최', 'ㅛ':'쵸', 'ㅜ':'추', 'ㅝ':'춰', 'ㅞ':'췌', 'ㅟ':'취', 'ㅠ':'츄', 'ㅡ':'츠', 'ㅢ':'츼', 'ㅣ':'치'}
            },
            tense: {
                'ㄲ': {'ㅏ':'까', 'ㅐ':'깨', 'ㅑ':'꺄', 'ㅒ':'꺠', 'ㅓ':'꺼', 'ㅔ':'께', 'ㅕ':'껴', 'ㅖ':'꼐', 'ㅗ':'꼬', 'ㅘ':'꽈', 'ㅙ':'꽤', 'ㅚ':'꾀', 'ㅛ':'꾜', 'ㅜ':'꾸', 'ㅝ':'꿔', 'ㅞ':'꿰', 'ㅟ':'뀌', 'ㅠ':'뀨', 'ㅡ':'끄', 'ㅢ':'끠', 'ㅣ':'끼'},
                'ㄸ': {'ㅏ':'따', 'ㅐ':'때', 'ㅑ':'땨', 'ㅒ':'떄', 'ㅓ':'떠', 'ㅔ':'떼', 'ㅕ':'뗘', 'ㅖ':'뗴', 'ㅗ':'또', 'ㅘ':'똬', 'ㅙ':'뙈', 'ㅚ':'뙤', 'ㅛ':'뚀', 'ㅜ':'뚜', 'ㅝ':'뚸', 'ㅞ':'뛔', 'ㅟ':'뛰', 'ㅠ':'뜌', 'ㅡ':'뜨', 'ㅢ':'띄', 'ㅣ':'띠'},
                'ㅃ': {'ㅏ':'빠', 'ㅐ':'빼', 'ㅑ':'뺘', 'ㅒ':'뺴', 'ㅓ':'뻐', 'ㅔ':'뻬', 'ㅕ':'뼈', 'ㅖ':'뼤', 'ㅗ':'뽀', 'ㅘ':'뽜', 'ㅙ':'뽸', 'ㅚ':'뾔', 'ㅛ':'뾰', 'ㅜ':'뿌', 'ㅝ':'뿨', 'ㅞ':'쀄', 'ㅟ':'쀠', 'ㅠ':'쀼', 'ㅡ':'쁘', 'ㅢ':'쁴', 'ㅣ':'삐'},
                'ㅆ': {'ㅏ':'싸', 'ㅐ':'쌔', 'ㅑ':'쌰', 'ㅒ':'썌', 'ㅓ':'써', 'ㅔ':'쎄', 'ㅕ':'쎠', 'ㅖ':'쎼', 'ㅗ':'쏘', 'ㅘ':'쏴', 'ㅙ':'쐐', 'ㅚ':'쇠', 'ㅛ':'쑈', 'ㅜ':'쑤', 'ㅝ':'쒀', 'ㅞ':'쒜', 'ㅟ':'쒸', 'ㅠ':'쓔', 'ㅡ':'쓰', 'ㅢ':'씌', 'ㅣ':'씨'},
                'ㅉ': {'ㅏ':'짜', 'ㅐ':'째', 'ㅑ':'쨔', 'ㅒ':'쨰', 'ㅓ':'쩌', 'ㅔ':'쩨', 'ㅕ':'쪄', 'ㅖ':'쪠', 'ㅗ':'쪼', 'ㅘ':'쫘', 'ㅙ':'쫴', 'ㅚ':'쬐', 'ㅛ':'쬬', 'ㅜ':'쭈', 'ㅝ':'쭤', 'ㅞ':'쮀', 'ㅟ':'쮜', 'ㅠ':'쮸', 'ㅡ':'쯔', 'ㅢ':'쯰', 'ㅣ':'찌'}
            }
        };        const vocabularyByCategory = {
            family: [
                { word: '가족', meaning: 'Gia đình', level: 1 },
                { word: '아버지', meaning: 'Bố', level: 1 },
                { word: '어머니', meaning: 'Mẹ', level: 1 },
                { word: '아들', meaning: 'Con trai', level: 1 },
                { word: '딸', meaning: 'Con gái', level: 1 },
                { word: '형', meaning: 'Anh trai (nam gọi)', level: 2 },
                { word: '누나', meaning: 'Chị gái (nam gọi)', level: 2 },
                { word: '언니', meaning: 'Chị gái (nữ gọi)', level: 2 },
                { word: '동생', meaning: 'Em', level: 1 }
            ],
            body: [
                { word: '머리', meaning: 'Đầu', level: 1 },
                { word: '눈', meaning: 'Mắt', level: 1 },
                { word: '코', meaning: 'Mũi', level: 1 },
                { word: '입', meaning: 'Miệng', level: 1 },
                { word: '귀', meaning: 'Tai', level: 1 },
                { word: '손', meaning: 'Tay', level: 1 },
                { word: '발', meaning: 'Chân', level: 1 },
                { word: '다리', meaning: 'Chân (từ hông xuống)', level: 2 }
            ],
            animals: [
                { word: '고양이', meaning: 'Mèo', level: 1 },
                { word: '강아지', meaning: 'Chó con', level: 1 },
                { word: '사자', meaning: 'Sư tử', level: 2 },
                { word: '토끼', meaning: 'Con thỏ', level: 1 },
                { word: '새', meaning: 'Chim', level: 1 },
                { word: '물고기', meaning: 'Cá', level: 1 },
                { word: '까치', meaning: 'Chim ác là', level: 3 },
                { word: '코끼리', meaning: 'Voi', level: 2 }
            ],
            food: [
                { word: '밥', meaning: 'Cơm', level: 1 },
                { word: '빵', meaning: 'Bánh mì', level: 1 },
                { word: '물', meaning: 'Nước', level: 1 },
                { word: '우유', meaning: 'Sữa', level: 1 },
                { word: '사과', meaning: 'Táo', level: 1 },
                { word: '바나나', meaning: 'Chuối', level: 1 },
                { word: '김치', meaning: 'Kim chi', level: 2 },
                { word: '라면', meaning: 'Mì tôm', level: 2 }
            ],
            basic: [
                { word: '안녕하세요', meaning: 'Xin chào', level: 1 },
                { word: '감사합니다', meaning: 'Cảm ơn', level: 1 },
                { word: '죄송합니다', meaning: 'Xin lỗi', level: 1 },
                { word: '네', meaning: 'Vâng/Có', level: 1 },
                { word: '아니요', meaning: 'Không', level: 1 },
                { word: '좋아요', meaning: 'Tốt', level: 1 },
                { word: '나쁘다', meaning: 'Xấu/Tệ', level: 2 },
                { word: '크다', meaning: 'To/Lớn', level: 2 }
            ]
        };

        // Flatten all vocabulary for random selection
        const allVocabulary = Object.values(vocabularyByCategory).flat();        let activeExerciseId = 'ex_single_syllable';
        let selectedConsonant = null; 
        let selectedVowel = null;
        let selectedConsonantActualType = 'plain'; 
        let currentVocabIndex = -1;
        
        // Vocabulary Practice Variables
        let currentVocabMode = 'review'; // 'review', 'quiz', 'flashcard'
        let currentCategory = 'all';
        let currentQuizOptions = [];
        let correctAnswers = 0;
        let totalQuestions = 0;
        let reviewedWords = new Set();
        let difficulty = 1; // 1, 2, 3

        const navigationMenu = document.getElementById('navigation-menu');
        const exerciseContentArea = document.getElementById('exercise-content-area');

        // --- Element variables (will be reassigned in render functions) ---
        let mainSyllableCharDisplay, plainComparisonSyllableCharDisplay, syllablePlaceholder, 
            consonantsPlainGrid, consonantsAspiratedGrid, consonantsTenseGrid,
            vowelsBasicGrid, vowelsDoubleGrid,
            randomSingleSyllableButtonInteractive, interactiveSyllableGrid;

        let syllableSequenceDisplay, generateSequenceButton;
        
        let vocabWordDisplay, vocabMeaningDisplay, nextVocabButton, showMeaningButton;
        
        function renderExerciseUI(exercise) {
            exerciseContentArea.innerHTML = ''; 
            selectedConsonant = null; 
            selectedVowel = null;

            if (exercise.isSingleSyllablePractice) {
                renderSingleSyllablePracticeUI(exercise);
            } else if (exercise.isSequenceReading) {
                renderSequenceReadingUI(exercise);
            } else if (exercise.isVocabularyPractice) {
                renderVocabularyPracticeUI(exercise);
            }
        }

        function renderSingleSyllablePracticeUI(exercise) {
            exerciseContentArea.innerHTML = `
                <section id="single-syllable-practice-section" class="exercise-section active">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-3" style="font-family: 'Noto Sans KR', sans-serif;">${exercise.title}</h2>
                    <p id="interactive-instructions" class="text-stone-600 mb-6">Chọn một phụ âm và một nguyên âm. Âm chính và âm thường tương ứng (nếu có) sẽ được hiển thị để so sánh.</p>
                    
                    <div class="flex flex-col lg:flex-row gap-8 items-start">
                        <div class="w-full lg:w-1/2">
                            <div>
                                <h3 class="group-label">Phụ Âm Thường</h3>
                                <div id="consonants-plain-grid" class="character-grid mb-4"></div>
                                <h3 class="group-label">Phụ Âm Bật Hơi</h3>
                                <div id="consonants-aspirated-grid" class="character-grid mb-4"></div>
                                <h3 class="group-label">Phụ Âm Căng</h3>
                                <div id="consonants-tense-grid" class="character-grid"></div>
                            </div>
                        </div>
                        <div class="w-full lg:w-1/2">
                            <div>
                                <h3 class="group-label">Nguyên Âm Thường (10)</h3>
                                <div id="vowels-basic-grid" class="character-grid mb-4"></div>
                                <h3 class="group-label">Nguyên Âm Đôi (11)</h3>
                                <div id="vowels-double-grid" class="character-grid"></div>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-semibold mb-2 text-center text-blue-700">Âm Tiết Kết Hợp</h3>
                                <div id="syllable-display-container" class="syllable-display-container">
                                    <div id="interactive-syllable-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center text-center">
                                        <div class="main-syllable-column">
                                            <span class="syllable-label">Âm Chính</span>
                                            <div id="main-syllable-char" class="syllable-char-display text-blue-700 font-bold" style="font-family: 'Noto Sans KR', sans-serif;">--</div>
                                        </div>
                                        <div class="plain-comparison-column">
                                            <span class="syllable-label">Âm Thường T.Ứng (Nếu có)</span>
                                            <div id="plain-comparison-syllable-char" class="syllable-char-display text-blue-600" style="font-family: 'Noto Sans KR', sans-serif;">--</div>
                                        </div>
                                    </div>
                                    <p id="syllable-placeholder" class="text-center text-stone-500 mt-2">Chọn phụ âm & nguyên âm</p>
                                </div>
                                <div class="text-center mt-6">
                                    <button id="random-single-syllable-button-interactive" class="btn-action py-2 px-4">Âm Tiết Ngẫu Nhiên (Từ Tất Cả)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            assignInteractiveSingleElements(); 
            randomSingleSyllableButtonInteractive.addEventListener('click', generateRandomSingleSyllableInteractive);

            populateAllConsonantsForSingleSyllablePractice();
            populateAllVowelsForSingleSyllablePractice(); 
            updateSyllableDisplay(); 
        }
        
        function renderSequenceReadingUI(exercise) {
             exerciseContentArea.innerHTML = `
                <section id="sequence-reading-section" class="exercise-section active">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-3" style="font-family: 'Noto Sans KR', sans-serif;">${exercise.title}</h2>
                    <p class="text-stone-600 mb-6">Nhấn nút "Tạo Chuỗi Mới" để luyện đọc một chuỗi các âm tiết.</p>
                    <div class="text-center mb-6">
                        <button id="generate-sequence-button" class="btn-action py-3 px-6 rounded-lg font-semibold text-lg shadow-md">
                            Tạo Chuỗi Mới
                        </button>
                    </div>
                    <div id="syllable-sequence-display-container" class="sequence-display-container">
                        <div id="syllable-sequence-display" class="syllable-sequence-display text-blue-700 font-bold" style="font-family: 'Noto Sans KR', sans-serif;">Hãy nhấn nút để bắt đầu!</div>
                    </div>
                </section>
            `;
            assignSequenceReadingElements();
            generateSequenceButton.addEventListener('click', () => generateSyllableSequence(exercise.sequenceParams));
            generateSyllableSequence(exercise.sequenceParams); 
        }        function renderVocabularyPracticeUI(exercise) {
            exerciseContentArea.innerHTML = `
                <section id="vocabulary-practice-section" class="exercise-section active">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-3" style="font-family: 'Noto Sans KR', sans-serif;">${exercise.title}</h2>
                    <p class="text-stone-600 mb-6">Luyện đọc từ và học nghĩa của chúng với nhiều chế độ khác nhau.</p>
                    
                    <!-- Mode Selection -->
                    <div class="vocab-mode-selector">
                        <button class="vocab-mode-btn active" data-mode="review">📖 Ôn Tập</button>
                        <button class="vocab-mode-btn" data-mode="quiz">🧠 Trắc Nghiệm</button>
                        <button class="vocab-mode-btn" data-mode="flashcard">🃏 Thẻ Ghi Nhớ</button>
                    </div>

                    <!-- Category Selection -->
                    <div class="vocab-category-selector">
                        <button class="vocab-category-btn active" data-category="all">Tất Cả</button>
                        <button class="vocab-category-btn" data-category="basic">Cơ Bản</button>
                        <button class="vocab-category-btn" data-category="family">Gia Đình</button>
                        <button class="vocab-category-btn" data-category="body">Cơ Thể</button>
                        <button class="vocab-category-btn" data-category="animals">Động Vật</button>
                        <button class="vocab-category-btn" data-category="food">Thức Ăn</button>
                    </div>

                    <!-- Stats and Progress -->
                    <div id="vocab-stats" class="vocab-stats">
                        <span>Điểm: <strong id="vocab-score">0/0</strong></span>
                        <span>Đã Học: <strong id="vocab-progress">0</strong> từ</span>
                        <span>Độ Khó: <strong id="vocab-difficulty">Cấp 1</strong></span>
                    </div>
                    <div class="vocab-progress-bar">
                        <div id="vocab-progress-fill" class="vocab-progress-fill" style="width: 0%"></div>
                    </div>

                    <!-- Main Display Area -->
                    <div id="vocab-display-container" class="vocab-display-container text-center">
                        <!-- Review Mode -->
                        <div id="review-mode" class="vocab-mode-content">
                            <div id="vocab-word-display" class="vocab-word-display text-blue-700 font-bold mb-4" style="font-family: 'Noto Sans KR', sans-serif;">Nhấn "Từ Mới"</div>
                            <div id="vocab-meaning-display" class="vocab-meaning-display mb-6 hidden" style="font-family: 'Inter', sans-serif;">--</div>
                            <div class="flex justify-center gap-4">
                                <button id="next-vocab-button" class="btn-action py-2 px-4">📚 Từ Mới</button>
                                <button id="show-meaning-button" class="btn-action py-2 px-4 bg-sky-500 hover:bg-sky-600">👁️ Xem Nghĩa</button>
                            </div>
                        </div>

                        <!-- Quiz Mode -->
                        <div id="quiz-mode" class="vocab-mode-content hidden">
                            <div id="quiz-question" class="vocab-word-display text-blue-700 font-bold mb-4" style="font-family: 'Noto Sans KR', sans-serif;">안녕하세요</div>
                            <p class="text-sm text-gray-600 mb-4">Chọn nghĩa đúng của từ trên:</p>
                            <div id="quiz-options" class="vocab-quiz-options">
                                <!-- Quiz options will be inserted here -->
                            </div>
                            <div id="quiz-feedback" class="vocab-feedback hidden"></div>
                            <button id="next-quiz-button" class="btn-action py-2 px-4 mt-4 hidden">➡️ Câu Tiếp Theo</button>
                        </div>

                        <!-- Flashcard Mode -->
                        <div id="flashcard-mode" class="vocab-mode-content hidden">
                            <div class="flashcard relative">
                                <div id="flashcard-front" class="flashcard-side">
                                    <div id="flashcard-word" class="vocab-word-display text-blue-700 font-bold mb-4" style="font-family: 'Noto Sans KR', sans-serif;">안녕하세요</div>
                                    <p class="text-sm text-gray-600">Nhấn để lật thẻ</p>
                                </div>
                                <div id="flashcard-back" class="flashcard-side hidden">
                                    <div id="flashcard-meaning" class="vocab-meaning-display text-blue-600" style="font-family: 'Inter', sans-serif;">Xin chào</div>
                                    <p class="text-sm text-gray-600">Nhấn để lật lại</p>
                                </div>
                            </div>
                            <div class="flex justify-center gap-4 mt-6">
                                <button id="flashcard-flip" class="btn-action py-2 px-4 bg-purple-500 hover:bg-purple-600">🔄 Lật Thẻ</button>
                                <button id="flashcard-next" class="btn-action py-2 px-4">➡️ Thẻ Tiếp</button>
                            </div>
                            <div class="flex justify-center gap-2 mt-4">
                                <button id="flashcard-easy" class="btn-action py-1 px-3 text-sm bg-green-500 hover:bg-green-600">😊 Dễ</button>
                                <button id="flashcard-medium" class="btn-action py-1 px-3 text-sm bg-yellow-500 hover:bg-yellow-600">😐 Bình Thường</button>
                                <button id="flashcard-hard" class="btn-action py-1 px-3 text-sm bg-red-500 hover:bg-red-600">😓 Khó</button>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            assignVocabularyElements();
            setupVocabularyEventListeners();
            updateVocabularyStats();
            changeVocabularyMode('review');
        }

        function assignInteractiveSingleElements() { 
            mainSyllableCharDisplay = document.getElementById('main-syllable-char');
            plainComparisonSyllableCharDisplay = document.getElementById('plain-comparison-syllable-char');
            syllablePlaceholder = document.getElementById('syllable-placeholder');
            interactiveSyllableGrid = document.getElementById('interactive-syllable-grid'); 
            
            consonantsPlainGrid = document.getElementById('consonants-plain-grid');
            consonantsAspiratedGrid = document.getElementById('consonants-aspirated-grid');
            consonantsTenseGrid = document.getElementById('consonants-tense-grid');
            vowelsBasicGrid = document.getElementById('vowels-basic-grid');
            vowelsDoubleGrid = document.getElementById('vowels-double-grid');
            
            randomSingleSyllableButtonInteractive = document.getElementById('random-single-syllable-button-interactive');
        }
        
        function assignSequenceReadingElements() {
            syllableSequenceDisplay = document.getElementById('syllable-sequence-display');
            generateSequenceButton = document.getElementById('generate-sequence-button');
        }

        function assignVocabularyElements() {
            vocabWordDisplay = document.getElementById('vocab-word-display');
            vocabMeaningDisplay = document.getElementById('vocab-meaning-display');
            nextVocabButton = document.getElementById('next-vocab-button');
            showMeaningButton = document.getElementById('show-meaning-button');
        }

        function createConsonantButton(consonantObj, gridElement) { 
            const button = document.createElement('button');
            button.textContent = consonantObj.char;
            button.style.fontFamily = "'Noto Sans KR', sans-serif";
            button.classList.add('btn-char', 'p-3', 'rounded-md', 'text-lg', 'font-semibold', 'bg-white', 'text-blue-700', 'shadow-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400');
            button.dataset.char = consonantObj.char;
            button.dataset.consonantType = consonantObj.type; 
            button.dataset.type = 'consonant'; 
            button.addEventListener('click', handleCharSelection);
            if(gridElement) gridElement.appendChild(button);
        }
        
        function createVowelButton(char, gridElement) {
            const button = document.createElement('button');
            button.textContent = char;
            button.style.fontFamily = "'Noto Sans KR', sans-serif";
            button.classList.add('btn-char', 'p-2', 'sm:p-3', 'rounded-md', 'text-base', 'sm:text-lg', 'font-semibold', 'bg-white', 'text-blue-700', 'shadow-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400');
            button.dataset.char = char;
            button.dataset.type = 'vowel';
            button.addEventListener('click', handleCharSelection);
            if(gridElement) gridElement.appendChild(button);
        }

        function populateAllConsonantsForSingleSyllablePractice() {
            if (!consonantsPlainGrid || !consonantsAspiratedGrid || !consonantsTenseGrid) return;
            consonantsPlainGrid.innerHTML = '';
            consonantsAspiratedGrid.innerHTML = '';
            consonantsTenseGrid.innerHTML = '';

            if (selectedConsonant) selectedConsonant.classList.remove('selected');
            selectedConsonant = null; 
            
            allConsonantsWithTypes.forEach(cObj => {
                if (cObj.type === 'plain') createConsonantButton(cObj, consonantsPlainGrid);
                else if (cObj.type === 'aspirated') createConsonantButton(cObj, consonantsAspiratedGrid);
                else if (cObj.type === 'tense') createConsonantButton(cObj, consonantsTenseGrid);
            });
            updateSyllableDisplay();
        }
        
        function populateAllVowelsForSingleSyllablePractice() {
            if (!vowelsBasicGrid || !vowelsDoubleGrid) return;
            vowelsBasicGrid.innerHTML = '';
            vowelsDoubleGrid.innerHTML = '';

            if (selectedVowel) selectedVowel.classList.remove('selected');
            selectedVowel = null; 
            
            vowelGroupsForDisplay.basic.forEach(v => createVowelButton(v, vowelsBasicGrid));
            vowelGroupsForDisplay.double.forEach(v => createVowelButton(v, vowelsDoubleGrid));
            updateSyllableDisplay();
        }
        
        function handleCharSelection(event) {
            const button = event.target;
            const char = button.dataset.char;
            const type = button.dataset.type; // 'consonant' or 'vowel'

            if (type === 'consonant') {
                // Deselect previously selected consonant from ANY grid
                const allConsonantButtons = document.querySelectorAll('#single-syllable-practice-section .btn-char[data-type="consonant"]');
                allConsonantButtons.forEach(btn => btn.classList.remove('selected'));

                if (selectedConsonant === button) {
                    selectedConsonant = null;
                    selectedConsonantActualType = 'plain'; 
                } else { 
                    selectedConsonant = button; 
                    selectedConsonant.classList.add('selected');
                    selectedConsonantActualType = button.dataset.consonantType; 
                }
            } else if (type === 'vowel') {
                const allVowelButtons = document.querySelectorAll('#single-syllable-practice-section .btn-char[data-type="vowel"]');
                allVowelButtons.forEach(btn => btn.classList.remove('selected'));

                if (selectedVowel === button) selectedVowel = null;
                else { selectedVowel = button; selectedVowel.classList.add('selected'); }
            }
            updateSyllableDisplay();
        }

        function updateSyllableDisplay() {
            if (!mainSyllableCharDisplay || !plainComparisonSyllableCharDisplay || !syllablePlaceholder || !interactiveSyllableGrid) return; 

            mainSyllableCharDisplay.classList.remove('fade-in'); 
            plainComparisonSyllableCharDisplay.classList.remove('fade-in');
            void mainSyllableCharDisplay.offsetWidth; 

            let hasComparison = false;
            if (selectedConsonant && selectedVowel) {
                syllablePlaceholder.classList.add('hidden');
                const cSelected = selectedConsonant.dataset.char;
                const vSelected = selectedVowel.dataset.char;
                
                mainSyllableCharDisplay.textContent = syllableMaps[selectedConsonantActualType]?.[cSelected]?.[vSelected] || 'Lỗi';
                
                let plainSyllableText = '--';
                if (selectedConsonantActualType === 'aspirated') {
                    const cPlain = aspiratedToPlainMap[cSelected];
                    plainSyllableText = syllableMaps.plain?.[cPlain]?.[vSelected] || '--';
                    hasComparison = plainSyllableText !== '--';
                } else if (selectedConsonantActualType === 'tense') {
                    const cPlain = tenseToPlainMap[cSelected];
                    plainSyllableText = syllableMaps.plain?.[cPlain]?.[vSelected] || '--';
                    hasComparison = plainSyllableText !== '--';
                }
                plainComparisonSyllableCharDisplay.textContent = plainSyllableText;
                interactiveSyllableGrid.querySelector('.plain-comparison-column').style.visibility = hasComparison ? 'visible' : 'hidden';

            } else {
                syllablePlaceholder.classList.remove('hidden');
                mainSyllableCharDisplay.textContent = '--';
                plainComparisonSyllableCharDisplay.textContent = '--';
                interactiveSyllableGrid.querySelector('.plain-comparison-column').style.visibility = 'visible'; 
                if (selectedConsonant) mainSyllableCharDisplay.textContent = selectedConsonant.dataset.char + '+?';
                if (selectedVowel && !selectedConsonant) mainSyllableCharDisplay.textContent = '?+' + selectedVowel.dataset.char;
            }
            mainSyllableCharDisplay.classList.add('fade-in');
            if (hasComparison) { 
                 plainComparisonSyllableCharDisplay.classList.add('fade-in');
            }
        }
        
        function generateRandomSingleSyllableInteractive() { 
            if (!mainSyllableCharDisplay || !plainComparisonSyllableCharDisplay || !syllablePlaceholder || !interactiveSyllableGrid) return;

            syllablePlaceholder.classList.add('hidden');
            
            const randomConsonantObj = allConsonantsWithTypes[Math.floor(Math.random() * allConsonantsWithTypes.length)];
            const randomCSelected = randomConsonantObj.char;
            const randomCType = randomConsonantObj.type; 
            const randomVSelected = allVowelsForRandom[Math.floor(Math.random() * allVowelsForRandom.length)];

            mainSyllableCharDisplay.textContent = syllableMaps[randomCType]?.[randomCSelected]?.[randomVSelected] || 'Lỗi';
            let plainComparisonSyllable = '--';
            let currentHasComparison = false;

            if (randomCType === 'aspirated') {
                const cPlain = aspiratedToPlainMap[randomCSelected];
                plainComparisonSyllable = syllableMaps.plain?.[cPlain]?.[randomVSelected] || '--';
                currentHasComparison = plainComparisonSyllable !== '--';
            } else if (randomCType === 'tense') {
                const cPlain = tenseToPlainMap[randomCSelected];
                plainComparisonSyllable = syllableMaps.plain?.[cPlain]?.[randomVSelected] || '--';
                currentHasComparison = plainComparisonSyllable !== '--';
            }
            plainComparisonSyllableCharDisplay.textContent = plainComparisonSyllable;
            interactiveSyllableGrid.querySelector('.plain-comparison-column').style.visibility = currentHasComparison ? 'visible' : 'hidden';

            mainSyllableCharDisplay.classList.remove('fade-in');
            plainComparisonSyllableCharDisplay.classList.remove('fade-in');
            void mainSyllableCharDisplay.offsetWidth;
            mainSyllableCharDisplay.classList.add('fade-in');
            if (currentHasComparison) {
                plainComparisonSyllableCharDisplay.classList.add('fade-in');
            }

            if (selectedConsonant) selectedConsonant.classList.remove('selected');
            if (selectedVowel) selectedVowel.classList.remove('selected');
            selectedConsonant = null;
            selectedVowel = null;
            selectedConsonantActualType = 'plain'; 
        }

        function generateSyllableSequence(params) {
            if (!syllableSequenceDisplay) return;
            syllableSequenceDisplay.classList.remove('fade-in');
            void syllableSequenceDisplay.offsetWidth;

            const { countRange, consonantTypes, vowelGroupKey } = params;
            const syllableCount = Math.floor(Math.random() * (countRange[1] - countRange[0] + 1)) + countRange[0];
            const vowelsForSequence = vowelGroupsForSequence[vowelGroupKey] || vowelGroupsForSequence.all;
            
            let sequence = [];
            for (let i = 0; i < syllableCount; i++) {
                const randomConsonantTypeKey = consonantTypes[Math.floor(Math.random() * consonantTypes.length)];
                const consonantsForType = consonantGroupsForDisplay[randomConsonantTypeKey]; 
                const randomC = consonantsForType[Math.floor(Math.random() * consonantsForType.length)];
                const randomV = vowelsForSequence[Math.floor(Math.random() * vowelsForSequence.length)];
                
                const syllable = syllableMaps[randomConsonantTypeKey]?.[randomC]?.[randomV] || ' ? ';
                sequence.push(syllable);
            }
            syllableSequenceDisplay.textContent = sequence.join(' ');
            syllableSequenceDisplay.classList.add('fade-in');
        }
          function displayNextVocabularyWord() {
            if (!vocabWordDisplay || !vocabMeaningDisplay) return;
            const currentVocab = getCurrentVocabulary();
            if (currentVocab.length === 0) return;
            
            currentVocabIndex = Math.floor(Math.random() * currentVocab.length);
            const currentWord = currentVocab[currentVocabIndex];
            vocabWordDisplay.textContent = currentWord.word;
            vocabMeaningDisplay.textContent = currentWord.meaning;
            vocabMeaningDisplay.classList.add('hidden'); 
            if(showMeaningButton) showMeaningButton.textContent = "👁️ Xem Nghĩa";
            
            // Add to reviewed words
            reviewedWords.add(currentWord.word);
            updateVocabularyStats();
        }

        function toggleVocabMeaning() {
            if (!vocabMeaningDisplay || !showMeaningButton) return;
            vocabMeaningDisplay.classList.toggle('hidden');
            showMeaningButton.textContent = vocabMeaningDisplay.classList.contains('hidden') ? "👁️ Xem Nghĩa" : "🙈 Ẩn Nghĩa";
        }

        function getCurrentVocabulary() {
            if (currentCategory === 'all') {
                return allVocabulary.filter(word => word.level <= difficulty);
            }
            return vocabularyByCategory[currentCategory]?.filter(word => word.level <= difficulty) || [];
        }

        function setupVocabularyEventListeners() {
            // Mode selection
            document.querySelectorAll('.vocab-mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.target.dataset.mode;
                    changeVocabularyMode(mode);
                });
            });

            // Category selection
            document.querySelectorAll('.vocab-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const category = e.target.dataset.category;
                    changeVocabularyCategory(category);
                });
            });

            // Review mode buttons
            if (nextVocabButton) nextVocabButton.addEventListener('click', displayNextVocabularyWord);
            if (showMeaningButton) showMeaningButton.addEventListener('click', toggleVocabMeaning);

            // Quiz mode buttons
            const nextQuizButton = document.getElementById('next-quiz-button');
            if (nextQuizButton) nextQuizButton.addEventListener('click', generateQuizQuestion);

            // Flashcard mode buttons
            const flashcardFlip = document.getElementById('flashcard-flip');
            const flashcardNext = document.getElementById('flashcard-next');
            const flashcardEasy = document.getElementById('flashcard-easy');
            const flashcardMedium = document.getElementById('flashcard-medium');
            const flashcardHard = document.getElementById('flashcard-hard');

            if (flashcardFlip) flashcardFlip.addEventListener('click', flipFlashcard);
            if (flashcardNext) flashcardNext.addEventListener('click', nextFlashcard);
            if (flashcardEasy) flashcardEasy.addEventListener('click', () => rateFlashcard('easy'));
            if (flashcardMedium) flashcardMedium.addEventListener('click', () => rateFlashcard('medium'));
            if (flashcardHard) flashcardHard.addEventListener('click', () => rateFlashcard('hard'));
        }

        function changeVocabularyMode(mode) {
            currentVocabMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.vocab-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Hide all mode contents
            document.querySelectorAll('.vocab-mode-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected mode content
            const selectedModeContent = document.getElementById(`${mode}-mode`);
            if (selectedModeContent) {
                selectedModeContent.classList.remove('hidden');
            }

            // Initialize mode-specific content
            if (mode === 'review') {
                displayNextVocabularyWord();
            } else if (mode === 'quiz') {
                generateQuizQuestion();
            } else if (mode === 'flashcard') {
                initializeFlashcard();
            }
        }

        function changeVocabularyCategory(category) {
            currentCategory = category;
            
            // Update category buttons
            document.querySelectorAll('.vocab-category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });

            updateVocabularyStats();
            
            // Refresh current mode
            if (currentVocabMode === 'review') {
                displayNextVocabularyWord();
            } else if (currentVocabMode === 'quiz') {
                generateQuizQuestion();
            } else if (currentVocabMode === 'flashcard') {
                initializeFlashcard();
            }
        }

        function generateQuizQuestion() {
            const currentVocab = getCurrentVocabulary();
            if (currentVocab.length < 4) return; // Need at least 4 words for quiz

            const questionWord = currentVocab[Math.floor(Math.random() * currentVocab.length)];
            const correctAnswer = questionWord.meaning;
            
            // Generate wrong answers
            const wrongAnswers = [];
            while (wrongAnswers.length < 3) {
                const randomWord = currentVocab[Math.floor(Math.random() * currentVocab.length)];
                if (randomWord.meaning !== correctAnswer && !wrongAnswers.includes(randomWord.meaning)) {
                    wrongAnswers.push(randomWord.meaning);
                }
            }

            // Shuffle all options
            const allOptions = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);

            // Update UI
            const questionElement = document.getElementById('quiz-question');
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackElement = document.getElementById('quiz-feedback');
            const nextButton = document.getElementById('next-quiz-button');

            if (questionElement) questionElement.textContent = questionWord.word;
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                allOptions.forEach(option => {
                    const optionButton = document.createElement('button');
                    optionButton.className = 'vocab-quiz-option';
                    optionButton.textContent = option;
                    optionButton.addEventListener('click', () => checkQuizAnswer(option, correctAnswer, optionButton));
                    optionsContainer.appendChild(optionButton);
                });
            }
            
            if (feedbackElement) feedbackElement.classList.add('hidden');
            if (nextButton) nextButton.classList.add('hidden');
            
            totalQuestions++;
            updateVocabularyStats();
        }

        function checkQuizAnswer(selectedAnswer, correctAnswer, buttonElement) {
            const isCorrect = selectedAnswer === correctAnswer;
            const feedbackElement = document.getElementById('quiz-feedback');
            const nextButton = document.getElementById('next-quiz-button');
            const optionsContainer = document.getElementById('quiz-options');

            // Disable all options
            optionsContainer.querySelectorAll('.vocab-quiz-option').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn === buttonElement && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                correctAnswers++;
                if (feedbackElement) {
                    feedbackElement.textContent = '🎉 Chính xác!';
                    feedbackElement.className = 'vocab-feedback correct';
                    feedbackElement.classList.remove('hidden');
                }
                buttonElement.parentElement.classList.add('pulse');
            } else {
                if (feedbackElement) {
                    feedbackElement.textContent = `❌ Sai rồi! Đáp án đúng là: ${correctAnswer}`;
                    feedbackElement.className = 'vocab-feedback incorrect';
                    feedbackElement.classList.remove('hidden');
                }
                buttonElement.parentElement.classList.add('shake');
            }

            if (nextButton) nextButton.classList.remove('hidden');
            updateVocabularyStats();
        }

        function initializeFlashcard() {
            const currentVocab = getCurrentVocabulary();
            if (currentVocab.length === 0) return;

            const randomWord = currentVocab[Math.floor(Math.random() * currentVocab.length)];
            const wordElement = document.getElementById('flashcard-word');
            const meaningElement = document.getElementById('flashcard-meaning');
            const frontElement = document.getElementById('flashcard-front');
            const backElement = document.getElementById('flashcard-back');

            if (wordElement) wordElement.textContent = randomWord.word;
            if (meaningElement) meaningElement.textContent = randomWord.meaning;
            if (frontElement) frontElement.classList.remove('hidden');
            if (backElement) backElement.classList.add('hidden');
        }

        function flipFlashcard() {
            const frontElement = document.getElementById('flashcard-front');
            const backElement = document.getElementById('flashcard-back');
            
            if (frontElement && backElement) {
                frontElement.classList.toggle('hidden');
                backElement.classList.toggle('hidden');
            }
        }

        function nextFlashcard() {
            initializeFlashcard();
            reviewedWords.add(document.getElementById('flashcard-word')?.textContent || '');
            updateVocabularyStats();
        }

        function rateFlashcard(rating) {
            // In a real app, you might save this rating for spaced repetition
            console.log(`Rated current flashcard as: ${rating}`);
            nextFlashcard();
        }

        function updateVocabularyStats() {
            const scoreElement = document.getElementById('vocab-score');
            const progressElement = document.getElementById('vocab-progress');
            const difficultyElement = document.getElementById('vocab-difficulty');
            const progressFillElement = document.getElementById('vocab-progress-fill');
            
            const currentVocab = getCurrentVocabulary();
            const totalWords = currentVocab.length;
            const reviewedCount = [...reviewedWords].filter(word => 
                currentVocab.some(vocab => vocab.word === word)
            ).length;

            if (scoreElement) scoreElement.textContent = `${correctAnswers}/${totalQuestions}`;
            if (progressElement) progressElement.textContent = reviewedCount;
            if (difficultyElement) difficultyElement.textContent = `Cấp ${difficulty}`;
            if (progressFillElement) {
                const progressPercent = totalWords > 0 ? (reviewedCount / totalWords) * 100 : 0;
                progressFillElement.style.width = `${Math.min(progressPercent, 100)}%`;
            }
        }

        function setActiveExercise(exerciseId) {
            activeExerciseId = exerciseId;
            const exercise = exercises.find(ex => ex.id === exerciseId);
            if (!exercise) return;

            const navButtons = navigationMenu.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.exerciseId === exerciseId);
            });
            
            selectedConsonant = null;
            selectedVowel = null;
            
            renderExerciseUI(exercise);
        }

        exercises.forEach(ex => {
            const button = document.createElement('button');
            button.textContent = ex.title;
            button.classList.add('nav-btn', 'p-3', 'rounded-md', 'text-left', 'w-full', 'bg-white', 'text-blue-700', 'shadow-sm');
            button.dataset.exerciseId = ex.id;
            button.addEventListener('click', () => setActiveExercise(ex.id));
            navigationMenu.appendChild(button);
        });        setActiveExercise('ex_single_syllable'); 

    </script>
</body>
</html>
