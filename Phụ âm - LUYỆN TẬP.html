<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyá»‡n Táº­p Phá»¥ Ã‚m Tiáº¿ng HÃ n (Cáº¥u TrÃºc Má»›i - Cáº­p Nháº­t BÃ i 1 Láº§n 3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Visualization & Content Choices:
    - Navigation: List of buttons for "BÃ i 1" through "BÃ i 5".
    - Exercise 1 (Comprehensive Single Syllable - Visual Groups):
        - Goal: Practice single syllables with direct consonant/vowel selection from visually grouped sections.
        - Viz/Presentation: Visually distinct sections for Plain Consonants, Aspirated Consonants, Tense Consonants, Basic Vowels, and Double Vowels, each containing their respective character buttons. Display for main/comparison syllables (comparison always shown if applicable). "Random Single Syllable" button (from all characters).
    - Exercises 2-4 (Sequence Reading): (Same as before)
    - Exercise 5 (Vocabulary Practice): (Same as before)
    - All text in Vietnamese.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4;
            color: #44403c;
        }
        .syllable-display-container, .sequence-display-container, .vocab-display-container {
            border: 2px solid #bfdbfe;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .syllable-char-display {
            font-size: 3rem; 
            line-height: 1.2;
            min-height: 60px;
        }
        .syllable-sequence-display, .vocab-word-display, .vocab-meaning-display {
            font-size: 2rem; 
            line-height: 1.5;
            min-height: 60px; 
            padding: 1rem;
            text-align: center;
        }
        .vocab-meaning-display {
            color: #3b82f6; 
        }
         .syllable-label, .group-label {
            font-size: 0.875rem; 
            color: #57534e;
            margin-bottom: 0.25rem;
            display: block;
        }
        .group-label {
            font-weight: 600; /* semibold */
            color: #1d4ed8; /* blue-700 */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #dbeafe; /* blue-200 */
        }
        .btn-char, .nav-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #93c5fd;
        }
        .btn-char:hover, .nav-btn:hover {
            background-color: #60a5fa;
            color: #eff6ff;
        }
        .btn-char.selected, .nav-btn.active {
            background-color: #3b82f6;
            color: white;
            font-weight: bold;
            border-color: #2563eb;
        }
        .btn-action {
            background-color: #60a5fa;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .btn-action:hover {
            background-color: #3b82f6;
        }
        .exercise-section {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            display: none; 
        }
        .exercise-section.active {
            display: block; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #navigation-menu button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 0.5rem;
            padding: 0.75rem 1rem;
        }
        .character-grid {
            display: grid;
            gap: 0.5rem; /* Tailwind gap-2 */
        }
        /* Adjust grid columns for different character groups */
        #consonants-plain-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); } /* More flexible */
        #consonants-aspirated-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        #consonants-tense-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        #vowels-basic-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }
        #vowels-double-grid { grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); }

        /* Vocabulary Section Enhancements */
        .vocab-mode-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .vocab-mode-btn {
            background-color: #e5e7eb;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .vocab-mode-btn:hover {
            background-color: #d1d5db;
        }
        .vocab-mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .vocab-category-selector {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .vocab-category-btn {
            background-color: #f3f4f6;
            color: #6b7280;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        .vocab-category-btn:hover {
            background-color: #e5e7eb;
        }
        .vocab-category-btn.active {
            background-color: #dbeafe;
            color: #2563eb;
        }
        .vocab-quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .vocab-quiz-option {
            background-color: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .vocab-quiz-option:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .vocab-quiz-option.correct {
            background-color: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        .vocab-quiz-option.incorrect {
            background-color: #fef2f2;
            border-color: #dc2626;
            color: #dc2626;
        }
        .vocab-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .vocab-progress-bar {
            width: 100%;
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .vocab-progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        .vocab-feedback {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            text-align: center;
            font-weight: 500;
        }
        .vocab-feedback.correct {
            background-color: #dcfce7;
            color: #15803d;
        }
        .vocab-feedback.incorrect {
            background-color: #fef2f2;
            color: #dc2626;
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .pulse {
            animation: pulse 0.6s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400,700&display=swap" rel="stylesheet">
    <script src="navigation.js"></script>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-6xl">        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold text-blue-700" style="font-family: 'Noto Sans KR', sans-serif;">Luyá»‡n Táº­p Phá»¥ Ã‚m Tiáº¿ng HÃ n (Cáº¥u TrÃºc Má»›i)</h1>
        </div>

        <div class="flex flex-col md:flex-row gap-8">
            <aside class="w-full md:w-1/4">
                <h2 class="text-xl font-semibold text-blue-600 mb-4">Má»¥c Lá»¥c BÃ i Táº­p</h2>
                <nav id="navigation-menu">
                    </nav>
            </aside>

            <main class="w-full md:w-3/4">
                <div id="exercise-content-area">
                    </div>
            </main>
        </div>

        <footer class="text-center mt-12 py-6 border-t border-stone-300">
            <p class="text-sm text-stone-500">á»¨ng dá»¥ng luyá»‡n táº­p tá»•ng há»£p phá»¥ Ã¢m tiáº¿ng HÃ n. PhÃ¡t triá»ƒn bá»Ÿi AI.</p>
        </footer>
    </div>

    <script>
        const exercises = [
            { id: 'ex_single_syllable', title: 'BÃ i 1: Luyá»‡n PhÃ¡t Ã‚m ÄÆ¡n Ã‚m Tiáº¿t (Tá»•ng Há»£p)', isSingleSyllablePractice: true },
            { id: 'ex_seq_easy', title: 'BÃ i 2: Äá»c Chuá»—i (Dá»…)', isSequenceReading: true, sequenceParams: { countRange: [2, 3], consonantTypes: ['plain'], vowelGroupKey: 'basic_y' } },
            { id: 'ex_seq_medium', title: 'BÃ i 3: Äá»c Chuá»—i (Trung BÃ¬nh)', isSequenceReading: true, sequenceParams: { countRange: [3, 4], consonantTypes: ['plain', 'aspirated'], vowelGroupKey: 'all' } },
            { id: 'ex_seq_hard', title: 'BÃ i 4: Äá»c Chuá»—i (KhÃ³)', isSequenceReading: true, sequenceParams: { countRange: [4, 5], consonantTypes: ['plain', 'aspirated', 'tense'], vowelGroupKey: 'all' } },
            { id: 'ex_vocab', title: 'BÃ i 5: Luyá»‡n Tá»« Vá»±ng', isVocabularyPractice: true }
        ];

        const allConsonantsWithTypes = [ 
            { char: 'ã„±', type: 'plain' }, { char: 'ã„´', type: 'plain' }, { char: 'ã„·', type: 'plain' }, { char: 'ã„¹', type: 'plain' },
            { char: 'ã…', type: 'plain' }, { char: 'ã…‚', type: 'plain' }, { char: 'ã……', type: 'plain' }, { char: 'ã…‡', type: 'plain' },
            { char: 'ã…ˆ', type: 'plain' }, { char: 'ã…', type: 'plain' },
            { char: 'ã…‹', type: 'aspirated' }, { char: 'ã…Œ', type: 'aspirated' }, { char: 'ã…', type: 'aspirated' }, { char: 'ã…Š', type: 'aspirated' },
            { char: 'ã„²', type: 'tense' }, { char: 'ã„¸', type: 'tense' }, { char: 'ã…ƒ', type: 'tense' }, { char: 'ã…†', type: 'tense' }, { char: 'ã…‰', type: 'tense' }
        ];
        
        const consonantGroupsForDisplay = { 
            plain: ['ã„±', 'ã„´', 'ã„·', 'ã„¹', 'ã…', 'ã…‚', 'ã……', 'ã…‡', 'ã…ˆ', 'ã…'],
            aspirated: ['ã…‹', 'ã…Œ', 'ã…', 'ã…Š'],
            tense: ['ã„²', 'ã„¸', 'ã…ƒ', 'ã…†', 'ã…‰']
        };

        const vowelGroupsForDisplay = { 
            basic: ['ã…', 'ã…‘', 'ã…“', 'ã…•', 'ã…—', 'ã…›', 'ã…œ', 'ã… ', 'ã…¡', 'ã…£'], 
            double: ['ã…', 'ã…’', 'ã…”', 'ã…–', 'ã…˜', 'ã…™', 'ã…š', 'ã…', 'ã…', 'ã…Ÿ', 'ã…¢'] 
        };
         const allVowelsForRandom = [...vowelGroupsForDisplay.basic, ...vowelGroupsForDisplay.double];
        
        const vowelGroupsForSequence = { // Used by sequence generation logic
            all: allVowelsForRandom,
            basic_y: vowelGroupsForDisplay.basic 
        };
        
        const aspiratedToPlainMap = {'ã…‹': 'ã„±', 'ã…Œ': 'ã„·', 'ã…': 'ã…‚', 'ã…Š': 'ã…ˆ'};
        const tenseToPlainMap = {'ã„²': 'ã„±', 'ã„¸': 'ã„·', 'ã…ƒ': 'ã…‚', 'ã…†': 'ã……', 'ã…‰': 'ã…ˆ'};

        const syllableMaps = { 
            plain: {
                'ã„±': {'ã…':'ê°€', 'ã…':'ê°œ', 'ã…‘':'ê°¸', 'ã…’':'ê±”', 'ã…“':'ê±°', 'ã…”':'ê²Œ', 'ã…•':'ê²¨', 'ã…–':'ê³„', 'ã…—':'ê³ ', 'ã…˜':'ê³¼', 'ã…™':'ê´˜', 'ã…š':'ê´´', 'ã…›':'êµ', 'ã…œ':'êµ¬', 'ã…':'ê¶ˆ', 'ã…':'ê¶¤', 'ã…Ÿ':'ê·€', 'ã… ':'ê·œ', 'ã…¡':'ê·¸', 'ã…¢':'ê¸”', 'ã…£':'ê¸°'},
                'ã„´': {'ã…':'ë‚˜', 'ã…':'ë‚´', 'ã…‘':'ëƒ', 'ã…’':'ëƒ¬', 'ã…“':'ë„ˆ', 'ã…”':'ë„¤', 'ã…•':'ë…€', 'ã…–':'ë…œ', 'ã…—':'ë…¸', 'ã…˜':'ë†”', 'ã…™':'ë†°', 'ã…š':'ë‡Œ', 'ã…›':'ë‡¨', 'ã…œ':'ëˆ„', 'ã…':'ëˆ ', 'ã…':'ëˆ¼', 'ã…Ÿ':'ë‰˜', 'ã… ':'ë‰´', 'ã…¡':'ëŠ', 'ã…¢':'ëŠ¬', 'ã…£':'ë‹ˆ'},
                'ã„·': {'ã…':'ë‹¤', 'ã…':'ëŒ€', 'ã…‘':'ëŒœ', 'ã…’':'ëŒ¸', 'ã…“':'ë”', 'ã…”':'ë°', 'ã…•':'ëŒ', 'ã…–':'ë¨', 'ã…—':'ë„', 'ã…˜':'ë ', 'ã…™':'ë¼', 'ã…š':'ë˜', 'ã…›':'ë´', 'ã…œ':'ë‘', 'ã…':'ë‘¬', 'ã…':'ë’ˆ', 'ã…Ÿ':'ë’¤', 'ã… ':'ë“€', 'ã…¡':'ë“œ', 'ã…¢':'ë“¸', 'ã…£':'ë””'},
                'ã„¹': {'ã…':'ë¼', 'ã…':'ë˜', 'ã…‘':'ë´', 'ã…’':'ëŸ', 'ã…“':'ëŸ¬', 'ã…”':'ë ˆ', 'ã…•':'ë ¤', 'ã…–':'ë¡€', 'ã…—':'ë¡œ', 'ã…˜':'ë¡¸', 'ã…™':'ë¢”', 'ã…š':'ë¢°', 'ã…›':'ë£Œ', 'ã…œ':'ë£¨', 'ã…':'ë¤„', 'ã…':'ë¤ ', 'ã…Ÿ':'ë¤¼', 'ã… ':'ë¥˜', 'ã…¡':'ë¥´', 'ã…¢':'ë¦', 'ã…£':'ë¦¬'},
                'ã…': {'ã…':'ë§ˆ', 'ã…':'ë§¤', 'ã…‘':'ë¨€', 'ã…’':'ë¨œ', 'ã…“':'ë¨¸', 'ã…”':'ë©”', 'ã…•':'ë©°', 'ã…–':'ëªŒ', 'ã…—':'ëª¨', 'ã…˜':'ë«„', 'ã…™':'ë« ', 'ã…š':'ë«¼', 'ã…›':'ë¬˜', 'ã…œ':'ë¬´', 'ã…':'ë­', 'ã…':'ë­¬', 'ã…Ÿ':'ë®ˆ', 'ã… ':'ë®¤', 'ã…¡':'ë¯€', 'ã…¢':'ë¯œ', 'ã…£':'ë¯¸'},
                'ã…‚': {'ã…':'ë°”', 'ã…':'ë°°', 'ã…‘':'ë±Œ', 'ã…’':'ë±¨', 'ã…“':'ë²„', 'ã…”':'ë² ', 'ã…•':'ë²¼', 'ã…–':'ë³˜', 'ã…—':'ë³´', 'ã…˜':'ë´', 'ã…™':'ë´¬', 'ã…š':'ëµˆ', 'ã…›':'ëµ¤', 'ã…œ':'ë¶€', 'ã…':'ë¶œ', 'ã…':'ë¶¸', 'ã…Ÿ':'ë·”', 'ã… ':'ë·°', 'ã…¡':'ë¸Œ', 'ã…¢':'ë¸¨', 'ã…£':'ë¹„'},
                'ã……': {'ã…':'ì‚¬', 'ã…':'ìƒˆ', 'ã…‘':'ìƒ¤', 'ã…’':'ì„€', 'ã…“':'ì„œ', 'ã…”':'ì„¸', 'ã…•':'ì…”', 'ã…–':'ì…°', 'ã…—':'ì†Œ', 'ã…˜':'ì†¨', 'ã…™':'ì‡„', 'ã…š':'ì‡ ', 'ã…›':'ì‡¼', 'ã…œ':'ìˆ˜', 'ã…':'ìˆ´', 'ã…':'ì‰', 'ã…Ÿ':'ì‰¬', 'ã… ':'ìŠˆ', 'ã…¡':'ìŠ¤', 'ã…¢':'ì‹€', 'ã…£':'ì‹œ'},
                'ã…‡': {'ã…':'ì•„', 'ã…':'ì• ', 'ã…‘':'ì•¼', 'ã…’':'ì–˜', 'ã…“':'ì–´', 'ã…”':'ì—', 'ã…•':'ì—¬', 'ã…–':'ì˜ˆ', 'ã…—':'ì˜¤', 'ã…˜':'ì™€', 'ã…™':'ì™œ', 'ã…š':'ì™¸', 'ã…›':'ìš”', 'ã…œ':'ìš°', 'ã…':'ì›Œ', 'ã…':'ì›¨', 'ã…Ÿ':'ìœ„', 'ã… ':'ìœ ', 'ã…¡':'ìœ¼', 'ã…¢':'ì˜', 'ã…£':'ì´'},
                'ã…ˆ': {'ã…':'ì', 'ã…':'ì¬', 'ã…‘':'ìŸˆ', 'ã…’':'ìŸ¤', 'ã…“':'ì €', 'ã…”':'ì œ', 'ã…•':'ì ¸', 'ã…–':'ì¡”', 'ã…—':'ì¡°', 'ã…˜':'ì¢Œ', 'ã…™':'ì¢¨', 'ã…š':'ì£„', 'ã…›':'ì£ ', 'ã…œ':'ì£¼', 'ã…':'ì¤˜', 'ã…':'ì¤´', 'ã…Ÿ':'ì¥', 'ã… ':'ì¥¬', 'ã…¡':'ì¦ˆ', 'ã…¢':'ì¦¤', 'ã…£':'ì§€'},
                'ã…': {'ã…':'í•˜', 'ã…':'í•´', 'ã…‘':'í–', 'ã…’':'í–¬', 'ã…“':'í—ˆ', 'ã…”':'í—¤', 'ã…•':'í˜€', 'ã…–':'í˜œ', 'ã…—':'í˜¸', 'ã…˜':'í™”', 'ã…™':'í™°', 'ã…š':'íšŒ', 'ã…›':'íš¨', 'ã…œ':'í›„', 'ã…':'í› ', 'ã…':'í›¼', 'ã…Ÿ':'íœ˜', 'ã… ':'íœ´', 'ã…¡':'í', 'ã…¢':'í¬', 'ã…£':'íˆ'}
            },
            aspirated: {
                'ã…‹': {'ã…':'ì¹´', 'ã…':'ìº', 'ã…‘':'ìº¬', 'ã…’':'ì»ˆ', 'ã…“':'ì»¤', 'ã…”':'ì¼€', 'ã…•':'ì¼œ', 'ã…–':'ì¼¸', 'ã…—':'ì½”', 'ã…˜':'ì½°', 'ã…™':'ì¾Œ', 'ã…š':'ì¾¨', 'ã…›':'ì¿„', 'ã…œ':'ì¿ ', 'ã…':'ì¿¼', 'ã…':'í€˜', 'ã…Ÿ':'í€´', 'ã… ':'í', 'ã…¡':'í¬', 'ã…¢':'í‚ˆ', 'ã…£':'í‚¤'},
                'ã…Œ': {'ã…':'íƒ€', 'ã…':'íƒœ', 'ã…‘':'íƒ¸', 'ã…’':'í„”', 'ã…“':'í„°', 'ã…”':'í…Œ', 'ã…•':'í…¨', 'ã…–':'í†„', 'ã…—':'í† ', 'ã…˜':'í†¼', 'ã…™':'í‡˜', 'ã…š':'í‡´', 'ã…›':'íˆ', 'ã…œ':'íˆ¬', 'ã…':'í‰ˆ', 'ã…':'í‰¤', 'ã…Ÿ':'íŠ€', 'ã… ':'íŠœ', 'ã…¡':'íŠ¸', 'ã…¢':'í‹”', 'ã…£':'í‹°'},
                'ã…': {'ã…':'íŒŒ', 'ã…':'íŒ¨', 'ã…‘':'í„', 'ã…’':'í ', 'ã…“':'í¼', 'ã…”':'í˜', 'ã…•':'í´', 'ã…–':'í', 'ã…—':'í¬', 'ã…˜':'íˆ', 'ã…™':'í¤', 'ã…š':'í‘€', 'ã…›':'í‘œ', 'ã…œ':'í‘¸', 'ã…':'í’”', 'ã…':'í’°', 'ã…Ÿ':'í“Œ', 'ã… ':'í“¨', 'ã…¡':'í”„', 'ã…¢':'í” ', 'ã…£':'í”¼'},
                'ã…Š': {'ã…':'ì°¨', 'ã…':'ì±„', 'ã…‘':'ì± ', 'ã…’':'ì±¼', 'ã…“':'ì²˜', 'ã…”':'ì²´', 'ã…•':'ì³', 'ã…–':'ì³¬', 'ã…—':'ì´ˆ', 'ã…˜':'ì´¤', 'ã…™':'ìµ€', 'ã…š':'ìµœ', 'ã…›':'ìµ¸', 'ã…œ':'ì¶”', 'ã…':'ì¶°', 'ã…':'ì·Œ', 'ã…Ÿ':'ì·¨', 'ã… ':'ì¸„', 'ã…¡':'ì¸ ', 'ã…¢':'ì¸¼', 'ã…£':'ì¹˜'}
            },
            tense: {
                'ã„²': {'ã…':'ê¹Œ', 'ã…':'ê¹¨', 'ã…‘':'êº„', 'ã…’':'êº ', 'ã…“':'êº¼', 'ã…”':'ê»˜', 'ã…•':'ê»´', 'ã…–':'ê¼', 'ã…—':'ê¼¬', 'ã…˜':'ê½ˆ', 'ã…™':'ê½¤', 'ã…š':'ê¾€', 'ã…›':'ê¾œ', 'ã…œ':'ê¾¸', 'ã…':'ê¿”', 'ã…':'ê¿°', 'ã…Ÿ':'ë€Œ', 'ã… ':'ë€¨', 'ã…¡':'ë„', 'ã…¢':'ë ', 'ã…£':'ë¼'},
                'ã„¸': {'ã…':'ë”°', 'ã…':'ë•Œ', 'ã…‘':'ë•¨', 'ã…’':'ë–„', 'ã…“':'ë– ', 'ã…”':'ë–¼', 'ã…•':'ë—˜', 'ã…–':'ë—´', 'ã…—':'ë˜', 'ã…˜':'ë˜¬', 'ã…™':'ë™ˆ', 'ã…š':'ë™¤', 'ã…›':'ëš€', 'ã…œ':'ëšœ', 'ã…':'ëš¸', 'ã…':'ë›”', 'ã…Ÿ':'ë›°', 'ã… ':'ëœŒ', 'ã…¡':'ëœ¨', 'ã…¢':'ë„', 'ã…£':'ë '},
                'ã…ƒ': {'ã…':'ë¹ ', 'ã…':'ë¹¼', 'ã…‘':'ëº˜', 'ã…’':'ëº´', 'ã…“':'ë»', 'ã…”':'ë»¬', 'ã…•':'ë¼ˆ', 'ã…–':'ë¼¤', 'ã…—':'ë½€', 'ã…˜':'ë½œ', 'ã…™':'ë½¸', 'ã…š':'ë¾”', 'ã…›':'ë¾°', 'ã…œ':'ë¿Œ', 'ã…':'ë¿¨', 'ã…':'ì€„', 'ã…Ÿ':'ì€ ', 'ã… ':'ì€¼', 'ã…¡':'ì˜', 'ã…¢':'ì´', 'ã…£':'ì‚'},
                'ã…†': {'ã…':'ì‹¸', 'ã…':'ìŒ”', 'ã…‘':'ìŒ°', 'ã…’':'ìŒ', 'ã…“':'ì¨', 'ã…”':'ì„', 'ã…•':'ì ', 'ã…–':'ì¼', 'ã…—':'ì˜', 'ã…˜':'ì´', 'ã…™':'ì', 'ã…š':'ì‡ ', 'ã…›':'ì‘ˆ', 'ã…œ':'ì‘¤', 'ã…':'ì’€', 'ã…':'ì’œ', 'ã…Ÿ':'ì’¸', 'ã… ':'ì“”', 'ã…¡':'ì“°', 'ã…¢':'ì”Œ', 'ã…£':'ì”¨'},
                'ã…‰': {'ã…':'ì§œ', 'ã…':'ì§¸', 'ã…‘':'ì¨”', 'ã…’':'ì¨°', 'ã…“':'ì©Œ', 'ã…”':'ì©¨', 'ã…•':'ìª„', 'ã…–':'ìª ', 'ã…—':'ìª¼', 'ã…˜':'ì«˜', 'ã…™':'ì«´', 'ã…š':'ì¬', 'ã…›':'ì¬¬', 'ã…œ':'ì­ˆ', 'ã…':'ì­¤', 'ã…':'ì®€', 'ã…Ÿ':'ì®œ', 'ã… ':'ì®¸', 'ã…¡':'ì¯”', 'ã…¢':'ì¯°', 'ã…£':'ì°Œ'}
            }
        };        const vocabularyByCategory = {
            family: [
                { word: 'ê°€ì¡±', meaning: 'Gia Ä‘Ã¬nh', level: 1 },
                { word: 'ì•„ë²„ì§€', meaning: 'Bá»‘', level: 1 },
                { word: 'ì–´ë¨¸ë‹ˆ', meaning: 'Máº¹', level: 1 },
                { word: 'ì•„ë“¤', meaning: 'Con trai', level: 1 },
                { word: 'ë”¸', meaning: 'Con gÃ¡i', level: 1 },
                { word: 'í˜•', meaning: 'Anh trai (nam gá»i)', level: 2 },
                { word: 'ëˆ„ë‚˜', meaning: 'Chá»‹ gÃ¡i (nam gá»i)', level: 2 },
                { word: 'ì–¸ë‹ˆ', meaning: 'Chá»‹ gÃ¡i (ná»¯ gá»i)', level: 2 },
                { word: 'ë™ìƒ', meaning: 'Em', level: 1 }
            ],
            body: [
                { word: 'ë¨¸ë¦¬', meaning: 'Äáº§u', level: 1 },
                { word: 'ëˆˆ', meaning: 'Máº¯t', level: 1 },
                { word: 'ì½”', meaning: 'MÅ©i', level: 1 },
                { word: 'ì…', meaning: 'Miá»‡ng', level: 1 },
                { word: 'ê·€', meaning: 'Tai', level: 1 },
                { word: 'ì†', meaning: 'Tay', level: 1 },
                { word: 'ë°œ', meaning: 'ChÃ¢n', level: 1 },
                { word: 'ë‹¤ë¦¬', meaning: 'ChÃ¢n (tá»« hÃ´ng xuá»‘ng)', level: 2 }
            ],
            animals: [
                { word: 'ê³ ì–‘ì´', meaning: 'MÃ¨o', level: 1 },
                { word: 'ê°•ì•„ì§€', meaning: 'ChÃ³ con', level: 1 },
                { word: 'ì‚¬ì', meaning: 'SÆ° tá»­', level: 2 },
                { word: 'í† ë¼', meaning: 'Con thá»', level: 1 },
                { word: 'ìƒˆ', meaning: 'Chim', level: 1 },
                { word: 'ë¬¼ê³ ê¸°', meaning: 'CÃ¡', level: 1 },
                { word: 'ê¹Œì¹˜', meaning: 'Chim Ã¡c lÃ ', level: 3 },
                { word: 'ì½”ë¼ë¦¬', meaning: 'Voi', level: 2 }
            ],
            food: [
                { word: 'ë°¥', meaning: 'CÆ¡m', level: 1 },
                { word: 'ë¹µ', meaning: 'BÃ¡nh mÃ¬', level: 1 },
                { word: 'ë¬¼', meaning: 'NÆ°á»›c', level: 1 },
                { word: 'ìš°ìœ ', meaning: 'Sá»¯a', level: 1 },
                { word: 'ì‚¬ê³¼', meaning: 'TÃ¡o', level: 1 },
                { word: 'ë°”ë‚˜ë‚˜', meaning: 'Chuá»‘i', level: 1 },
                { word: 'ê¹€ì¹˜', meaning: 'Kim chi', level: 2 },
                { word: 'ë¼ë©´', meaning: 'MÃ¬ tÃ´m', level: 2 }
            ],
            basic: [
                { word: 'ì•ˆë…•í•˜ì„¸ìš”', meaning: 'Xin chÃ o', level: 1 },
                { word: 'ê°ì‚¬í•©ë‹ˆë‹¤', meaning: 'Cáº£m Æ¡n', level: 1 },
                { word: 'ì£„ì†¡í•©ë‹ˆë‹¤', meaning: 'Xin lá»—i', level: 1 },
                { word: 'ë„¤', meaning: 'VÃ¢ng/CÃ³', level: 1 },
                { word: 'ì•„ë‹ˆìš”', meaning: 'KhÃ´ng', level: 1 },
                { word: 'ì¢‹ì•„ìš”', meaning: 'Tá»‘t', level: 1 },
                { word: 'ë‚˜ì˜ë‹¤', meaning: 'Xáº¥u/Tá»‡', level: 2 },
                { word: 'í¬ë‹¤', meaning: 'To/Lá»›n', level: 2 }
            ]
        };

        // Flatten all vocabulary for random selection
        const allVocabulary = Object.values(vocabularyByCategory).flat();        let activeExerciseId = 'ex_single_syllable';
        let selectedConsonant = null; 
        let selectedVowel = null;
        let selectedConsonantActualType = 'plain'; 
        let currentVocabIndex = -1;
        
        // Vocabulary Practice Variables
        let currentVocabMode = 'review'; // 'review', 'quiz', 'flashcard'
        let currentCategory = 'all';
        let currentQuizOptions = [];
        let correctAnswers = 0;
        let totalQuestions = 0;
        let reviewedWords = new Set();
        let difficulty = 1; // 1, 2, 3

        const navigationMenu = document.getElementById('navigation-menu');
        const exerciseContentArea = document.getElementById('exercise-content-area');

        // --- Element variables (will be reassigned in render functions) ---
        let mainSyllableCharDisplay, plainComparisonSyllableCharDisplay, syllablePlaceholder, 
            consonantsPlainGrid, consonantsAspiratedGrid, consonantsTenseGrid,
            vowelsBasicGrid, vowelsDoubleGrid,
            randomSingleSyllableButtonInteractive, interactiveSyllableGrid;

        let syllableSequenceDisplay, generateSequenceButton;
        
        let vocabWordDisplay, vocabMeaningDisplay, nextVocabButton, showMeaningButton;
        
        function renderExerciseUI(exercise) {
            exerciseContentArea.innerHTML = ''; 
            selectedConsonant = null; 
            selectedVowel = null;

            if (exercise.isSingleSyllablePractice) {
                renderSingleSyllablePracticeUI(exercise);
            } else if (exercise.isSequenceReading) {
                renderSequenceReadingUI(exercise);
            } else if (exercise.isVocabularyPractice) {
                renderVocabularyPracticeUI(exercise);
            }
        }

        function renderSingleSyllablePracticeUI(exercise) {
            exerciseContentArea.innerHTML = `
                <section id="single-syllable-practice-section" class="exercise-section active">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-3" style="font-family: 'Noto Sans KR', sans-serif;">${exercise.title}</h2>
                    <p id="interactive-instructions" class="text-stone-600 mb-6">Chá»n má»™t phá»¥ Ã¢m vÃ  má»™t nguyÃªn Ã¢m. Ã‚m chÃ­nh vÃ  Ã¢m thÆ°á»ng tÆ°Æ¡ng á»©ng (náº¿u cÃ³) sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ Ä‘á»ƒ so sÃ¡nh.</p>
                    
                    <div class="flex flex-col lg:flex-row gap-8 items-start">
                        <div class="w-full lg:w-1/2">
                            <div>
                                <h3 class="group-label">Phá»¥ Ã‚m ThÆ°á»ng</h3>
                                <div id="consonants-plain-grid" class="character-grid mb-4"></div>
                                <h3 class="group-label">Phá»¥ Ã‚m Báº­t HÆ¡i</h3>
                                <div id="consonants-aspirated-grid" class="character-grid mb-4"></div>
                                <h3 class="group-label">Phá»¥ Ã‚m CÄƒng</h3>
                                <div id="consonants-tense-grid" class="character-grid"></div>
                            </div>
                        </div>
                        <div class="w-full lg:w-1/2">
                            <div>
                                <h3 class="group-label">NguyÃªn Ã‚m ThÆ°á»ng (10)</h3>
                                <div id="vowels-basic-grid" class="character-grid mb-4"></div>
                                <h3 class="group-label">NguyÃªn Ã‚m ÄÃ´i (11)</h3>
                                <div id="vowels-double-grid" class="character-grid"></div>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-lg font-semibold mb-2 text-center text-blue-700">Ã‚m Tiáº¿t Káº¿t Há»£p</h3>
                                <div id="syllable-display-container" class="syllable-display-container">
                                    <div id="interactive-syllable-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center text-center">
                                        <div class="main-syllable-column">
                                            <span class="syllable-label">Ã‚m ChÃ­nh</span>
                                            <div id="main-syllable-char" class="syllable-char-display text-blue-700 font-bold" style="font-family: 'Noto Sans KR', sans-serif;">--</div>
                                        </div>
                                        <div class="plain-comparison-column">
                                            <span class="syllable-label">Ã‚m ThÆ°á»ng T.á»¨ng (Náº¿u cÃ³)</span>
                                            <div id="plain-comparison-syllable-char" class="syllable-char-display text-blue-600" style="font-family: 'Noto Sans KR', sans-serif;">--</div>
                                        </div>
                                    </div>
                                    <p id="syllable-placeholder" class="text-center text-stone-500 mt-2">Chá»n phá»¥ Ã¢m & nguyÃªn Ã¢m</p>
                                </div>
                                <div class="text-center mt-6">
                                    <button id="random-single-syllable-button-interactive" class="btn-action py-2 px-4">Ã‚m Tiáº¿t Ngáº«u NhiÃªn (Tá»« Táº¥t Cáº£)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            assignInteractiveSingleElements(); 
            randomSingleSyllableButtonInteractive.addEventListener('click', generateRandomSingleSyllableInteractive);

            populateAllConsonantsForSingleSyllablePractice();
            populateAllVowelsForSingleSyllablePractice(); 
            updateSyllableDisplay(); 
        }
        
        function renderSequenceReadingUI(exercise) {
             exerciseContentArea.innerHTML = `
                <section id="sequence-reading-section" class="exercise-section active">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-3" style="font-family: 'Noto Sans KR', sans-serif;">${exercise.title}</h2>
                    <p class="text-stone-600 mb-6">Nháº¥n nÃºt "Táº¡o Chuá»—i Má»›i" Ä‘á»ƒ luyá»‡n Ä‘á»c má»™t chuá»—i cÃ¡c Ã¢m tiáº¿t.</p>
                    <div class="text-center mb-6">
                        <button id="generate-sequence-button" class="btn-action py-3 px-6 rounded-lg font-semibold text-lg shadow-md">
                            Táº¡o Chuá»—i Má»›i
                        </button>
                    </div>
                    <div id="syllable-sequence-display-container" class="sequence-display-container">
                        <div id="syllable-sequence-display" class="syllable-sequence-display text-blue-700 font-bold" style="font-family: 'Noto Sans KR', sans-serif;">HÃ£y nháº¥n nÃºt Ä‘á»ƒ báº¯t Ä‘áº§u!</div>
                    </div>
                </section>
            `;
            assignSequenceReadingElements();
            generateSequenceButton.addEventListener('click', () => generateSyllableSequence(exercise.sequenceParams));
            generateSyllableSequence(exercise.sequenceParams); 
        }        function renderVocabularyPracticeUI(exercise) {
            exerciseContentArea.innerHTML = `
                <section id="vocabulary-practice-section" class="exercise-section active">
                    <h2 class="text-2xl font-semibold text-blue-600 mb-3" style="font-family: 'Noto Sans KR', sans-serif;">${exercise.title}</h2>
                    <p class="text-stone-600 mb-6">Luyá»‡n Ä‘á»c tá»« vÃ  há»c nghÄ©a cá»§a chÃºng vá»›i nhiá»u cháº¿ Ä‘á»™ khÃ¡c nhau.</p>
                    
                    <!-- Mode Selection -->
                    <div class="vocab-mode-selector">
                        <button class="vocab-mode-btn active" data-mode="review">ğŸ“– Ã”n Táº­p</button>
                        <button class="vocab-mode-btn" data-mode="quiz">ğŸ§  Tráº¯c Nghiá»‡m</button>
                        <button class="vocab-mode-btn" data-mode="flashcard">ğŸƒ Tháº» Ghi Nhá»›</button>
                    </div>

                    <!-- Category Selection -->
                    <div class="vocab-category-selector">
                        <button class="vocab-category-btn active" data-category="all">Táº¥t Cáº£</button>
                        <button class="vocab-category-btn" data-category="basic">CÆ¡ Báº£n</button>
                        <button class="vocab-category-btn" data-category="family">Gia ÄÃ¬nh</button>
                        <button class="vocab-category-btn" data-category="body">CÆ¡ Thá»ƒ</button>
                        <button class="vocab-category-btn" data-category="animals">Äá»™ng Váº­t</button>
                        <button class="vocab-category-btn" data-category="food">Thá»©c Ä‚n</button>
                    </div>

                    <!-- Stats and Progress -->
                    <div id="vocab-stats" class="vocab-stats">
                        <span>Äiá»ƒm: <strong id="vocab-score">0/0</strong></span>
                        <span>ÄÃ£ Há»c: <strong id="vocab-progress">0</strong> tá»«</span>
                        <span>Äá»™ KhÃ³: <strong id="vocab-difficulty">Cáº¥p 1</strong></span>
                    </div>
                    <div class="vocab-progress-bar">
                        <div id="vocab-progress-fill" class="vocab-progress-fill" style="width: 0%"></div>
                    </div>

                    <!-- Main Display Area -->
                    <div id="vocab-display-container" class="vocab-display-container text-center">
                        <!-- Review Mode -->
                        <div id="review-mode" class="vocab-mode-content">
                            <div id="vocab-word-display" class="vocab-word-display text-blue-700 font-bold mb-4" style="font-family: 'Noto Sans KR', sans-serif;">Nháº¥n "Tá»« Má»›i"</div>
                            <div id="vocab-meaning-display" class="vocab-meaning-display mb-6 hidden" style="font-family: 'Inter', sans-serif;">--</div>
                            <div class="flex justify-center gap-4">
                                <button id="next-vocab-button" class="btn-action py-2 px-4">ğŸ“š Tá»« Má»›i</button>
                                <button id="show-meaning-button" class="btn-action py-2 px-4 bg-sky-500 hover:bg-sky-600">ğŸ‘ï¸ Xem NghÄ©a</button>
                            </div>
                        </div>

                        <!-- Quiz Mode -->
                        <div id="quiz-mode" class="vocab-mode-content hidden">
                            <div id="quiz-question" class="vocab-word-display text-blue-700 font-bold mb-4" style="font-family: 'Noto Sans KR', sans-serif;">ì•ˆë…•í•˜ì„¸ìš”</div>
                            <p class="text-sm text-gray-600 mb-4">Chá»n nghÄ©a Ä‘Ãºng cá»§a tá»« trÃªn:</p>
                            <div id="quiz-options" class="vocab-quiz-options">
                                <!-- Quiz options will be inserted here -->
                            </div>
                            <div id="quiz-feedback" class="vocab-feedback hidden"></div>
                            <button id="next-quiz-button" class="btn-action py-2 px-4 mt-4 hidden">â¡ï¸ CÃ¢u Tiáº¿p Theo</button>
                        </div>

                        <!-- Flashcard Mode -->
                        <div id="flashcard-mode" class="vocab-mode-content hidden">
                            <div class="flashcard relative">
                                <div id="flashcard-front" class="flashcard-side">
                                    <div id="flashcard-word" class="vocab-word-display text-blue-700 font-bold mb-4" style="font-family: 'Noto Sans KR', sans-serif;">ì•ˆë…•í•˜ì„¸ìš”</div>
                                    <p class="text-sm text-gray-600">Nháº¥n Ä‘á»ƒ láº­t tháº»</p>
                                </div>
                                <div id="flashcard-back" class="flashcard-side hidden">
                                    <div id="flashcard-meaning" class="vocab-meaning-display text-blue-600" style="font-family: 'Inter', sans-serif;">Xin chÃ o</div>
                                    <p class="text-sm text-gray-600">Nháº¥n Ä‘á»ƒ láº­t láº¡i</p>
                                </div>
                            </div>
                            <div class="flex justify-center gap-4 mt-6">
                                <button id="flashcard-flip" class="btn-action py-2 px-4 bg-purple-500 hover:bg-purple-600">ğŸ”„ Láº­t Tháº»</button>
                                <button id="flashcard-next" class="btn-action py-2 px-4">â¡ï¸ Tháº» Tiáº¿p</button>
                            </div>
                            <div class="flex justify-center gap-2 mt-4">
                                <button id="flashcard-easy" class="btn-action py-1 px-3 text-sm bg-green-500 hover:bg-green-600">ğŸ˜Š Dá»…</button>
                                <button id="flashcard-medium" class="btn-action py-1 px-3 text-sm bg-yellow-500 hover:bg-yellow-600">ğŸ˜ BÃ¬nh ThÆ°á»ng</button>
                                <button id="flashcard-hard" class="btn-action py-1 px-3 text-sm bg-red-500 hover:bg-red-600">ğŸ˜“ KhÃ³</button>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            assignVocabularyElements();
            setupVocabularyEventListeners();
            updateVocabularyStats();
            changeVocabularyMode('review');
        }

        function assignInteractiveSingleElements() { 
            mainSyllableCharDisplay = document.getElementById('main-syllable-char');
            plainComparisonSyllableCharDisplay = document.getElementById('plain-comparison-syllable-char');
            syllablePlaceholder = document.getElementById('syllable-placeholder');
            interactiveSyllableGrid = document.getElementById('interactive-syllable-grid'); 
            
            consonantsPlainGrid = document.getElementById('consonants-plain-grid');
            consonantsAspiratedGrid = document.getElementById('consonants-aspirated-grid');
            consonantsTenseGrid = document.getElementById('consonants-tense-grid');
            vowelsBasicGrid = document.getElementById('vowels-basic-grid');
            vowelsDoubleGrid = document.getElementById('vowels-double-grid');
            
            randomSingleSyllableButtonInteractive = document.getElementById('random-single-syllable-button-interactive');
        }
        
        function assignSequenceReadingElements() {
            syllableSequenceDisplay = document.getElementById('syllable-sequence-display');
            generateSequenceButton = document.getElementById('generate-sequence-button');
        }

        function assignVocabularyElements() {
            vocabWordDisplay = document.getElementById('vocab-word-display');
            vocabMeaningDisplay = document.getElementById('vocab-meaning-display');
            nextVocabButton = document.getElementById('next-vocab-button');
            showMeaningButton = document.getElementById('show-meaning-button');
        }

        function createConsonantButton(consonantObj, gridElement) { 
            const button = document.createElement('button');
            button.textContent = consonantObj.char;
            button.style.fontFamily = "'Noto Sans KR', sans-serif";
            button.classList.add('btn-char', 'p-3', 'rounded-md', 'text-lg', 'font-semibold', 'bg-white', 'text-blue-700', 'shadow-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400');
            button.dataset.char = consonantObj.char;
            button.dataset.consonantType = consonantObj.type; 
            button.dataset.type = 'consonant'; 
            button.addEventListener('click', handleCharSelection);
            if(gridElement) gridElement.appendChild(button);
        }
        
        function createVowelButton(char, gridElement) {
            const button = document.createElement('button');
            button.textContent = char;
            button.style.fontFamily = "'Noto Sans KR', sans-serif";
            button.classList.add('btn-char', 'p-2', 'sm:p-3', 'rounded-md', 'text-base', 'sm:text-lg', 'font-semibold', 'bg-white', 'text-blue-700', 'shadow-sm', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-400');
            button.dataset.char = char;
            button.dataset.type = 'vowel';
            button.addEventListener('click', handleCharSelection);
            if(gridElement) gridElement.appendChild(button);
        }

        function populateAllConsonantsForSingleSyllablePractice() {
            if (!consonantsPlainGrid || !consonantsAspiratedGrid || !consonantsTenseGrid) return;
            consonantsPlainGrid.innerHTML = '';
            consonantsAspiratedGrid.innerHTML = '';
            consonantsTenseGrid.innerHTML = '';

            if (selectedConsonant) selectedConsonant.classList.remove('selected');
            selectedConsonant = null; 
            
            allConsonantsWithTypes.forEach(cObj => {
                if (cObj.type === 'plain') createConsonantButton(cObj, consonantsPlainGrid);
                else if (cObj.type === 'aspirated') createConsonantButton(cObj, consonantsAspiratedGrid);
                else if (cObj.type === 'tense') createConsonantButton(cObj, consonantsTenseGrid);
            });
            updateSyllableDisplay();
        }
        
        function populateAllVowelsForSingleSyllablePractice() {
            if (!vowelsBasicGrid || !vowelsDoubleGrid) return;
            vowelsBasicGrid.innerHTML = '';
            vowelsDoubleGrid.innerHTML = '';

            if (selectedVowel) selectedVowel.classList.remove('selected');
            selectedVowel = null; 
            
            vowelGroupsForDisplay.basic.forEach(v => createVowelButton(v, vowelsBasicGrid));
            vowelGroupsForDisplay.double.forEach(v => createVowelButton(v, vowelsDoubleGrid));
            updateSyllableDisplay();
        }
        
        function handleCharSelection(event) {
            const button = event.target;
            const char = button.dataset.char;
            const type = button.dataset.type; // 'consonant' or 'vowel'

            if (type === 'consonant') {
                // Deselect previously selected consonant from ANY grid
                const allConsonantButtons = document.querySelectorAll('#single-syllable-practice-section .btn-char[data-type="consonant"]');
                allConsonantButtons.forEach(btn => btn.classList.remove('selected'));

                if (selectedConsonant === button) {
                    selectedConsonant = null;
                    selectedConsonantActualType = 'plain'; 
                } else { 
                    selectedConsonant = button; 
                    selectedConsonant.classList.add('selected');
                    selectedConsonantActualType = button.dataset.consonantType; 
                }
            } else if (type === 'vowel') {
                const allVowelButtons = document.querySelectorAll('#single-syllable-practice-section .btn-char[data-type="vowel"]');
                allVowelButtons.forEach(btn => btn.classList.remove('selected'));

                if (selectedVowel === button) selectedVowel = null;
                else { selectedVowel = button; selectedVowel.classList.add('selected'); }
            }
            updateSyllableDisplay();
        }

        function updateSyllableDisplay() {
            if (!mainSyllableCharDisplay || !plainComparisonSyllableCharDisplay || !syllablePlaceholder || !interactiveSyllableGrid) return; 

            mainSyllableCharDisplay.classList.remove('fade-in'); 
            plainComparisonSyllableCharDisplay.classList.remove('fade-in');
            void mainSyllableCharDisplay.offsetWidth; 

            let hasComparison = false;
            if (selectedConsonant && selectedVowel) {
                syllablePlaceholder.classList.add('hidden');
                const cSelected = selectedConsonant.dataset.char;
                const vSelected = selectedVowel.dataset.char;
                
                mainSyllableCharDisplay.textContent = syllableMaps[selectedConsonantActualType]?.[cSelected]?.[vSelected] || 'Lá»—i';
                
                let plainSyllableText = '--';
                if (selectedConsonantActualType === 'aspirated') {
                    const cPlain = aspiratedToPlainMap[cSelected];
                    plainSyllableText = syllableMaps.plain?.[cPlain]?.[vSelected] || '--';
                    hasComparison = plainSyllableText !== '--';
                } else if (selectedConsonantActualType === 'tense') {
                    const cPlain = tenseToPlainMap[cSelected];
                    plainSyllableText = syllableMaps.plain?.[cPlain]?.[vSelected] || '--';
                    hasComparison = plainSyllableText !== '--';
                }
                plainComparisonSyllableCharDisplay.textContent = plainSyllableText;
                interactiveSyllableGrid.querySelector('.plain-comparison-column').style.visibility = hasComparison ? 'visible' : 'hidden';

            } else {
                syllablePlaceholder.classList.remove('hidden');
                mainSyllableCharDisplay.textContent = '--';
                plainComparisonSyllableCharDisplay.textContent = '--';
                interactiveSyllableGrid.querySelector('.plain-comparison-column').style.visibility = 'visible'; 
                if (selectedConsonant) mainSyllableCharDisplay.textContent = selectedConsonant.dataset.char + '+?';
                if (selectedVowel && !selectedConsonant) mainSyllableCharDisplay.textContent = '?+' + selectedVowel.dataset.char;
            }
            mainSyllableCharDisplay.classList.add('fade-in');
            if (hasComparison) { 
                 plainComparisonSyllableCharDisplay.classList.add('fade-in');
            }
        }
        
        function generateRandomSingleSyllableInteractive() { 
            if (!mainSyllableCharDisplay || !plainComparisonSyllableCharDisplay || !syllablePlaceholder || !interactiveSyllableGrid) return;

            syllablePlaceholder.classList.add('hidden');
            
            const randomConsonantObj = allConsonantsWithTypes[Math.floor(Math.random() * allConsonantsWithTypes.length)];
            const randomCSelected = randomConsonantObj.char;
            const randomCType = randomConsonantObj.type; 
            const randomVSelected = allVowelsForRandom[Math.floor(Math.random() * allVowelsForRandom.length)];

            mainSyllableCharDisplay.textContent = syllableMaps[randomCType]?.[randomCSelected]?.[randomVSelected] || 'Lá»—i';
            let plainComparisonSyllable = '--';
            let currentHasComparison = false;

            if (randomCType === 'aspirated') {
                const cPlain = aspiratedToPlainMap[randomCSelected];
                plainComparisonSyllable = syllableMaps.plain?.[cPlain]?.[randomVSelected] || '--';
                currentHasComparison = plainComparisonSyllable !== '--';
            } else if (randomCType === 'tense') {
                const cPlain = tenseToPlainMap[randomCSelected];
                plainComparisonSyllable = syllableMaps.plain?.[cPlain]?.[randomVSelected] || '--';
                currentHasComparison = plainComparisonSyllable !== '--';
            }
            plainComparisonSyllableCharDisplay.textContent = plainComparisonSyllable;
            interactiveSyllableGrid.querySelector('.plain-comparison-column').style.visibility = currentHasComparison ? 'visible' : 'hidden';

            mainSyllableCharDisplay.classList.remove('fade-in');
            plainComparisonSyllableCharDisplay.classList.remove('fade-in');
            void mainSyllableCharDisplay.offsetWidth;
            mainSyllableCharDisplay.classList.add('fade-in');
            if (currentHasComparison) {
                plainComparisonSyllableCharDisplay.classList.add('fade-in');
            }

            if (selectedConsonant) selectedConsonant.classList.remove('selected');
            if (selectedVowel) selectedVowel.classList.remove('selected');
            selectedConsonant = null;
            selectedVowel = null;
            selectedConsonantActualType = 'plain'; 
        }

        function generateSyllableSequence(params) {
            if (!syllableSequenceDisplay) return;
            syllableSequenceDisplay.classList.remove('fade-in');
            void syllableSequenceDisplay.offsetWidth;

            const { countRange, consonantTypes, vowelGroupKey } = params;
            const syllableCount = Math.floor(Math.random() * (countRange[1] - countRange[0] + 1)) + countRange[0];
            const vowelsForSequence = vowelGroupsForSequence[vowelGroupKey] || vowelGroupsForSequence.all;
            
            let sequence = [];
            for (let i = 0; i < syllableCount; i++) {
                const randomConsonantTypeKey = consonantTypes[Math.floor(Math.random() * consonantTypes.length)];
                const consonantsForType = consonantGroupsForDisplay[randomConsonantTypeKey]; 
                const randomC = consonantsForType[Math.floor(Math.random() * consonantsForType.length)];
                const randomV = vowelsForSequence[Math.floor(Math.random() * vowelsForSequence.length)];
                
                const syllable = syllableMaps[randomConsonantTypeKey]?.[randomC]?.[randomV] || ' ? ';
                sequence.push(syllable);
            }
            syllableSequenceDisplay.textContent = sequence.join(' ');
            syllableSequenceDisplay.classList.add('fade-in');
        }
          function displayNextVocabularyWord() {
            if (!vocabWordDisplay || !vocabMeaningDisplay) return;
            const currentVocab = getCurrentVocabulary();
            if (currentVocab.length === 0) return;
            
            currentVocabIndex = Math.floor(Math.random() * currentVocab.length);
            const currentWord = currentVocab[currentVocabIndex];
            vocabWordDisplay.textContent = currentWord.word;
            vocabMeaningDisplay.textContent = currentWord.meaning;
            vocabMeaningDisplay.classList.add('hidden'); 
            if(showMeaningButton) showMeaningButton.textContent = "ğŸ‘ï¸ Xem NghÄ©a";
            
            // Add to reviewed words
            reviewedWords.add(currentWord.word);
            updateVocabularyStats();
        }

        function toggleVocabMeaning() {
            if (!vocabMeaningDisplay || !showMeaningButton) return;
            vocabMeaningDisplay.classList.toggle('hidden');
            showMeaningButton.textContent = vocabMeaningDisplay.classList.contains('hidden') ? "ğŸ‘ï¸ Xem NghÄ©a" : "ğŸ™ˆ áº¨n NghÄ©a";
        }

        function getCurrentVocabulary() {
            if (currentCategory === 'all') {
                return allVocabulary.filter(word => word.level <= difficulty);
            }
            return vocabularyByCategory[currentCategory]?.filter(word => word.level <= difficulty) || [];
        }

        function setupVocabularyEventListeners() {
            // Mode selection
            document.querySelectorAll('.vocab-mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.target.dataset.mode;
                    changeVocabularyMode(mode);
                });
            });

            // Category selection
            document.querySelectorAll('.vocab-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const category = e.target.dataset.category;
                    changeVocabularyCategory(category);
                });
            });

            // Review mode buttons
            if (nextVocabButton) nextVocabButton.addEventListener('click', displayNextVocabularyWord);
            if (showMeaningButton) showMeaningButton.addEventListener('click', toggleVocabMeaning);

            // Quiz mode buttons
            const nextQuizButton = document.getElementById('next-quiz-button');
            if (nextQuizButton) nextQuizButton.addEventListener('click', generateQuizQuestion);

            // Flashcard mode buttons
            const flashcardFlip = document.getElementById('flashcard-flip');
            const flashcardNext = document.getElementById('flashcard-next');
            const flashcardEasy = document.getElementById('flashcard-easy');
            const flashcardMedium = document.getElementById('flashcard-medium');
            const flashcardHard = document.getElementById('flashcard-hard');

            if (flashcardFlip) flashcardFlip.addEventListener('click', flipFlashcard);
            if (flashcardNext) flashcardNext.addEventListener('click', nextFlashcard);
            if (flashcardEasy) flashcardEasy.addEventListener('click', () => rateFlashcard('easy'));
            if (flashcardMedium) flashcardMedium.addEventListener('click', () => rateFlashcard('medium'));
            if (flashcardHard) flashcardHard.addEventListener('click', () => rateFlashcard('hard'));
        }

        function changeVocabularyMode(mode) {
            currentVocabMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.vocab-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Hide all mode contents
            document.querySelectorAll('.vocab-mode-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected mode content
            const selectedModeContent = document.getElementById(`${mode}-mode`);
            if (selectedModeContent) {
                selectedModeContent.classList.remove('hidden');
            }

            // Initialize mode-specific content
            if (mode === 'review') {
                displayNextVocabularyWord();
            } else if (mode === 'quiz') {
                generateQuizQuestion();
            } else if (mode === 'flashcard') {
                initializeFlashcard();
            }
        }

        function changeVocabularyCategory(category) {
            currentCategory = category;
            
            // Update category buttons
            document.querySelectorAll('.vocab-category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });

            updateVocabularyStats();
            
            // Refresh current mode
            if (currentVocabMode === 'review') {
                displayNextVocabularyWord();
            } else if (currentVocabMode === 'quiz') {
                generateQuizQuestion();
            } else if (currentVocabMode === 'flashcard') {
                initializeFlashcard();
            }
        }

        function generateQuizQuestion() {
            const currentVocab = getCurrentVocabulary();
            if (currentVocab.length < 4) return; // Need at least 4 words for quiz

            const questionWord = currentVocab[Math.floor(Math.random() * currentVocab.length)];
            const correctAnswer = questionWord.meaning;
            
            // Generate wrong answers
            const wrongAnswers = [];
            while (wrongAnswers.length < 3) {
                const randomWord = currentVocab[Math.floor(Math.random() * currentVocab.length)];
                if (randomWord.meaning !== correctAnswer && !wrongAnswers.includes(randomWord.meaning)) {
                    wrongAnswers.push(randomWord.meaning);
                }
            }

            // Shuffle all options
            const allOptions = [correctAnswer, ...wrongAnswers].sort(() => Math.random() - 0.5);

            // Update UI
            const questionElement = document.getElementById('quiz-question');
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackElement = document.getElementById('quiz-feedback');
            const nextButton = document.getElementById('next-quiz-button');

            if (questionElement) questionElement.textContent = questionWord.word;
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                allOptions.forEach(option => {
                    const optionButton = document.createElement('button');
                    optionButton.className = 'vocab-quiz-option';
                    optionButton.textContent = option;
                    optionButton.addEventListener('click', () => checkQuizAnswer(option, correctAnswer, optionButton));
                    optionsContainer.appendChild(optionButton);
                });
            }
            
            if (feedbackElement) feedbackElement.classList.add('hidden');
            if (nextButton) nextButton.classList.add('hidden');
            
            totalQuestions++;
            updateVocabularyStats();
        }

        function checkQuizAnswer(selectedAnswer, correctAnswer, buttonElement) {
            const isCorrect = selectedAnswer === correctAnswer;
            const feedbackElement = document.getElementById('quiz-feedback');
            const nextButton = document.getElementById('next-quiz-button');
            const optionsContainer = document.getElementById('quiz-options');

            // Disable all options
            optionsContainer.querySelectorAll('.vocab-quiz-option').forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn === buttonElement && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                correctAnswers++;
                if (feedbackElement) {
                    feedbackElement.textContent = 'ğŸ‰ ChÃ­nh xÃ¡c!';
                    feedbackElement.className = 'vocab-feedback correct';
                    feedbackElement.classList.remove('hidden');
                }
                buttonElement.parentElement.classList.add('pulse');
            } else {
                if (feedbackElement) {
                    feedbackElement.textContent = `âŒ Sai rá»“i! ÄÃ¡p Ã¡n Ä‘Ãºng lÃ : ${correctAnswer}`;
                    feedbackElement.className = 'vocab-feedback incorrect';
                    feedbackElement.classList.remove('hidden');
                }
                buttonElement.parentElement.classList.add('shake');
            }

            if (nextButton) nextButton.classList.remove('hidden');
            updateVocabularyStats();
        }

        function initializeFlashcard() {
            const currentVocab = getCurrentVocabulary();
            if (currentVocab.length === 0) return;

            const randomWord = currentVocab[Math.floor(Math.random() * currentVocab.length)];
            const wordElement = document.getElementById('flashcard-word');
            const meaningElement = document.getElementById('flashcard-meaning');
            const frontElement = document.getElementById('flashcard-front');
            const backElement = document.getElementById('flashcard-back');

            if (wordElement) wordElement.textContent = randomWord.word;
            if (meaningElement) meaningElement.textContent = randomWord.meaning;
            if (frontElement) frontElement.classList.remove('hidden');
            if (backElement) backElement.classList.add('hidden');
        }

        function flipFlashcard() {
            const frontElement = document.getElementById('flashcard-front');
            const backElement = document.getElementById('flashcard-back');
            
            if (frontElement && backElement) {
                frontElement.classList.toggle('hidden');
                backElement.classList.toggle('hidden');
            }
        }

        function nextFlashcard() {
            initializeFlashcard();
            reviewedWords.add(document.getElementById('flashcard-word')?.textContent || '');
            updateVocabularyStats();
        }

        function rateFlashcard(rating) {
            // In a real app, you might save this rating for spaced repetition
            console.log(`Rated current flashcard as: ${rating}`);
            nextFlashcard();
        }

        function updateVocabularyStats() {
            const scoreElement = document.getElementById('vocab-score');
            const progressElement = document.getElementById('vocab-progress');
            const difficultyElement = document.getElementById('vocab-difficulty');
            const progressFillElement = document.getElementById('vocab-progress-fill');
            
            const currentVocab = getCurrentVocabulary();
            const totalWords = currentVocab.length;
            const reviewedCount = [...reviewedWords].filter(word => 
                currentVocab.some(vocab => vocab.word === word)
            ).length;

            if (scoreElement) scoreElement.textContent = `${correctAnswers}/${totalQuestions}`;
            if (progressElement) progressElement.textContent = reviewedCount;
            if (difficultyElement) difficultyElement.textContent = `Cáº¥p ${difficulty}`;
            if (progressFillElement) {
                const progressPercent = totalWords > 0 ? (reviewedCount / totalWords) * 100 : 0;
                progressFillElement.style.width = `${Math.min(progressPercent, 100)}%`;
            }
        }

        function setActiveExercise(exerciseId) {
            activeExerciseId = exerciseId;
            const exercise = exercises.find(ex => ex.id === exerciseId);
            if (!exercise) return;

            const navButtons = navigationMenu.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.exerciseId === exerciseId);
            });
            
            selectedConsonant = null;
            selectedVowel = null;
            
            renderExerciseUI(exercise);
        }

        exercises.forEach(ex => {
            const button = document.createElement('button');
            button.textContent = ex.title;
            button.classList.add('nav-btn', 'p-3', 'rounded-md', 'text-left', 'w-full', 'bg-white', 'text-blue-700', 'shadow-sm');
            button.dataset.exerciseId = ex.id;
            button.addEventListener('click', () => setActiveExercise(ex.id));
            navigationMenu.appendChild(button);
        });        setActiveExercise('ex_single_syllable'); 

    </script>
</body>
</html>
