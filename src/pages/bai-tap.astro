---
import Layout from '../layouts/Layout.astro';
import { readdirSync, readFileSync } from 'fs';
import { join } from 'path';

// Đọc tất cả file .astro trong thư mục bai-tap
const exercisesDir = join(process.cwd(), 'src', 'pages', 'bai-tap');
let exercises: Array<{ slug: string; title: string }> = [];

try {
  const files = readdirSync(exercisesDir).filter((file: string) => 
    file.endsWith('.astro') && file !== 'index.astro'
  );

  exercises = files.map((file: string) => {
    const slug = file.replace('.astro', '');
    let title = slug; // Mặc định dùng slug làm title
    
    try {
      // Đọc frontmatter để lấy title nếu có
      const filePath = join(exercisesDir, file);
      const content = readFileSync(filePath, 'utf-8');
      
      // Ưu tiên tìm title trong h1 tag (chi tiết hơn)
      const h1Match = content.match(/<h1[^>]*>.*?Bài tập[:\s]*([^<]+).*?<\/h1>/i);
      if (h1Match) {
        title = h1Match[1].trim();
      } else {
        // Nếu không có h1, tìm trong Layout title prop
        const layoutTitleMatch = content.match(/title:\s*["'](.+?)["']/);
        if (layoutTitleMatch) {
          title = layoutTitleMatch[1]
            .replace(/\s*-\s*The Free Korean\s*$/i, '')
            .replace(/^Bài tập\s*/i, '')
            .trim();
        }
      }
    } catch (error) {
      console.error(`Error reading ${file}:`, error);
    }
    
    return { slug, title };
  });

  // Sắp xếp theo slug
  exercises.sort((a, b) => a.slug.localeCompare(b.slug));
} catch (error) {
  console.error('Error reading exercises directory:', error);
}
---

<Layout title="Bài tập - The Free Korean">
  <main class="min-h-[60vh] bg-gray-50 px-4 py-12">
    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">Bài tập</h1>
        <p class="text-xl text-gray-600">
          Luyện tập ngữ pháp tiếng Hàn với các bài tập có giải thích chi tiết
        </p>
      </div>

      <!-- Danh sách bài tập -->
      {exercises.length > 0 ? (
        <div class="space-y-4">
          {exercises.map((exercise) => (
            <a 
              href={`/bai-tap/${exercise.slug}`}
              class="block bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-200 border-2 border-transparent hover:border-blue-400"
            >
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-xl font-semibold text-gray-900 mb-1">
                    {exercise.title}
                  </h2>
                  <p class="text-gray-600 text-sm">
                    Bài tập về ngữ pháp
                  </p>
                </div>
                <svg 
                  class="w-6 h-6 text-gray-400 flex-shrink-0" 
                  fill="none" 
                  stroke="currentColor" 
                  viewBox="0 0 24 24"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
          <p class="text-lg text-gray-600 mb-4">
            Chưa có bài tập nào. Vui lòng quay lại sau.
          </p>
          <p class="text-gray-500 text-sm">
            Các bài tập sẽ được thêm vào thư mục <code class="bg-gray-100 px-2 py-1 rounded">src/pages/bai-tap/</code>
          </p>
        </div>
      )}
    </div>
  </main>
</Layout>


