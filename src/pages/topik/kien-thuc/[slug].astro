---
import TopikLayout from '../../../layouts/TopikLayout.astro';
import { readdirSync, readFileSync, existsSync } from 'fs';
import { join } from 'path';
import { marked } from 'marked';

export async function getStaticPaths() {
  // ƒê·ªçc t·∫•t c·∫£ file markdown trong th∆∞ m·ª•c topik/kien-thuc
  const contentDir = join(process.cwd(), 'src', 'content', 'topik', 'kien-thuc');
  let paths: any[] = [];
  
  try {
    const files = readdirSync(contentDir).filter((file: string) => 
      file.endsWith('.md') || file.endsWith('.mdx')
    );
    
    paths = files.map((file: string) => {
      const slug = file.replace(/\.(md|mdx)$/, '');
      return {
        params: { slug }
      };
    });
  } catch (error) {
    console.error('Error reading kien-thuc directory:', error);
  }
  
  return paths;
}

interface Props {
  slug: string;
}

const { slug } = Astro.params;

// H√†m parse frontmatter th·ªß c√¥ng
const parseFrontmatter = (content: string) => {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  const match = content.match(frontmatterRegex);
  
  if (!match) {
    return { data: {}, content };
  }
  
  const frontmatterText = match[1];
  const body = match[2];
  const data: any = {};
  
  // Parse YAML ƒë∆°n gi·∫£n
  frontmatterText.split('\n').forEach((line: string) => {
    const colonIndex = line.indexOf(':');
    if (colonIndex > 0) {
      const key = line.substring(0, colonIndex).trim();
      let value = line.substring(colonIndex + 1).trim();
      
      // X·ª≠ l√Ω gi√° tr·ªã c√≥ d·∫•u ngo·∫∑c k√©p
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      } else if (value.startsWith("'") && value.endsWith("'")) {
        value = value.slice(1, -1);
      }
      
      // X·ª≠ l√Ω m·∫£ng
      if (value.startsWith('[') && value.endsWith(']')) {
        const arrayContent = value.slice(1, -1);
        data[key] = arrayContent.split(',').map((item: string) => item.trim().replace(/^["']|["']$/g, ''));
      } else {
        data[key] = value;
      }
    }
  });
  
  return { data, content: body };
};

// ƒê·ªçc file markdown
const contentDir = join(process.cwd(), 'src', 'content', 'topik', 'kien-thuc');
let frontmatter: any = {};
let content = '';
let notFound = false;

// Th·ª≠ ƒë·ªçc file .md tr∆∞·ªõc, n·∫øu kh√¥ng c√≥ th√¨ th·ª≠ .mdx
const mdPath = join(contentDir, `${slug}.md`);
const mdxPath = join(contentDir, `${slug}.mdx`);

let filePath = '';
if (existsSync(mdPath)) {
  filePath = mdPath;
} else if (existsSync(mdxPath)) {
  filePath = mdxPath;
} else {
  notFound = true;
}

if (!notFound) {
  try {
    const fileContent = readFileSync(filePath, 'utf-8');
    const parsed = parseFrontmatter(fileContent);
    frontmatter = parsed.data;
    // Convert markdown to HTML
    content = marked.parse(parsed.content) as string;
  } catch (error) {
    console.error(`Error reading ${filePath}:`, error);
    notFound = true;
  }
}

if (notFound) {
  return Astro.redirect('/topik/kien-thuc');
}
---

<TopikLayout 
  title={frontmatter.title}
  description={frontmatter.description || ''}
>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Back buttons -->
    <div class="flex items-center gap-4 mb-6 flex-wrap">
      <a 
        href="/topik"
        class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Quay l·∫°i trang TOPIK</span>
      </a>
      <span class="text-gray-400">|</span>
      <a 
        href="/topik/kien-thuc"
        class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Quay l·∫°i danh s√°ch</span>
      </a>
    </div>

    <!-- Article header -->
    <article class="bg-white rounded-xl shadow-lg p-8">
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          {frontmatter.title}
        </h1>
        
        {frontmatter.description && (
          <p class="text-xl text-gray-600 mb-6">
            {frontmatter.description}
          </p>
        )}

        <div class="flex items-center gap-4 flex-wrap text-sm text-gray-600">
          {frontmatter.category && (
            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full font-medium">
              {frontmatter.category}
            </span>
          )}
          {frontmatter.level && (
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-medium">
              {frontmatter.level}
            </span>
          )}
          {frontmatter.date && (
            <span class="text-gray-500">
              üìÖ {new Date(frontmatter.date).toLocaleDateString('vi-VN')}
            </span>
          )}
        </div>
      </header>

      <!-- Article content -->
      <div class="prose prose-lg max-w-none">
        {content && (
          <div set:html={content} />
        )}
      </div>
    </article>
  </div>
</TopikLayout>

<style is:global>
  /* Prose container */
  .prose {
    color: #374151;
    line-height: 1.75;
  }
  
  /* Headings - TƒÉng specificity ƒë·ªÉ override Tailwind */
  .prose h1,
  div.prose h1 {
    font-size: 2.25rem !important;
    font-weight: 800 !important;
    margin-top: 0 !important;
    margin-bottom: 0.8888889em !important;
    line-height: 1.1111111 !important;
    color: #111827 !important;
  }
  
  .prose h2,
  div.prose h2 {
    font-size: 1.875rem !important;
    font-weight: 700 !important;
    margin-top: 2em !important;
    margin-bottom: 1em !important;
    line-height: 1.3333333 !important;
    color: #111827 !important;
    border-bottom: 2px solid #e5e7eb !important;
    padding-bottom: 0.5em !important;
  }
  
  .prose h3,
  div.prose h3 {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    margin-top: 1.5em !important;
    margin-bottom: 0.75em !important;
    line-height: 1.5 !important;
    color: #111827 !important;
  }
  
  .prose h4,
  div.prose h4 {
    font-size: 1.25rem !important;
    font-weight: 600 !important;
    margin-top: 1.25em !important;
    margin-bottom: 0.75em !important;
    color: #111827 !important;
  }
  
  .prose h5,
  div.prose h5 {
    font-size: 1.125rem !important;
    font-weight: 600 !important;
    margin-top: 1.125em !important;
    margin-bottom: 0.625em !important;
    color: #374151 !important;
  }
  
  .prose h6,
  div.prose h6 {
    font-size: 1rem !important;
    font-weight: 600 !important;
    margin-top: 1em !important;
    margin-bottom: 0.5em !important;
    color: #6b7280 !important;
  }
  
  /* Paragraphs */
  .prose p,
  div.prose p {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
  }
  
  /* Lists */
  .prose ul, 
  .prose ol,
  div.prose ul, 
  div.prose ol {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    padding-left: 1.625em;
  }
  
  .prose ul,
  div.prose ul {
    list-style-type: disc;
  }
  
  .prose ol,
  div.prose ol {
    list-style-type: decimal;
  }
  
  .prose li,
  div.prose li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
    padding-left: 0.375em;
  }
  
  .prose li > p,
  div.prose li > p {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }
  
  .prose li > :first-child,
  div.prose li > :first-child {
    margin-top: 0;
  }
  
  .prose li > :last-child,
  div.prose li > :last-child {
    margin-bottom: 0;
  }
  
  /* Code */
  .prose code,
  div.prose code {
    background-color: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    color: #dc2626;
    font-weight: 500;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
  }
  
  .prose pre,
  div.prose pre {
    background-color: #1f2937;
    color: #f9fafb;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    font-size: 0.875em;
    line-height: 1.7142857;
  }
  
  .prose pre code,
  div.prose pre code {
    background-color: transparent;
    color: inherit;
    padding: 0;
    border-radius: 0;
    font-weight: 400;
  }
  
  /* Blockquotes */
  .prose blockquote,
  div.prose blockquote {
    border-left: 4px solid #3b82f6;
    padding-left: 1em;
    padding-right: 1em;
    padding-top: 0.5em;
    padding-bottom: 0.5em;
    margin-left: 0;
    margin-right: 0;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    background-color: #eff6ff;
    border-radius: 0.375rem;
    color: #1e40af;
    font-style: normal;
  }
  
  .prose blockquote p,
  div.prose blockquote p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
  
  .prose blockquote p:first-child,
  div.prose blockquote p:first-child {
    margin-top: 0;
  }
  
  .prose blockquote p:last-child,
  div.prose blockquote p:last-child {
    margin-bottom: 0;
  }
  
  .prose blockquote strong,
  div.prose blockquote strong {
    color: #1e3a8a;
    font-weight: 600;
  }
  
  /* Links */
  .prose a,
  div.prose a {
    color: #2563eb;
    text-decoration: underline;
    font-weight: 500;
    transition: color 0.2s ease;
  }
  
  .prose a:hover,
  div.prose a:hover {
    color: #1d4ed8;
  }
  
  /* Images */
  .prose img,
  div.prose img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
  }
  
  /* Tables */
  .prose table,
  div.prose table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
    font-size: 0.875em;
    line-height: 1.7142857;
  }
  
  .prose thead,
  div.prose thead {
    border-bottom: 2px solid #e5e7eb;
  }
  
  .prose th,
  div.prose th {
    background-color: #f9fafb;
    font-weight: 600;
    color: #111827;
    text-align: left;
    padding: 0.75rem 1rem;
    border: 1px solid #e5e7eb;
  }
  
  .prose td,
  div.prose td {
    padding: 0.75rem 1rem;
    border: 1px solid #e5e7eb;
  }
  
  .prose tbody tr,
  div.prose tbody tr {
    border-bottom: 1px solid #e5e7eb;
    transition: background-color 0.15s ease;
  }
  
  .prose tbody tr:hover,
  div.prose tbody tr:hover {
    background-color: #f9fafb;
  }
  
  .prose tbody tr:last-child,
  div.prose tbody tr:last-child {
    border-bottom: none;
  }
  
  /* Horizontal rules */
  .prose hr,
  div.prose hr {
    border-top: 1px solid #e5e7eb;
    margin-top: 3em;
    margin-bottom: 3em;
  }
  
  /* Strong/Bold */
  .prose strong,
  div.prose strong {
    color: #111827;
    font-weight: 600;
  }
  
  /* Emphasis/Italic */
  .prose em,
  div.prose em {
    font-style: italic;
    color: #374151;
  }
  
  /* First child spacing */
  .prose > :first-child,
  div.prose > :first-child {
    margin-top: 0;
  }
  
  .prose > :last-child,
  div.prose > :last-child {
    margin-bottom: 0;
  }
</style>

