---
import TopikLayout from '../../../layouts/TopikLayout.astro';
import { readdirSync, readFileSync } from 'fs';
import { join } from 'path';

// H√†m parse frontmatter th·ªß c√¥ng
const parseFrontmatter = (content: string) => {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  const match = content.match(frontmatterRegex);
  
  if (!match) {
    return { data: {}, content };
  }
  
  const frontmatterText = match[1];
  const body = match[2];
  const data: any = {};
  
  // Parse YAML ƒë∆°n gi·∫£n
  frontmatterText.split('\n').forEach((line: string) => {
    const colonIndex = line.indexOf(':');
    if (colonIndex > 0) {
      const key = line.substring(0, colonIndex).trim();
      let value = line.substring(colonIndex + 1).trim();
      
      // X·ª≠ l√Ω gi√° tr·ªã c√≥ d·∫•u ngo·∫∑c k√©p
      if (value.startsWith('"') && value.endsWith('"')) {
        value = value.slice(1, -1);
      } else if (value.startsWith("'") && value.endsWith("'")) {
        value = value.slice(1, -1);
      }
      
      // X·ª≠ l√Ω m·∫£ng
      if (value.startsWith('[') && value.endsWith(']')) {
        const arrayContent = value.slice(1, -1);
        data[key] = arrayContent.split(',').map((item: string) => item.trim().replace(/^["']|["']$/g, ''));
      } else {
        data[key] = value;
      }
    }
  });
  
  return { data, content: body };
};

// ƒê·ªçc t·∫•t c·∫£ file markdown trong th∆∞ m·ª•c topik/kien-thuc
const contentDir = join(process.cwd(), 'src', 'content', 'topik', 'kien-thuc');
let articles: any[] = [];

try {
  const files = readdirSync(contentDir).filter((file: string) => 
    file.endsWith('.md') || file.endsWith('.mdx')
  );

  // ƒê·ªçc v√† parse t·ª´ng file ƒë·ªÉ l·∫•y frontmatter
  articles = files
    .map((file: string) => {
      try {
        const filePath = join(contentDir, file);
        const content = readFileSync(filePath, 'utf-8');
        const { data } = parseFrontmatter(content);
        const slug = file.replace(/\.(md|mdx)$/, '');
        
        return {
          slug,
          title: data.title || slug,
          description: data.description || '',
          category: data.category || 'Kh√°c',
          level: data.level || '',
          tags: Array.isArray(data.tags) ? data.tags : (data.tags ? [data.tags] : []),
          date: data.date || null
        };
      } catch (error) {
        console.error(`Error reading ${file}:`, error);
        return null;
      }
    })
    .filter(Boolean)
    .sort((a: any, b: any) => {
      // S·∫Øp x·∫øp theo date n·∫øu c√≥, n·∫øu kh√¥ng th√¨ theo title
      if (a.date && b.date) {
        return new Date(b.date).getTime() - new Date(a.date).getTime();
      }
      return a.title.localeCompare(b.title);
    });
} catch (error) {
  console.error('Error reading kien-thuc directory:', error);
  articles = [];
}

// Nh√≥m theo category
const groupedArticles: Record<string, typeof articles> = {};
articles.forEach((article: any) => {
  const key = article.category;
  if (!groupedArticles[key]) {
    groupedArticles[key] = [];
  }
  groupedArticles[key].push(article);
});

// S·∫Øp x·∫øp c√°c nh√≥m
const sortedCategories = Object.keys(groupedArticles).sort();
---

<TopikLayout 
  title="Ki·∫øn th·ª©c TOPIK"
  description="T·ªïng h·ª£p ki·∫øn th·ª©c v·ªÅ TOPIK - Ng·ªØ ph√°p, T·ª´ v·ª±ng, K·ªπ nƒÉng l√†m b√†i"
>
  <div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Back to TOPIK button -->
    <a 
      href="/topik"
      class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-6 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span>Quay l·∫°i trang TOPIK</span>
    </a>

    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">
        Ki·∫øn th·ª©c TOPIK
      </h1>
      <p class="text-xl text-gray-600">
        T·ªïng h·ª£p ki·∫øn th·ª©c v·ªÅ TOPIK - Ng·ªØ ph√°p, T·ª´ v·ª±ng, K·ªπ nƒÉng l√†m b√†i
      </p>
    </div>

    {articles.length === 0 ? (
      <div class="max-w-4xl mx-auto text-center py-16">
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-8">
          <p class="text-lg text-gray-700 mb-4">
            üìö Ch∆∞a c√≥ b√†i vi·∫øt n√†o trong m·ª•c Ki·∫øn th·ª©c.
          </p>
          <p class="text-gray-600">
            C√°c b√†i vi·∫øt s·∫Ω ƒë∆∞·ª£c th√™m v√†o th∆∞ m·ª•c <code class="bg-gray-100 px-2 py-1 rounded">src/content/topik/kien-thuc/</code>
          </p>
        </div>
      </div>
    ) : (
      <div class="max-w-4xl mx-auto">
        {sortedCategories.map((category) => (
          <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <button 
              class="w-full flex items-center justify-between text-left group"
              data-collapse-toggle={`category-${category.replace(/\s+/g, '-').toLowerCase()}`}
            >
              <h2 class="text-2xl font-bold text-gray-900">
                {category}
              </h2>
              <svg 
                class="w-6 h-6 text-gray-500 transform transition-transform duration-200 group-hover:text-gray-700 collapse-icon"
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <ul 
              class="space-y-3 collapse-content mt-6"
              data-collapse-target={`category-${category.replace(/\s+/g, '-').toLowerCase()}`}
            >
              {groupedArticles[category].map((article: any) => (
                <li>
                  <a 
                    href={`/topik/kien-thuc/${article.slug}`}
                    class="block p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 transition-all duration-200"
                  >
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">
                          {article.title}
                        </h3>
                        {article.description && (
                          <p class="text-gray-600 text-sm mb-2">
                            {article.description}
                          </p>
                        )}
                        <div class="flex items-center gap-3 flex-wrap">
                          {article.level && (
                            <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">
                              {article.level}
                            </span>
                          )}
                          {article.tags && article.tags.length > 0 && (
                            <div class="flex gap-2 flex-wrap">
                              {article.tags.slice(0, 3).map((tag: string) => (
                                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">
                                  #{tag}
                                </span>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                      <svg class="w-5 h-5 text-gray-400 ml-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                    </div>
                  </a>
                </li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    )}
  </div>
</TopikLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const collapseButtons = document.querySelectorAll('[data-collapse-toggle]');
    
    collapseButtons.forEach((button) => {
      const targetId = button.getAttribute('data-collapse-toggle');
      const target = document.querySelector(`[data-collapse-target="${targetId}"]`);
      const icon = button.querySelector('.collapse-icon');
      
      if (!target) return;
      
      // M·∫∑c ƒë·ªãnh m·ªü (expanded)
      target.classList.add('expanded');
      if (icon) {
        icon.style.transform = 'rotate(180deg)';
      }
      
      button.addEventListener('click', () => {
        const isExpanded = target.classList.contains('expanded');
        
        if (isExpanded) {
          // Collapse
          target.classList.remove('expanded');
          target.classList.add('collapsed');
          if (icon) {
            icon.style.transform = 'rotate(0deg)';
          }
        } else {
          // Expand
          target.classList.remove('collapsed');
          target.classList.add('expanded');
          if (icon) {
            icon.style.transform = 'rotate(180deg)';
          }
        }
      });
    });
  });
</script>

<style>
  .collapse-content {
    transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out;
    overflow: hidden;
  }
  
  .collapse-content.expanded {
    max-height: 2000px;
    opacity: 1;
  }
  
  .collapse-content.collapsed {
    max-height: 0;
    opacity: 0;
    margin-top: 0 !important;
  }
  
  .collapse-icon {
    transition: transform 0.2s ease;
  }
  
  [data-collapse-toggle] {
    cursor: pointer;
    padding: 0.5rem 0;
  }
  
  [data-collapse-toggle]:hover {
    opacity: 0.8;
  }
</style>

