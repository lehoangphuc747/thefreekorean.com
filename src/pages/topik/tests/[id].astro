---
import TopikLayout from '../../../layouts/TopikLayout.astro';
import TopikTimer from '../../../components/topik/TopikTimer.astro';
import TopikQuiz from '../../../components/topik/TopikQuiz.astro';

// Sample test data - trong th·ª±c t·∫ø s·∫Ω load t·ª´ database theo ID
export async function getStaticPaths() {
  const sampleTests = [
    {
      id: 'topik-i-2023-1',
      title: 'TOPIK I - K·ª≥ thi th√°ng 4/2023',
      description: 'ƒê·ªÅ thi TOPIK I ch√≠nh th·ª©c k·ª≥ thi th√°ng 4/2023',
      level: 'TOPIK I',
      duration: 100,
      questions: [
        {
          id: 'q1',
          type: 'multiple-choice',
          section: 'listening',
          question: 'Îã§ÏùåÏùÑ Îì£Í≥† ÏïåÎßûÏùÄ Í≤ÉÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          audio: '/audio/topik-i-2023-1-q1.mp3',
          options: [
            'ÌïôÍµêÏóê Í∞ëÎãàÎã§.',
            'ÏßëÏóê Í∞ëÎãàÎã§.',
            'ÌöåÏÇ¨Ïóê Í∞ëÎãàÎã§.',
            'Î≥ëÏõêÏóê Í∞ëÎãàÎã§.'
          ],
          correctAnswer: 1,
          explanation: 'ÎåÄÌôîÏóêÏÑú "ÏßëÏóê Í∞ÑÎã§"Í≥† Î™ÖÌôïÌûà ÎßêÌñàÏäµÎãàÎã§.',
          points: 2
        },
        {
          id: 'q2',
          type: 'multiple-choice',
          section: 'listening',
          question: 'ÎåÄÌôîÎ•º Îì£Í≥† Ïó¨ÏûêÍ∞Ä Ïñ¥ÎîîÏóê Í∞ÄÎäîÏßÄ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          audio: '/audio/topik-i-2023-1-q2.mp3',
          options: [
            'ÎèÑÏÑúÍ¥Ä',
            'Ïπ¥Ìéò',
            'ÏãùÎãπ',
            'ÏÉÅÏ†ê'
          ],
          correctAnswer: 0,
          explanation: 'Ïó¨ÏûêÍ∞Ä "ÎèÑÏÑúÍ¥ÄÏóêÏÑú Í≥µÎ∂ÄÌïòÍ≤†Îã§"Í≥† ÎßêÌñàÏäµÎãàÎã§.',
          points: 2
        },
        {
          id: 'q3',
          type: 'multiple-choice',
          section: 'reading',
          question: 'Îã§Ïùå Í∏ÄÏùò ÎÇ¥Ïö©Í≥º Í∞ôÏùÄ Í≤ÉÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          passage: 'Ï†ÄÎäî Îß§Ïùº ÏïÑÏπ® 7ÏãúÏóê ÏùºÏñ¥ÎÇ©ÎãàÎã§. Í∑∏Î¶¨Í≥† Ïö¥ÎèôÏùÑ Ìïú ÏãúÍ∞Ñ Ìï©ÎãàÎã§. Ïö¥Îèô ÌõÑÏóê ÏÉ§ÏõåÎ•º ÌïòÍ≥† ÏïÑÏπ®ÏùÑ Î®πÏäµÎãàÎã§. 8Ïãú 30Î∂ÑÏóê ÌöåÏÇ¨Ïóê Í∞ëÎãàÎã§.',
          options: [
            '7ÏãúÏóê Ïö¥ÎèôÏùÑ ÏãúÏûëÌï©ÎãàÎã§.',
            '8ÏãúÏóê ÏïÑÏπ®ÏùÑ Î®πÏäµÎãàÎã§.',
            '9ÏãúÏóê ÌöåÏÇ¨Ïóê Í∞ëÎãàÎã§.',
            'ÏÉ§Ïõå ÌõÑÏóê Ïö¥ÎèôÏùÑ Ìï©ÎãàÎã§.'
          ],
          correctAnswer: 0,
          explanation: 'Í∏ÄÏóêÏÑú 7ÏãúÏóê ÏùºÏñ¥ÎÇòÏÑú Ïö¥ÎèôÏùÑ ÌïúÎã§Í≥† ÌñàÏúºÎØÄÎ°ú, 7ÏãúÏóê Ïö¥ÎèôÏùÑ ÏãúÏûëÌïúÎã§Îäî Í≤ÉÏù¥ ÎßûÏäµÎãàÎã§.',
          points: 2
        },
        {
          id: 'q4',
          type: 'multiple-choice',
          section: 'reading',
          question: 'Îπà Í≥≥Ïóê Îì§Ïñ¥Í∞à Í∞ÄÏû• ÏïåÎßûÏùÄ Í≤ÉÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          passage: 'Ïñ¥Ï†ú ÏπúÍµ¨ÏôÄ ÏòÅÌôîÎ•º Î¥§ÏäµÎãàÎã§. ÏòÅÌôîÍ∞Ä ÏïÑÏ£º _____. Îã§ÏùåÏóê Îòê Î≥¥Í≥† Ïã∂ÏäµÎãàÎã§.',
          options: [
            'Ï¢ãÏïòÏäµÎãàÎã§',
            'ÎÇòÎπ¥ÏäµÎãàÎã§',
            'Ïñ¥Î†§Ïõ†ÏäµÎãàÎã§',
            'Ïâ¨Ïõ†ÏäµÎãàÎã§'
          ],
          correctAnswer: 0,
          explanation: '"Îã§ÏùåÏóê Îòê Î≥¥Í≥† Ïã∂Îã§"Îäî ÌëúÌòÑÏóêÏÑú ÏòÅÌôîÍ∞Ä Ï¢ãÏïòÎã§Îäî Í≤ÉÏùÑ Ïïå Ïàò ÏûàÏäµÎãàÎã§.',
          points: 2
        },
        {
          id: 'q5',
          type: 'multiple-choice',
          section: 'reading',
          question: 'Îã§Ïùå Í∑∏Î¶ºÏùÑ Î≥¥Í≥† ÏïåÎßûÏùÄ ÏÑ§Î™ÖÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          image: '/images/topik-reading-q5.jpg',
          options: [
            'ÏÇ¨ÎûåÎì§Ïù¥ Í≥µÏõêÏóêÏÑú Ïö¥ÎèôÌïòÍ≥† ÏûàÏäµÎãàÎã§.',
            'ÏÇ¨ÎûåÎì§Ïù¥ ÏãùÎãπÏóêÏÑú ÏãùÏÇ¨ÌïòÍ≥† ÏûàÏäµÎãàÎã§.',
            'ÏÇ¨ÎûåÎì§Ïù¥ ÎèÑÏÑúÍ¥ÄÏóêÏÑú Í≥µÎ∂ÄÌïòÍ≥† ÏûàÏäµÎãàÎã§.',
            'ÏÇ¨ÎûåÎì§Ïù¥ ÏÉÅÏ†êÏóêÏÑú ÏáºÌïëÌïòÍ≥† ÏûàÏäµÎãàÎã§.'
          ],
          correctAnswer: 0,
          explanation: 'Í∑∏Î¶ºÏóêÏÑú Í≥µÏõêÏóêÏÑú Ïó¨Îü¨ ÏÇ¨ÎûåÎì§Ïù¥ Ïö¥ÎèôÌïòÎäî Î™®ÏäµÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§.',
          points: 2
        }
      ],
      totalPoints: 10
    },
    {
      id: 'topik-ii-2023-1',
      title: 'TOPIK II - K·ª≥ thi th√°ng 4/2023',
      description: 'ƒê·ªÅ thi TOPIK II ch√≠nh th·ª©c k·ª≥ thi th√°ng 4/2023',
      level: 'TOPIK II',
      duration: 180,
      questions: [
        {
          id: 'q1',
          type: 'multiple-choice',
          section: 'listening',
          question: 'Îã§ÏùåÏùÑ Îì£Í≥† ÎÇ®ÏûêÏùò ÏùòÍ≤¨ÏúºÎ°ú Í∞ÄÏû• ÏïåÎßûÏùÄ Í≤ÉÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          audio: '/audio/topik-ii-2023-1-q1.mp3',
          options: [
            'ÌôòÍ≤Ω Î≥¥Ìò∏Í∞Ä Ï§ëÏöîÌïòÎã§',
            'Í≤ΩÏ†ú Î∞úÏ†ÑÏù¥ Ïö∞ÏÑ†Ïù¥Îã§',
            'Í∏∞Ïà† Î∞úÏ†ÑÏù¥ ÌïÑÏöîÌïòÎã§',
            'ÍµêÏú° Í∞úÌòÅÏù¥ ÏãúÍ∏âÌïòÎã§'
          ],
          correctAnswer: 0,
          explanation: 'ÎÇ®ÏûêÍ∞Ä ÌôòÍ≤Ω Î¨∏Ï†úÏùò Ïã¨Í∞ÅÏÑ±Í≥º Î≥¥Ìò∏Ïùò Ï§ëÏöîÏÑ±ÏùÑ Í∞ïÏ°∞ÌñàÏäµÎãàÎã§.',
          points: 3
        },
        {
          id: 'q2',
          type: 'multiple-choice',
          section: 'reading',
          question: 'Îã§Ïùå Í∏ÄÏùò Ï£ºÏ†úÎ°ú Í∞ÄÏû• ÏïåÎßûÏùÄ Í≤ÉÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.',
          passage: 'ÌòÑÎåÄ ÏÇ¨ÌöåÏóêÏÑú Ïä§ÎßàÌä∏Ìè∞ÏùÄ Îã®ÏàúÌïú ÌÜµÏã† ÎèÑÍµ¨Î•º ÎÑòÏñ¥ÏÑú Ïö∞Î¶¨ ÏÇ∂Ïùò ÌïÑÏàòÌíàÏù¥ ÎêòÏóàÎã§. Ï†ïÎ≥¥ Í≤ÄÏÉâ, ÏóÖÎ¨¥ Ï≤òÎ¶¨, ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏ Îì± Îã§ÏñëÌïú Í∏∞Îä•ÏùÑ Ï†úÍ≥µÌïòÎ©∞ ÏùºÏÉÅÏÉùÌôúÏùò Ìé∏ÏùòÏÑ±ÏùÑ ÌÅ¨Í≤å Ìñ•ÏÉÅÏãúÏº∞Îã§. ÌïòÏßÄÎßå Í≥ºÎèÑÌïú ÏÇ¨Ïö©ÏúºÎ°ú Ïù∏Ìïú Ï§ëÎèÖ Î¨∏Ï†úÏôÄ ÎåÄÏù∏Í¥ÄÍ≥Ñ ÏïÖÌôî Îì±Ïùò Î∂ÄÏûëÏö©ÎèÑ ÎÇòÌÉÄÎÇòÍ≥† ÏûàÏñ¥ Ïò¨Î∞îÎ•∏ ÏÇ¨Ïö©Î≤ïÏóê ÎåÄÌïú Í≥†ÎØºÏù¥ ÌïÑÏöîÌïú ÏãúÏ†êÏù¥Îã§.',
          options: [
            'Ïä§ÎßàÌä∏Ìè∞Ïùò Í∏∞Ïà†Ï†Å Î∞úÏ†Ñ',
            'Ïä§ÎßàÌä∏Ìè∞Ïù¥ ÌòÑÎåÄ ÏÇ¨ÌöåÏóê ÎØ∏ÏπòÎäî ÏòÅÌñ•',
            'Ïä§ÎßàÌä∏Ìè∞ Ï§ëÎèÖÏùò Ïã¨Í∞ÅÏÑ±',
            'Ïä§ÎßàÌä∏Ìè∞Ïùò Í≤ΩÏ†úÏ†Å Í∞ÄÏπò'
          ],
          correctAnswer: 1,
          explanation: 'Í∏Ä Ï†ÑÏ≤¥ÏóêÏÑú Ïä§ÎßàÌä∏Ìè∞Ïù¥ ÌòÑÎåÄ ÏÇ¨ÌöåÏóê ÎØ∏ÏπòÎäî Í∏çÏ†ïÏ†Å, Î∂ÄÏ†ïÏ†Å ÏòÅÌñ•ÏùÑ Ï¢ÖÌï©Ï†ÅÏúºÎ°ú Îã§Î£®Í≥† ÏûàÏäµÎãàÎã§.',
          points: 3
        },
        {
          id: 'q3',
          type: 'writing',
          section: 'writing',
          question: 'Îã§Ïùå Ï£ºÏ†úÏóê ÎåÄÌï¥ ÏûêÏã†Ïùò ÏùòÍ≤¨ÏùÑ Ïç®ÏÑú Ï†úÏ∂úÌïòÏã≠ÏãúÏò§. (200-300Ïûê)\n\nÏ£ºÏ†ú: "ÎåÄÌïôÏÉùÎì§Ïùò ÏïÑÎ•¥Î∞îÏù¥Ìä∏Ïóê ÎåÄÌïú Ï∞¨Î∞ò ÏùòÍ≤¨ÏùÑ Ïì∞Í≥†, Í∑∏ Ïù¥Ïú†Î•º ÏÑ§Î™ÖÌïòÏã≠ÏãúÏò§."',
          points: 10
        }
      ],
      totalPoints: 16
    }
  ];
  
  return sampleTests.map(test => ({
    params: { id: test.id },
    props: { test }
  }));
}

const { test } = Astro.props;
---

<TopikLayout 
  title={`${test.title} - L√†m b√†i thi`}
  description={`L√†m b√†i thi ${test.title} - ${test.description}`}
  showNavigation={false}
>
  
  <!-- Test Header -->
  <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex items-center justify-between">
        
        <!-- Test Info -->
        <div>
          <div class="flex items-center gap-3 mb-2">
            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
              <span class="text-xl">üéØ</span>
            </div>
            <div>
              <h1 class="text-2xl font-bold">{test.title}</h1>
              <p class="text-blue-100">{test.description}</p>
            </div>
          </div>
          
          <!-- Test Stats -->
          <div class="flex items-center gap-6 text-sm text-blue-100">
            <span>üìù {test.questions.length} c√¢u h·ªèi</span>
            <span>‚è±Ô∏è {test.duration} ph√∫t</span>
            <span>üéØ {test.totalPoints} ƒëi·ªÉm</span>
            <span class="px-2 py-1 bg-white/20 rounded">{test.level}</span>
          </div>
        </div>
        
        <!-- Timer Container -->
        <div class="timer-container">
          <TopikTimer 
            duration={test.duration}
            onTimeUp="handleTestTimeUp"
            showWarnings={true}
            autoSubmit={true}
            class="w-80"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Warning Banner -->
  <div class="bg-yellow-50 border-b border-yellow-200">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex items-center gap-3 text-yellow-800">
        <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <div class="text-sm">
          <span class="font-medium">‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng:</span>
          B√†i thi s·∫Ω t·ª± ƒë·ªông n·ªôp khi h·∫øt th·ªùi gian. H√£y ƒë·∫£m b·∫£o k·∫øt n·ªëi internet ·ªïn ƒë·ªãnh.
          Kh√¥ng t·∫£i l·∫°i trang ho·∫∑c ƒë√≥ng tr√¨nh duy·ªát trong qu√° tr√¨nh l√†m b√†i.
        </div>
      </div>
    </div>
  </div>

  <!-- Instructions Section -->
  <section class="py-8 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4">
      <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6" id="instructions-section">
        
        <!-- Instructions Header -->
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-900">üìã H∆∞·ªõng d·∫´n l√†m b√†i</h2>
          <button 
            id="start-test-btn"
            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-bold hover:from-green-700 hover:to-emerald-700 transition-all duration-200 shadow-lg"
          >
            üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i
          </button>
        </div>
        
        <!-- Instructions Content -->
        <div class="grid md:grid-cols-2 gap-8">
          
          <!-- General Instructions -->
          <div>
            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <span class="text-blue-600">üìù</span>
              H∆∞·ªõng d·∫´n chung
            </h3>
            <ul class="space-y-2 text-gray-700">
              <li class="flex items-start gap-2">
                <span class="text-green-600 mt-1">‚úì</span>
                <span>ƒê·ªçc k·ªπ t·ª´ng c√¢u h·ªèi tr∆∞·ªõc khi ch·ªçn ƒë√°p √°n</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-green-600 mt-1">‚úì</span>
                <span>C√≥ th·ªÉ chuy·ªÉn qua l·∫°i gi·ªØa c√°c c√¢u h·ªèi</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-green-600 mt-1">‚úì</span>
                <span>S·ª≠ d·ª•ng ch·ª©c nƒÉng ƒë√°nh d·∫•u cho c√¢u kh√≥</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-green-600 mt-1">‚úì</span>
                <span>Ki·ªÉm tra l·∫°i ƒë√°p √°n tr∆∞·ªõc khi n·ªôp b√†i</span>
              </li>
            </ul>
          </div>
          
          <!-- Technical Instructions -->
          <div>
            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
              <span class="text-purple-600">üîß</span>
              L∆∞u √Ω k·ªπ thu·∫≠t
            </h3>
            <ul class="space-y-2 text-gray-700">
              <li class="flex items-start gap-2">
                <span class="text-yellow-600 mt-1">‚ö†Ô∏è</span>
                <span>ƒê·∫£m b·∫£o k·∫øt n·ªëi internet ·ªïn ƒë·ªãnh</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-yellow-600 mt-1">‚ö†Ô∏è</span>
                <span>Kh√¥ng t·∫£i l·∫°i trang trong qu√° tr√¨nh thi</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-yellow-600 mt-1">‚ö†Ô∏è</span>
                <span>S·ª≠ d·ª•ng tr√¨nh duy·ªát hi·ªán ƒë·∫°i (Chrome, Firefox)</span>
              </li>
              <li class="flex items-start gap-2">
                <span class="text-yellow-600 mt-1">‚ö†Ô∏è</span>
                <span>B·∫≠t √¢m thanh cho c√°c c√¢u h·ªèi nghe</span>
              </li>
            </ul>
          </div>
        </div>
        
        <!-- Test Structure -->
        <div class="mt-8 pt-6 border-t border-gray-200">
          <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span class="text-orange-600">üìä</span>
            C·∫•u tr√∫c ƒë·ªÅ thi
          </h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {test.questions.filter(q => q.section === 'listening').length > 0 && (
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">üéß</span>
                  <span class="font-medium text-blue-900">Ph·∫ßn Nghe</span>
                </div>
                <div class="text-sm text-blue-700">
                  {test.questions.filter(q => q.section === 'listening').length} c√¢u h·ªèi
                </div>
              </div>
            )}
            
            {test.questions.filter(q => q.section === 'reading').length > 0 && (
              <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">üìñ</span>
                  <span class="font-medium text-green-900">Ph·∫ßn ƒê·ªçc</span>
                </div>
                <div class="text-sm text-green-700">
                  {test.questions.filter(q => q.section === 'reading').length} c√¢u h·ªèi
                </div>
              </div>
            )}
            
            {test.questions.filter(q => q.section === 'writing').length > 0 && (
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="text-xl">‚úçÔ∏è</span>
                  <span class="font-medium text-purple-900">Ph·∫ßn Vi·∫øt</span>
                </div>
                <div class="text-sm text-purple-700">
                  {test.questions.filter(q => q.section === 'writing').length} c√¢u h·ªèi
                </div>
              </div>
            )}
          </div>
        </div>
        
        <!-- Final Warning -->
        <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-red-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <div class="text-red-800">
              <div class="font-medium">‚ö†Ô∏è C·∫£nh b√°o quan tr·ªçng</div>
              <div class="text-sm mt-1">
                Sau khi b·∫Øt ƒë·∫ßu l√†m b√†i, b·∫°n kh√¥ng th·ªÉ t·∫°m d·ª´ng ho·∫∑c l√†m l·∫°i. 
                H√£y ƒë·∫£m b·∫£o b·∫°n ƒë√£ s·∫µn s√†ng v√† c√≥ ƒë·ªß th·ªùi gian ƒë·ªÉ ho√†n th√†nh b√†i thi.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quiz Section (Hidden initially) -->
  <section class="quiz-section hidden" id="quiz-section">
    <TopikQuiz test={test} />
  </section>

  <!-- Confirmation Modal -->
  <div class="confirmation-modal fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" id="confirmation-modal">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
      
      <!-- Modal Header -->
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-900">üöÄ X√°c nh·∫≠n b·∫Øt ƒë·∫ßu thi</h2>
      </div>
      
      <!-- Modal Content -->
      <div class="p-6">
        <p class="text-gray-700 mb-4">
          B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b·∫Øt ƒë·∫ßu l√†m b√†i thi kh√¥ng? 
          Sau khi b·∫Øt ƒë·∫ßu, th·ªùi gian s·∫Ω b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c v√† b·∫°n kh√¥ng th·ªÉ t·∫°m d·ª´ng.
        </p>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
          <div class="text-sm text-blue-800">
            <div class="font-medium">üìã Th√¥ng tin b√†i thi:</div>
            <div class="mt-1">
              ‚Ä¢ {test.questions.length} c√¢u h·ªèi<br>
              ‚Ä¢ {test.duration} ph√∫t<br>
              ‚Ä¢ {test.totalPoints} ƒëi·ªÉm t·ªëi ƒëa
            </div>
          </div>
        </div>
      </div>
      
      <!-- Modal Actions -->
      <div class="flex gap-3 p-6 border-t border-gray-200">
        <button 
          id="cancel-start"
          class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
        >
          ‚ùå H·ªßy
        </button>
        <button 
          id="confirm-start"
          class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-200 font-medium"
        >
          ‚úÖ B·∫Øt ƒë·∫ßu thi
        </button>
      </div>
    </div>
  </div>
</TopikLayout>

<style>
  /* Smooth transitions */
  .quiz-section {
    transition: all 0.3s ease;
  }
  
  .quiz-section.hidden {
    opacity: 0;
    pointer-events: none;
  }
  
  /* Timer adjustments for test page */
  .timer-container .timer-container {
    min-width: 320px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .timer-container {
      width: 100%;
      margin-top: 1rem;
    }
  }
</style>

<script define:vars={{ test }}>
  document.addEventListener('DOMContentLoaded', function() {
    const startTestBtn = document.getElementById('start-test-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    const cancelStart = document.getElementById('cancel-start');
    const confirmStart = document.getElementById('confirm-start');
    const instructionsSection = document.getElementById('instructions-section');
    const quizSection = document.getElementById('quiz-section');
    
    let testStarted = false;
    
    // Show confirmation modal
    if (startTestBtn) {
      startTestBtn.addEventListener('click', function() {
        confirmationModal?.classList.remove('hidden');
      });
    }
    
    // Cancel start
    if (cancelStart) {
      cancelStart.addEventListener('click', function() {
        confirmationModal?.classList.add('hidden');
      });
    }
    
    // Confirm start - begin test
    if (confirmStart) {
      confirmStart.addEventListener('click', function() {
        startTest();
        confirmationModal?.classList.add('hidden');
      });
    }
    
    // Start the actual test
    function startTest() {
      testStarted = true;
      
      // Hide instructions and show quiz
      if (instructionsSection) {
        instructionsSection.style.display = 'none';
      }
      
      if (quizSection) {
        quizSection.classList.remove('hidden');
      }
      
      // Update page title
      document.title = `ƒêang thi: ${test.title} - The Free Korean`;
      
      // Prevent leaving page
      window.addEventListener('beforeunload', handleBeforeUnload);
      
      // Track test start
      trackTestStart();
    }
    
    // Handle time up from timer
    window.handleTestTimeUp = function() {
      if (window.TopikQuiz && window.TopikQuiz.submitTest) {
        window.TopikQuiz.submitTest(true); // Auto submit
      } else {
        // Fallback if quiz not ready
        alert('‚è∞ H·∫øt th·ªùi gian! B√†i thi s·∫Ω ƒë∆∞·ª£c n·ªôp t·ª± ƒë·ªông.');
        window.location.href = `/topik/results/${test.id}?timeout=true`;
      }
    };
    
    // Prevent accidental page leave
    function handleBeforeUnload(e) {
      if (testStarted) {
        e.preventDefault();
        e.returnValue = 'B·∫°n ƒëang trong qu√° tr√¨nh l√†m b√†i thi. R·ªùi kh·ªèi trang s·∫Ω m·∫•t h·∫øt d·ªØ li·ªáu ƒë√£ l√†m.';
        return e.returnValue;
      }
    }
    
    // Track test start for analytics
    function trackTestStart() {
      const startData = {
        testId: test.id,
        startTime: new Date().toISOString(),
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`
      };
      
      // Store in localStorage for recovery
      localStorage.setItem(`topik_test_start_${test.id}`, JSON.stringify(startData));
      
      // Send to analytics if available
      if (window.gtag) {
        window.gtag('event', 'test_start', {
          test_id: test.id,
          test_title: test.title,
          test_duration: test.duration
        });
      }
    }
    
    // Auto-save functionality
    let autoSaveInterval;
    
    function startAutoSave() {
      autoSaveInterval = setInterval(() => {
        if (window.TopikQuiz && testStarted) {
          const answers = window.TopikQuiz.getAnswers();
          const markedQuestions = window.TopikQuiz.getMarkedQuestions();
          
          const saveData = {
            testId: test.id,
            answers: answers,
            markedQuestions: markedQuestions,
            lastSaved: new Date().toISOString(),
            timeLeft: window.TopikTimer ? window.TopikTimer.getTimeLeft() : null
          };
          
          localStorage.setItem(`topik_autosave_${test.id}`, JSON.stringify(saveData));
        }
      }, 30000); // Auto-save every 30 seconds
    }
    
    // Check for previous session
    function checkPreviousSession() {
      const savedData = localStorage.getItem(`topik_autosave_${test.id}`);
      if (savedData) {
        const data = JSON.parse(savedData);
        const timeDiff = new Date().getTime() - new Date(data.lastSaved).getTime();
        
        // If saved within last 2 hours, offer to resume
        if (timeDiff < 2 * 60 * 60 * 1000) {
          const resume = confirm(
            'üîÑ Ph√°t hi·ªán phi√™n l√†m b√†i tr∆∞·ªõc ƒë√≥.\n\n' +
            `L·∫ßn l∆∞u cu·ªëi: ${new Date(data.lastSaved).toLocaleString()}\n` +
            'B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c t·ª´ v·ªã tr√≠ ƒë√£ l∆∞u kh√¥ng?'
          );
          
          if (resume) {
            // Start test and restore data
            startTest();
            setTimeout(() => {
              if (window.TopikQuiz) {
                // Restore answers and marked questions
                Object.keys(data.answers).forEach(questionId => {
                  window.TopikQuiz.selectOption(questionId, data.answers[questionId]);
                });
                
                data.markedQuestions.forEach(questionId => {
                  // Mark questions (would need to implement in TopikQuiz)
                });
              }
            }, 1000);
          } else {
            // Clear saved data
            localStorage.removeItem(`topik_autosave_${test.id}`);
          }
        }
      }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (!testStarted) return;
      
      // Ctrl/Cmd + S to auto-save (prevent default save)
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        // Trigger manual save
        if (window.TopikQuiz) {
          const answers = window.TopikQuiz.getAnswers();
          console.log('Manual save triggered', answers);
        }
      }
      
      // ESC to show navigation
      if (e.key === 'Escape') {
        if (window.TopikQuiz) {
          document.getElementById('navigator-btn')?.click();
        }
      }
    });
    
    // Initialize
    checkPreviousSession();
    
    // Start auto-save when test begins
    document.addEventListener('testStarted', startAutoSave);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
      }
    });
    
    // Visual feedback for test status
    function updateTestStatus() {
      const favicon = document.querySelector('link[rel="icon"]');
      if (testStarted && favicon) {
        // Change favicon to indicate test in progress
        favicon.href = '/favicon-test.ico';
      }
    }
  });
</script> 