---
import TopikLayout from '../../../layouts/TopikLayout.astro';
import { readFileSync, readdirSync, statSync } from 'fs';
import { join, relative } from 'path';

export async function getStaticPaths() {
  const CONTENT_ROOT = join(process.cwd(), 'src', 'content', 'topik', 'on-luyen');
  const paths: { params: { slug: string } }[] = [];

  const walk = (dir: string) => {
    const entries = readdirSync(dir);
    for (const name of entries) {
      const full = join(dir, name);
      const s = statSync(full);
      if (s.isDirectory()) {
        walk(full);
      } else if (s.isFile() && name.endsWith('.json')) {
        const rel = relative(CONTENT_ROOT, full).replace(/\\/g, '/'); // windows safe
        const noExt = rel.replace(/\.json$/i, '');
        const slugRaw = noExt.split('/');
        const toNFC = (s: string) => (s && s.normalize ? s.normalize('NFC') : s);
        const toNFD = (s: string) => (s && s.normalize ? s.normalize('NFD') : s);
        const nfcArr = slugRaw.map(toNFC);
        const nfdArr = slugRaw.map(toNFD);
        const nfc = nfcArr.join('/');
        const nfd = nfdArr.join('/');
        paths.push({ params: { slug: nfc } });
        // Thêm biến thể NFD để trình duyệt decode khác normalize vẫn match
        if (nfd !== nfc) {
          paths.push({ params: { slug: nfd } });
        }
        console.log('[on-luyen:getStaticPaths] add:', { rel, nfc, nfd });
        console.log('[on-luyen:getStaticPaths] add:', { rel, nfc, nfd });
      }
    }
  };

  try {
    walk(CONTENT_ROOT);
  } catch (e) {
    // ignore, may not exist yet
    console.warn('[on-luyen:getStaticPaths] content root not found:', CONTENT_ROOT);
  }

  console.log('[on-luyen:getStaticPaths] total paths:', paths.length);
  return paths;
}

interface Params {
  slug: string | string[]; // catch-all
}

const { slug } = Astro.params as unknown as Params;

let data: any = null;
let notFound = false;
const CONTENT_ROOT = join(process.cwd(), 'src', 'content', 'topik', 'on-luyen');

// Chuẩn hóa slug để tránh vấn đề Unicode (NFC/NFD) và thử nhiều cách đọc
const slugRawValue = Array.isArray(slug) ? slug.join('/') : String(slug ?? '');
const slugArr = slugRawValue.split('/').filter(Boolean);
const slugNFC = slugArr.map((s) => s.normalize ? s.normalize('NFC') : s);

try {
  const filePath = join(CONTENT_ROOT, ...slugNFC) + '.json';
  const content = readFileSync(filePath, 'utf-8');
  data = JSON.parse(content);
} catch (e1) {
  try {
    const filePath2 = join(CONTENT_ROOT, ...slugArr) + '.json';
    const content2 = readFileSync(filePath2, 'utf-8');
    data = JSON.parse(content2);
  } catch (e2) {
    try {
      const slugNFD = slugArr.map((s) => s.normalize ? s.normalize('NFD') : s);
      const filePath3 = join(CONTENT_ROOT, ...slugNFD) + '.json';
      const content3 = readFileSync(filePath3, 'utf-8');
      data = JSON.parse(content3);
    } catch (e3) {
      notFound = true;
    }
  }
}

const meta = (data && data.meta) ? data.meta : {};
const pageTitle = (meta.title || data?.title || (Array.isArray(slug) ? slug[slug.length - 1] : String(slug)) || 'Ôn luyện');
const pageDesc = (meta.description || data?.description || 'Nội dung ôn luyện TOPIK');
const level = meta.level || data?.level || '';
const type = meta.type || data?.type || '';

let sections: any[] = Array.isArray(data?.sections) ? data.sections : [];
if ((!sections || sections.length === 0) && data && data.groups) {
  sections = data.groups;
}
---

<TopikLayout 
  title={`${pageTitle}`}
  description={pageDesc}
>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <a 
      href="/topik/on-luyen"
      class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-6 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span>Quay lại Ôn luyện</span>
    </a>

    {notFound ? (
      <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
        <div class="text-red-700 font-semibold mb-1">Không tìm thấy nội dung</div>
        <div class="text-red-700">Vui lòng kiểm tra lại đường dẫn hoặc thêm file JSON phù hợp trong <code class="bg-white px-1 py-0.5 rounded border">src/content/topik/on-luyen/**.json</code>.</div>
      </div>
    ) : (
      <>
        <div class="mb-6">
          <h1 class="text-3xl font-bold text-gray-900">{pageTitle}</h1>
          <p class="text-gray-600 mt-2">{pageDesc}</p>
          <div class="flex items-center gap-3 mt-3 flex-wrap">
            {type && <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">{type}</span>}
            {level && <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">{level}</span>}
            {Array.isArray(sections) && sections.length > 0 && (
              <span class="text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded">
                {sections.reduce(
                  (n: number, s: any) => n + (Array.isArray(s?.items) ? s.items.length : 0),
                  0
                )}{' '}
                mục
              </span>
            )}
          </div>
        </div>

        <div class="space-y-4">
          {Array.isArray(data?.questions) || Array.isArray(data?.items) ? (
            <>
              {(Array.isArray(data?.questions) ? data.questions : data.items).map((item: any, idx: number) => (
                <div class="border-2 border-gray-200 rounded-lg p-4 bg-white">
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1">
                      <div class="font-semibold text-gray-900 mb-1">Mục {idx + 1}</div>
                      {item?.question && <div class="text-gray-800">{item.question}</div>}
                      {item?.text && !item?.question && <div class="text-gray-800">{item.text}</div>}
                      {Array.isArray(item?.choices) && item.choices.length > 0 && (
                        <ul class="list-disc pl-5 mt-2 text-gray-700 space-y-1">
                          {item.choices.map((c: any) => (<li>{typeof c === 'string' ? c : (c?.text ?? JSON.stringify(c))}</li>))}
                        </ul>
                      )}
                    </div>
                    <span class="text-gray-400">#{idx + 1}</span>
                  </div>
                </div>
              ))}
            </>
          ) : (
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
              <div class="text-gray-800 font-medium mb-1">Chưa có danh sách mục để hiển thị</div>
              <div class="text-gray-700 text-sm">Sau khi bạn chốt cấu trúc JSON, mình sẽ cập nhật renderer chi tiết.</div>
            </div>
          )}
        </div>
      </>
    )}
  </div>
</TopikLayout>


