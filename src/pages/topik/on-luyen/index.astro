---
import TopikLayout from '../../../layouts/TopikLayout.astro';
import { readdirSync, readFileSync, statSync } from 'fs';
import { join, relative } from 'path';

// Đọc tất cả file JSON trong thư mục on-luyen
const contentRoot = join(process.cwd(), 'src', 'content', 'topik', 'on-luyen');
let items: any[] = [];

try {
  const files: string[] = [];
  const walk = (dir: string) => {
    const entries = readdirSync(dir);
    for (const name of entries) {
      const full = join(dir, name);
      const s = statSync(full);
      if (s.isDirectory()) {
        walk(full);
      } else if (s.isFile() && name.endsWith('.json')) {
        files.push(full);
      }
    }
  };
  walk(contentRoot);

  const mapped = files
	.map((absPath: string) => {
	  try {
		const content = readFileSync(absPath, 'utf-8');
		const data = JSON.parse(content);
		const rel = relative(contentRoot, absPath).replace(/\\/g, '/'); // windows safe
		const slugPath = rel.replace(/\.json$/i, '');
		const slugParts = slugPath.split('/');
		const slugUrl = slugParts.join('/');

		const meta = data.meta || {};
		const page = meta.page || data.page || null;
		const href = page
		  ? `/topik/on-luyen/${page}${page.endsWith('/') ? '' : '/'}`
		  : '/topik/on-luyen/' + slugParts.map((s) => encodeURIComponent(s)).join('/') + '/';

		return {
		  slug: slugUrl,
		  href,
		  page,
		  title: meta.title || data.title || slugParts[slugParts.length - 1],
		  description: meta.description || data.description || '',
		  level: meta.level || data.level || '',
		  type: meta.type || data.type || '',
		  count: Array.isArray(data.questions) ? data.questions.length : (Array.isArray(data.items) ? data.items.length : (Array.isArray(data.sections) ? data.sections.reduce((n: number, s: any) => n + (Array.isArray(s?.items) ? s.items.length : 0), 0) : null))
		};
	  } catch (error) {
		console.error(`Error reading ${absPath}:`, error);
		return null;
	  }
	})
	.filter(Boolean);

  const merged = new Map<string, any>();
  mapped.forEach((item: any) => {
	if (!item) return;
	const existing = merged.get(item.href);
	if (existing) {
	  const currentCount = typeof existing.count === 'number' ? existing.count : 0;
	  const addCount = typeof item.count === 'number' ? item.count : 0;
	  existing.count = currentCount + addCount;
	  existing.children = [...(existing.children || []), item];
	} else {
	  merged.set(item.href, { ...item, children: [item] });
	}
  });

  items = Array.from(merged.values()).sort((a: any, b: any) => a.title.localeCompare(b.title));
} catch (error) {
  // Thư mục có thể chưa tồn tại ở lần đầu
  items = [];
}
---

<TopikLayout 
  title="Ôn luyện TOPIK"
  description="Danh sách nội dung ôn luyện TOPIK"
>
  <div class="max-w-7xl mx-auto px-4 py-12">
    <a 
      href="/topik"
      class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-6 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span>Quay lại trang TOPIK</span>
    </a>

    <div class="text-center mb-10">
      <h1 class="text-4xl font-bold text-gray-900 mb-3">
        Ôn luyện TOPIK
      </h1>
      <p class="text-lg text-gray-600">
        Chọn một mục bên dưới để bắt đầu ôn luyện theo nội dung đã chuẩn bị.
      </p>
    </div>

    {items.length === 0 ? (
      <div class="max-w-3xl mx-auto bg-yellow-50 border-2 border-yellow-200 rounded-xl p-8 text-center">
        <p class="text-gray-700 mb-2">Chưa có nội dung trong mục Ôn luyện.</p>
        <p class="text-gray-600">
          Thêm các file <code class="bg-gray-100 px-2 py-1 rounded">.json</code> vào thư mục 
          <code class="bg-gray-100 px-2 py-1 rounded ml-1">src/content/topik/on-luyen/</code>.
        </p>
      </div>
    ) : (
      <div class="max-w-3xl mx-auto space-y-4">
        {items.map((it) => (
          <a 
            href={it.href}
            class="block p-5 border-2 border-gray-200 rounded-lg bg-white hover:border-amber-400 hover:bg-amber-50 transition-all duration-200"
          >
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="text-lg font-semibold text-gray-900">{it.title}</div>
                {it.description && (
                  <p class="text-gray-600 text-sm mt-1">{it.description}</p>
                )}
                <div class="flex items-center gap-3 mt-2 flex-wrap">
                  {it.type && <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">{it.type}</span>}
                  {it.level && <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">{it.level}</span>}
                  {it.count !== null && <span class="text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded">{it.count} mục</span>}
                </div>
              </div>
              <svg class="w-5 h-5 text-gray-400 ml-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    )}
  </div>
</TopikLayout>


