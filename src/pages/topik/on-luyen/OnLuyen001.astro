---
import TopikLayout from '../../../layouts/TopikLayout.astro';
import OnLuyen001 from '../../../components/topik/OnLuyen001.astro';
import readingDang1 from '../../../content/topik/on-luyen/on-luyen-001/reading-dang-1-고객센터.json';

const lessons = [
  {
    slug: 'reading-dang-1-고객센터',
    data: readingDang1
  }
];

const meta = lessons[0]?.data?.meta || {};
const pageTitle = meta.title || 'Ôn luyện 001';
const pageDesc = meta.description || 'Bộ bài tập Ôn luyện 001';

// Lấy categories trực tiếp từ data (cấu trúc mới)
const categories = lessons[0]?.data?.categories || [];

// Hàm flatten dữ liệu từ cấu trúc categories -> functionalGroups -> sections (để tương thích với cấu trúc cũ)
function flattenSections(data: any): any[] {
  // Nếu có sections trực tiếp (cấu trúc cũ)
  if (Array.isArray(data?.sections) && data.sections.length > 0) {
    return data.sections;
  }
  
  // Nếu có categories (cấu trúc mới)
  if (Array.isArray(data?.categories) && data.categories.length > 0) {
    const sections: any[] = [];
    data.categories.forEach((category: any) => {
      if (Array.isArray(category?.functionalGroups)) {
        category.functionalGroups.forEach((group: any) => {
          if (Array.isArray(group?.sections)) {
            // Thêm tất cả sections từ group vào mảng
            sections.push(...group.sections);
          }
        });
      }
    });
    return sections;
  }
  
  return [];
}

const sections = categories.length > 0 ? [] : flattenSections(lessons[0]?.data);
---

<TopikLayout title={pageTitle} description={pageDesc}>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <a 
      href="/topik/on-luyen"
      class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-6 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      <span>Quay lại Ôn luyện</span>
    </a>

    <header class="mb-10 text-center">
      <h1 class="text-4xl font-bold text-gray-900 mb-3">{pageTitle}</h1>
      <p class="text-lg text-gray-600">{pageDesc}</p>
      <div class="flex items-center justify-center gap-3 mt-4 flex-wrap">
        {meta?.level && <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded">{meta.level}</span>}
        {meta?.component && <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">{meta.component}</span>}
      </div>
    </header>

    <section>
      {categories.length > 0 ? (
        <OnLuyen001 categories={categories} />
      ) : sections.length > 0 ? (
        <OnLuyen001 sections={sections} />
      ) : (
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
          <div class="text-gray-800 font-medium mb-1">Chưa có dữ liệu</div>
          <div class="text-gray-700 text-sm">Thêm các mục vào nội dung JSON để hiển thị ở đây.</div>
        </div>
      )}
    </section>
  </div>
</TopikLayout>


