---
import { getCollection } from 'astro:content';
import GrammarLayout from '../layouts/GrammarLayout.astro';
import GrammarCard from '../components/grammar/GrammarCard.astro';
import GrammarSidebar from '../components/grammar/GrammarSidebar.astro';
import '../styles/global.css';

/**
 * Grammar List Page
 * 
 * Displays all grammar points in a searchable, filterable grid.
 * 
 * Features:
 * - Hero filters (Level tabs)
 * - Text search (Client-side)
 * - Grid/List view toggle
 * - Responsive layout with Sidebar
 */

// 1. Fetch Data
const allGrammarRaw = await getCollection('grammar');

// 2. Filter & Sort
const allGrammar = allGrammarRaw.filter(entry => {
  return !entry.slug.endsWith('-draft') && 
         !entry.slug.endsWith('-original'); // Ensure clean list
});

const sortedGrammar = allGrammar.sort((a, b) => {
  // Sort by Level first, then Order
  const levelOrder = { beginner: 1, intermediate: 2, advanced: 3 };
  if (levelOrder[a.data.level] !== levelOrder[b.data.level]) {
    return levelOrder[a.data.level] - levelOrder[b.data.level];
  }
  return a.data.order - b.data.order;
});

const totalCount = sortedGrammar.length;
const bgCount = sortedGrammar.filter(g => g.data.level === 'beginner').length;
const intCount = sortedGrammar.filter(g => g.data.level === 'intermediate').length;
const advCount = sortedGrammar.filter(g => g.data.level === 'advanced').length;
---

<GrammarLayout title="Th∆∞ vi·ªán Ng·ªØ ph√°p - The Free Korean">
  
  <!-- Mobile Overlay (Managed by Page Script) -->
  <div id="mobile-panel-overlay" class="fixed inset-0 bg-black/50 z-20 opacity-0 pointer-events-none transition-opacity duration-300" aria-hidden="true"></div>

  <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col lg:flex-row gap-8 relative items-start">
      
      <!-- Left Sidebar (Desktop) -->
      <aside class="hidden lg:block shrink-0 sticky top-24">
        <GrammarSidebar />
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 min-w-0">
        
        <!-- Mobile Header & Toggle -->
        <div class="lg:hidden mb-6 flex items-center justify-between p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
           <div>
             <h1 class="font-bold text-slate-800 text-lg">Ng·ªØ ph√°p</h1>
             <p class="text-xs text-slate-500">{totalCount} c√¥ng th·ª©c</p>
           </div>
           <button id="mobile-sidebar-trigger" class="px-4 py-2 bg-indigo-50 text-indigo-700 font-medium rounded-lg text-sm hover:bg-indigo-100 transition-colors">
             M·ª•c l·ª•c
           </button>
        </div>

        <!-- Hero / Filter Section -->
        <div class="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-3xl p-6 sm:p-10 text-white mb-8 shadow-lg relative overflow-hidden">
          <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
          
          <div class="relative z-10 w-full max-w-3xl">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-4 tracking-tight">
              Th∆∞ vi·ªán Ng·ªØ ph√°p
            </h1>
            <p class="text-indigo-100 text-lg mb-8 max-w-xl leading-relaxed">
              T·ªïng h·ª£p {totalCount} ng·ªØ ph√°p ti·∫øng H√†n ƒë∆∞·ª£c ph√¢n lo·∫°i chi ti·∫øt. Tra c·ª©u nhanh ch√≥ng, gi·∫£i th√≠ch d·ªÖ hi·ªÉu.
            </p>

            <!-- Search Bar -->
            <div class="relative max-w-xl group">
              <input 
                type="text" 
                id="main-search-input"
                placeholder="T√¨m ki·∫øm ng·ªØ ph√°p (v√≠ d·ª•: ƒëang, s·∫Ω, v√¨...)" 
                class="w-full pl-12 pr-4 py-4 rounded-xl bg-white/10 backdrop-blur-md border border-white/20 text-white placeholder:text-indigo-200 focus:bg-white focus:text-slate-900 focus:placeholder:text-slate-400 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transition-all shadow-xl"
              />
              <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-indigo-200 group-focus-within:text-indigo-500 transition-colors pointer-events-none type-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                 <circle cx="11" cy="11" r="8"></circle>
                 <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6 sticky top-20 z-10 py-2 sm:py-0 bg-slate-50/95 backdrop-blur sm:bg-transparent sm:backdrop-blur-none sm:static">
          
          <!-- Level Filters -->
          <div class="flex items-center gap-2 overflow-x-auto pb-2 sm:pb-0 w-full sm:w-auto no-scrollbar" id="level-filters">
            <button 
              class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap bg-white border border-slate-200 text-slate-600 hover:border-indigo-300 hover:text-indigo-600 active" 
              data-filter="all"
            >
              T·∫•t c·∫£ <span class="ml-1 text-xs opacity-60 bg-slate-100 px-1.5 py-0.5 rounded-full">{totalCount}</span>
            </button>
            
            <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap bg-white border border-slate-200 text-slate-600 hover:border-emerald-300 hover:text-emerald-600" data-filter="beginner">
              S∆° c·∫•p <span class="ml-1 text-xs opacity-60 bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded-full">{bgCount}</span>
            </button>
            
            <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap bg-white border border-slate-200 text-slate-600 hover:border-amber-300 hover:text-amber-600" data-filter="intermediate">
              Trung c·∫•p <span class="ml-1 text-xs opacity-60 bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded-full">{intCount}</span>
            </button>
            
            <button class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap bg-white border border-slate-200 text-slate-600 hover:border-rose-300 hover:text-rose-600" data-filter="advanced">
              Cao c·∫•p <span class="ml-1 text-xs opacity-60 bg-rose-50 text-rose-600 px-1.5 py-0.5 rounded-full">{advCount}</span>
            </button>
          </div>

          <!-- View Toggle (Desktop only) -->
          <div class="hidden sm:flex bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
            <button class="view-btn p-1.5 rounded text-slate-400 hover:text-indigo-600 active-view" data-view="grid" title="L∆∞·ªõi">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            </button>
            <button class="view-btn p-1.5 rounded text-slate-400 hover:text-indigo-600" data-view="list" title="Danh s√°ch">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
          </div>

        </div>

        <!-- Search Results Count -->
        <div id="search-stats" class="hidden mb-4 text-sm text-slate-500 font-medium px-1">
          T√¨m th·∫•y <span id="search-count" class="text-indigo-600 font-bold">0</span> k·∫øt qu·∫£
        </div>

        <!-- Grid Container -->
        <div id="grammar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5 pb-10">
          {sortedGrammar.map((entry) => (
            <div 
              class="grammar-card-wrapper transition-all duration-300" 
              data-level={entry.data.level}
              data-title={entry.data.title.toLowerCase()}
              data-meaning={entry.data.meaning.toLowerCase()}
              data-tags={entry.data.tags?.join(' ').toLowerCase() || ''}
            >
              <GrammarCard 
                title={entry.data.title}
                meaning={entry.data.meaning}
                level={entry.data.level}
                slug={entry.slug}
                href={`/grammar/${entry.data.level}/${entry.slug}`}
                tags={entry.data.tags}
              />
            </div>
          ))}
        </div>

        <!-- Empty State -->
        <div id="main-empty-state" class="hidden flex-col items-center justify-center py-20 text-center">
            <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center text-4xl mb-4">
                ü§î
            </div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o</h3>
            <p class="text-slate-500 max-w-sm mx-auto">
                Kh√¥ng c√≥ ng·ªØ ph√°p n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc ho·∫∑c t·ª´ kho√° t√¨m ki·∫øm c·ªßa b·∫°n. H√£y th·ª≠ l·∫°i xem!
            </p>
            <button id="reset-filters" class="mt-6 px-6 py-2 bg-white border border-slate-300 rounded-lg text-slate-600 font-medium hover:border-indigo-500 hover:text-indigo-600 transition-colors shadow-sm">
                Xo√° b·ªô l·ªçc
            </button>
        </div>

      </main>
    </div>
  </div>

  <!-- Mobile Sidebar Container (For list page too) -->
  <div class="lg:hidden">
    <GrammarSidebar />
  </div>

</GrammarLayout>

<style>
  /* Active filter button styles */
  .filter-btn.active {
    background-color: #3b82f6; /* Indigo-500ish fallback */
    color: white;
    border-color: #3b82f6;
  }
  .filter-btn.active span {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
  }
  
  /* Filter specific active colors */
  .filter-btn[data-filter="beginner"].active { background-color: #059669; border-color: #059669; } /* Emerald */
  .filter-btn[data-filter="intermediate"].active { background-color: #d97706; border-color: #d97706; } /* Amber */
  .filter-btn[data-filter="advanced"].active { background-color: #e11d48; border-color: #e11d48; } /* Rose */

  /* View switch active */
  .view-btn.active-view {
    background-color: #eff6ff;
    color: #4f46e5;
  }

  /* List view transforms grid */
  :global(#grammar-grid.list-view) {
    grid-template-columns: 1fr !important;
  }
</style>

<script>
  /**
   * Main Grammar List Logic
   * Handles filtering, searching, and UI interactions.
   */

  document.addEventListener('DOMContentLoaded', () => {
    // --- Elements ---
    const grid = document.getElementById('grammar-grid');
    const cards = document.querySelectorAll('.grammar-card-wrapper');
    const searchInput = document.getElementById('main-search-input') as HTMLInputElement;
    const filterBtns = document.querySelectorAll('.filter-btn');
    const viewBtns = document.querySelectorAll('.view-btn');
    const emptyState = document.getElementById('main-empty-state');
    const searchStats = document.getElementById('search-stats');
    const searchCount = document.getElementById('search-count');
    const resetBtn = document.getElementById('reset-filters');
    const typeIcon = document.querySelector('.type-icon');

    // State
    let currentFilter = 'all';
    let searchQuery = '';

    // --- 1. Filtering Logic ---
    function applyFilters() {
      let visibleCount = 0;
      
      cards.forEach(card => {
        const el = card as HTMLElement;
        const level = el.dataset.level;
        const title = el.dataset.title || '';
        const meaning = el.dataset.meaning || '';
        const tags = el.dataset.tags || '';
        
        // 1. Check Level Filter
        const matchesLevel = currentFilter === 'all' || level === currentFilter;
        
        // 2. Check Search (Normalized)
        const normalize = (s: string) => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const query = normalize(searchQuery);
        const matchesSearch = !searchQuery || 
                              normalize(title).includes(query) || 
                              normalize(meaning).includes(query) || 
                              normalize(tags).includes(query);

        if (matchesLevel && matchesSearch) {
          el.style.display = ''; // Show
          visibleCount++;
        } else {
          el.style.display = 'none'; // Hide
        }
      });

      // Update UI Stats
      if (visibleCount === 0) {
        grid?.classList.add('hidden');
        emptyState?.classList.remove('hidden');
        emptyState?.classList.add('flex');
        searchStats?.classList.add('hidden');
      } else {
        grid?.classList.remove('hidden');
        emptyState?.classList.add('hidden');
        emptyState?.classList.remove('flex');
        
        // Show stats only if searching
        if (searchQuery) {
          searchStats?.classList.remove('hidden');
          if (searchCount) searchCount.textContent = visibleCount.toString();
        } else {
          searchStats?.classList.add('hidden');
        }
      }
    }

    // --- 2. Event Listeners ---
    
    // Filter Buttons
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active state
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update State & Apply
        currentFilter = btn.getAttribute('data-filter') || 'all';
        applyFilters();
      });
    });

    // Search Input
    searchInput.addEventListener('input', (e) => {
      searchQuery = (e.target as HTMLInputElement).value.trim();
      
      // Visual feedback on icon
      if (typeIcon) {
          typeIcon.classList.toggle('text-indigo-500', searchQuery.length > 0);
          typeIcon.classList.toggle('text-indigo-200', searchQuery.length === 0);
      }
      
      applyFilters();
    });

    // Reset Button
    resetBtn?.addEventListener('click', () => {
      currentFilter = 'all';
      searchQuery = '';
      if (searchInput) searchInput.value = '';
      
      filterBtns.forEach(b => {
        if (b.getAttribute('data-filter') === 'all') b.classList.add('active');
        else b.classList.remove('active');
      });
      
      applyFilters();
    });

    // View Toggle
    viewBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.getAttribute('data-view');
        
        viewBtns.forEach(b => b.classList.remove('active-view'));
        btn.classList.add('active-view');
        
        if (view === 'list') {
          grid?.classList.add('list-view');
        } else {
          grid?.classList.remove('list-view');
        }
      });
    });

    // --- 3. Mobile Sidebar Overlay Integration ---
    // Re-implementing the overlay logic specifically for this page structure
    const mobileOverlay = document.getElementById('mobile-panel-overlay');
    const mobileTrigger = document.getElementById('mobile-sidebar-trigger');
    const sidebarElement = document.getElementById('grammar-sidebar');

    const toggleSidebar = (show: boolean) => {
      if (!sidebarElement) return;
      
      if (show) {
        sidebarElement.classList.add('open');
        mobileOverlay?.classList.remove('opacity-0', 'pointer-events-none');
        mobileOverlay?.classList.add('opacity-100', 'pointer-events-auto');
        document.body.style.overflow = 'hidden';
      } else {
        sidebarElement.classList.remove('open');
        mobileOverlay?.classList.add('opacity-0', 'pointer-events-none');
        mobileOverlay?.classList.remove('opacity-100', 'pointer-events-auto');
        document.body.style.overflow = '';
      }
    };

    mobileTrigger?.addEventListener('click', () => toggleSidebar(true));
    mobileOverlay?.addEventListener('click', () => toggleSidebar(false));

    // Listen to sidebar's internal close events (from GrammarSidebar.astro script)
    window.addEventListener('tfk:panel-state-change', () => {
        // Just sync overlay state with sidebar class
        const isOpen = sidebarElement?.classList.contains('open');
        if (isOpen) {
            mobileOverlay?.classList.remove('opacity-0', 'pointer-events-none');
            mobileOverlay?.classList.add('opacity-100', 'pointer-events-auto');
            document.body.style.overflow = 'hidden';
        } else {
            mobileOverlay?.classList.add('opacity-0', 'pointer-events-none');
            mobileOverlay?.classList.remove('opacity-100', 'pointer-events-auto');
            document.body.style.overflow = '';
        }
    });

  });
</script>
