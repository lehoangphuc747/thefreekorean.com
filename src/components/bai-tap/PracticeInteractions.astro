---
interface Props {
  sectionCount: number;
  section2Answers: Record<string, string>;
  section3Answers: Record<string, string>;
  section5Answers: Record<string, string>;
}

const { sectionCount, section2Answers, section3Answers, section5Answers } = Astro.props as Props;
const section2AnswerJson = JSON.stringify(section2Answers);
const section3AnswerJson = JSON.stringify(section3Answers);
const section5AnswerJson = JSON.stringify(section5Answers);
const section2AnswersEncoded = encodeURIComponent(section2AnswerJson);
const section3AnswersEncoded = encodeURIComponent(section3AnswerJson);
const section5AnswersEncoded = encodeURIComponent(section5AnswerJson);
---

<script
  data-section-count={sectionCount}
  data-s2-answers={section2AnswersEncoded}
  data-s3-answers={section3AnswersEncoded}
  data-s5-answers={section5AnswersEncoded}
>
  // @ts-ignore - Script functions need to be available globally for onclick handlers
  let completedSections = new Set();
  let currentSection = 1;
  const scriptEl = document.currentScript as HTMLScriptElement | null;
  const TOTAL_SECTIONS = Number(scriptEl?.dataset.sectionCount || 0);
  const parseAnswers = (key: 's2Answers' | 's3Answers' | 's5Answers') => {
    const raw = scriptEl?.dataset[key];
    if (!raw) return {};
    try {
      return JSON.parse(decodeURIComponent(raw));
    } catch (error) {
      console.warn(`KhÃ´ng thá»ƒ parse dá»¯ liá»‡u ${key}:`, error);
      return {};
    }
  };
  const s2Answers = parseAnswers('s2Answers');
  const s3Answers = parseAnswers('s3Answers');
  const s5Answers = parseAnswers('s5Answers');

  document.addEventListener('DOMContentLoaded', () => {
    window.updateProgress();
    window.showSection(1);
  });

  window.showSection = function (sectionNum) {
    document.querySelectorAll('.section-content').forEach((section) => {
      section.classList.add('hidden');
    });

    const section = document.getElementById(`section-${sectionNum}`);
    if (section) {
      section.classList.remove('hidden');
      currentSection = sectionNum;
    }

    document.querySelectorAll('.section-btn').forEach((btn, idx) => {
      const btnSection = idx + 1;
      const btnElement = btn;
      btn.classList.remove('active', 'completed');
      if (btnSection === sectionNum) {
        btn.classList.add('active');
      }
      if (completedSections.has(btnSection)) {
        btn.classList.add('completed');
      }
      if (btnSection <= sectionNum || completedSections.has(btnSection - 1)) {
        btnElement.disabled = false;
      } else {
        btnElement.disabled = true;
      }
    });
  };

  window.completeSection = function (sectionNum) {
    completedSections.add(sectionNum);
    window.updateProgress();

    const nextBtn = document.querySelector(`[data-section="${sectionNum + 1}"]`);
    if (nextBtn) {
      nextBtn.disabled = false;
      nextBtn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
    }

    alert(`Section ${sectionNum} hoÃ n thÃ nh! Section ${sectionNum + 1} Ä‘Ã£ Ä‘Æ°á»£c má»Ÿ khÃ³a.`);

    if (sectionNum < TOTAL_SECTIONS) {
      window.showSection(sectionNum + 1);
    }
  };

  window.updateProgress = function () {
    const progress = (completedSections.size / TOTAL_SECTIONS) * 100;
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    if (progressBar) {
      progressBar.style.width = `${progress}%`;
    }
    if (progressText) {
      progressText.textContent = `${completedSections.size}/${TOTAL_SECTIONS} sections`;
    }
  };

  window.toggleCard = function (cardNum) {
    const cards = document.querySelectorAll('.flashcard');
    if (cardNum - 1 >= cards.length) return;

    const card = cards[cardNum - 1];
    const front = card.querySelector(`.card-front-${cardNum}`);
    const back = card.querySelector(`.card-back-${cardNum}`);
    const showBtn = card.querySelector(`.card-show-${cardNum}`);
    const hideBtn = card.querySelector(`.card-hide-${cardNum}`);

    if (!front || !back || !showBtn || !hideBtn) return;

    if (back.classList.contains('hidden')) {
      front.classList.add('hidden');
      back.classList.remove('hidden');
      showBtn.classList.add('hidden');
      hideBtn.classList.remove('hidden');
    } else {
      front.classList.remove('hidden');
      back.classList.add('hidden');
      showBtn.classList.remove('hidden');
      hideBtn.classList.add('hidden');
    }
  };

  window.checkSection2 = function () {
    let correct = 0;
    Object.keys(s2Answers).forEach((qId) => {
      const selected = document.querySelector(`input[name="${qId}"]:checked`);
      if (!selected) return;

      const questionDiv = selected.closest('.question-item');
      const feedbackDiv = questionDiv?.querySelector('.answer-feedback');
      const feedbackInner = feedbackDiv?.querySelector('div');
      const feedbackText = feedbackDiv?.querySelector('p');

      if (selected && feedbackDiv && feedbackInner) {
        feedbackDiv.classList.remove('hidden');
        if (selected.value === s2Answers[qId]) {
          correct++;
          feedbackInner.classList.remove('bg-red-50', 'border-red-200');
          feedbackInner.classList.add('bg-green-50', 'border-green-200');
        } else {
          feedbackInner.classList.remove('bg-green-50', 'border-green-200');
          feedbackInner.classList.add('bg-red-50', 'border-red-200');
          if (feedbackText) {
            feedbackText.textContent = `âœ— Sai. ÄÃ¡p Ã¡n Ä‘Ãºng: ${s2Answers[qId]}`;
          }
        }
      }
    });

    alert(`Báº¡n Ä‘Ã£ tráº£ lá»i Ä‘Ãºng ${correct}/3 cÃ¢u. ${correct >= 2 ? 'Tá»‘t láº¯m!' : 'HÃ£y xem láº¡i giáº£i thÃ­ch.'}`);
  };

  window.checkFillBlank = function (inputName, correctAnswer) {
    const input = document.querySelector(`input[name="${inputName}"]`);
    if (!input) return;

    const questionDiv = input.closest('.question-item');
    const feedbackDiv = questionDiv?.querySelector('.answer-feedback');
    const feedbackInner = feedbackDiv?.querySelector('div');
    const feedbackText = feedbackDiv?.querySelector('p');

    if (!questionDiv || !feedbackDiv || !feedbackInner) return;

    if (input.value.trim() === correctAnswer) {
      input.classList.remove('border-red-500');
      input.classList.add('border-green-500');
      feedbackDiv.classList.remove('hidden');
      feedbackInner.classList.remove('bg-red-50', 'border-red-200');
      feedbackInner.classList.add('bg-green-50', 'border-green-200');
    } else {
      input.classList.remove('border-green-500');
      input.classList.add('border-red-500');
      feedbackDiv.classList.remove('hidden');
      feedbackInner.classList.remove('bg-green-50', 'border-green-200');
      feedbackInner.classList.add('bg-red-50', 'border-red-200');
      if (feedbackText) {
        feedbackText.textContent = `âœ— Sai. ÄÃ¡p Ã¡n Ä‘Ãºng: ${correctAnswer}`;
      }
    }
  };

  window.checkAllSection3 = function () {
    let correct = 0;
    let total = 0;

    Object.keys(s3Answers).forEach((qId) => {
      const input = document.querySelector(`input[name="${qId}"]`);
      if (input && input.value.trim()) {
        total++;
        if (input.value.trim() === s3Answers[qId]) {
          correct++;
        }
        window.checkFillBlank(qId, s3Answers[qId]);
      }
    });

    const scoreDiv = document.getElementById('s3-score');
    if (scoreDiv) {
      scoreDiv.classList.remove('hidden');
      const percentage = Math.round((correct / total) * 100);
      scoreDiv.innerHTML = `<strong class="${percentage >= 70 ? 'text-green-600' : 'text-red-600'}">Äiá»ƒm: ${correct}/${total} (${percentage}%)</strong>`;
      if (percentage >= 70) {
        scoreDiv.innerHTML += '<p class="text-sm text-green-600 mt-1">âœ“ Äáº¡t yÃªu cáº§u Ä‘á»ƒ tiáº¿p tá»¥c!</p>';
      } else {
        scoreDiv.innerHTML += '<p class="text-sm text-red-600 mt-1">HÃ£y xem láº¡i vÃ  lÃ m láº¡i pháº§n nÃ y.</p>';
      }
    }
  };

  let sentence1 = [];

  function renderSentenceArea() {
    const area = document.getElementById('sentence-area-1');
    if (!area) return;
    area.innerHTML = '';
    if (sentence1.length === 0) {
      area.classList.remove('border-blue-400');
      area.classList.add('border-gray-300');
      area.innerHTML = '<p class="text-sm text-gray-400">Báº¥m vÃ o tháº» á»Ÿ trÃªn Ä‘á»ƒ thÃªm tá»«...</p>';
      return;
    }
    area.classList.remove('border-gray-300');
    area.classList.add('border-blue-400');
    sentence1.forEach((item, index) => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.textContent = item.word;
      chip.className = 'px-3 py-1 mr-2 mb-2 bg-purple-100 text-purple-800 rounded-full text-sm font-medium hover:bg-purple-200';
      chip.onclick = () => window.removeWordFromSentence(1, index);
      area.appendChild(chip);
    });
  }

  window.addWordToSentence = function (exerciseNum, word, buttonEl) {
    if (exerciseNum === 1) {
      if (buttonEl && buttonEl.disabled) return;
      sentence1.push({ word, button: buttonEl });
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.classList.add('opacity-50', 'cursor-not-allowed');
      }
      renderSentenceArea();
    }
  };

  window.removeWordFromSentence = function (exerciseNum, index) {
    if (exerciseNum === 1) {
      const removed = sentence1.splice(index, 1)[0];
      if (removed && removed.button) {
        removed.button.disabled = false;
        removed.button.classList.remove('opacity-50', 'cursor-not-allowed');
      }
      renderSentenceArea();
    }
  };

  window.checkSentence = function (exerciseNum, correctAnswer) {
    let userAnswer = '';
    let feedbackDiv = null;

    if (exerciseNum === 1) {
      userAnswer = sentence1.map((item) => item.word).join(' ');
      feedbackDiv = document.getElementById('feedback-1');
    }

    if (!feedbackDiv) return;

    feedbackDiv.classList.remove('hidden');
    if (userAnswer === correctAnswer) {
      feedbackDiv.innerHTML =
        '<div class="p-3 rounded bg-green-50 border border-green-200"><p class="text-green-800 font-medium">âœ“ ÄÃºng! CÃ¢u cá»§a báº¡n: ' +
        userAnswer +
        '</p></div>';
    } else {
      feedbackDiv.innerHTML =
        '<div class="p-3 rounded bg-red-50 border border-red-200"><p class="text-red-800 font-medium">âœ— Sai. ÄÃ¡p Ã¡n: ' +
        correctAnswer +
        '</p></div>';
    }
  };

  window.checkWrittenSentence = function (inputName, correctAnswers) {
    const input = document.querySelector(`textarea[name="${inputName}"]`);
    const feedbackDiv = document.getElementById(`feedback-${inputName}`);

    if (!input || !feedbackDiv) return;

    const userAnswer = input.value.trim();

    feedbackDiv.classList.remove('hidden');
    const answersArray = Array.isArray(correctAnswers)
      ? correctAnswers
      : (correctAnswers || '')
          .split('|')
          .map((ans) => ans.trim())
          .filter(Boolean);

    if (answersArray.some((ans) => userAnswer === ans)) {
      feedbackDiv.innerHTML =
        '<div class="p-3 rounded bg-green-50 border border-green-200"><p class="text-green-800 font-medium">âœ“ ÄÃºng!</p></div>';
    } else {
      feedbackDiv.innerHTML =
        '<div class="p-3 rounded bg-yellow-50 border border-yellow-200"><p class="text-yellow-800 font-medium">CÃ³ thá»ƒ Ä‘Ãºng. Gá»£i Ã½: ' +
        (answersArray[0] || '') +
        '</p></div>';
    }
  };

  window.checkFreeSentence = function (inputName) {
    const input = document.querySelector(`textarea[name="${inputName}"]`);
    const feedbackDiv = document.getElementById(`feedback-${inputName}`);

    if (!input || !feedbackDiv) return;

    const userAnswer = input.value.trim();
    const hasE = userAnswer.includes('ì—');
    const hasCorrectVerb = /(ìˆì–´ìš”|ìˆìŠµë‹ˆë‹¤|ì—†ì–´ìš”|ì—†ìŠµë‹ˆë‹¤|ì‚´ì•„ìš”|ì‚´ìŠµë‹ˆë‹¤)/.test(userAnswer);

    feedbackDiv.classList.remove('hidden');
    if (hasE && hasCorrectVerb) {
      feedbackDiv.innerHTML =
        '<div class="p-3 rounded bg-green-50 border border-green-200"><p class="text-green-800 font-medium">âœ“ CÃ³ váº» Ä‘Ãºng! CÃ¢u cá»§a báº¡n: ' +
        userAnswer +
        '</p></div>';
    } else {
      feedbackDiv.innerHTML =
        '<div class="p-3 rounded bg-yellow-50 border border-yellow-200"><p class="text-yellow-800 font-medium">Kiá»ƒm tra láº¡i: cÃ¢u pháº£i cÃ³ \'ì—\' vÃ  Ä‘á»™ng tá»« ìˆë‹¤/ì—†ë‹¤/ì‚´ë‹¤</p></div>';
    }
  };

  window.checkMiniTest = function () {
    let score = 0;
    let total = Object.keys(s5Answers).length;

    Object.keys(s5Answers).forEach((qId) => {
      const inputs = document.querySelectorAll(`input[name="${qId}"]`);
      if (inputs.length > 0) {
        inputs.forEach((input) => {
          if (input.value.trim() === s5Answers[qId] && (input as HTMLInputElement).checked) {
            score++;
            input.classList.add('border-green-500');
          } else if ((input as HTMLInputElement).checked) {
            input.classList.add('border-red-500');
          }
        });
      } else {
        const textInput = document.querySelector(`[name="${qId}"]`);
        if (textInput && textInput.value.trim() === s5Answers[qId]) {
          score++;
          textInput.classList.add('border-green-500');
        } else if (textInput) {
          textInput.classList.add('border-red-500');
        }
      }
    });

    const s5q5 = document.querySelector('textarea[name="s5q5"]');
    const s5q6 = document.querySelector('textarea[name="s5q6"]');
    if (s5q5 && s5q5.value.trim().length > 0) {
      total++;
      if (s5q5.value.trim().includes('ì—')) score++;
    }
    if (s5q6 && s5q6.value.trim().length > 0) {
      total++;
      if (s5q6.value.trim().includes('ì—')) score++;
    }

    const percentage = Math.round((score / total) * 100);
    const resultDiv = document.getElementById('mini-test-result');
    if (!resultDiv) return;

    resultDiv.classList.remove('hidden');

    let badge = '';
    if (percentage >= 80) {
      badge =
        '<div class="p-4 bg-yellow-100 border-2 border-yellow-400 rounded-lg mb-4"><h3 class="text-2xl font-bold text-yellow-800 text-center">ğŸ† ì— Master (Level 1)</h3></div>';
    } else if (percentage >= 60) {
      badge =
        '<div class="p-4 bg-blue-100 border-2 border-blue-400 rounded-lg mb-4"><h3 class="text-xl font-bold text-blue-800 text-center">Tá»‘t! HÃ£y luyá»‡n thÃªm</h3></div>';
    }

    resultDiv.innerHTML = `
        ${badge}
        <div class="p-6 bg-gray-50 rounded-lg">
          <h3 class="text-xl font-bold mb-4">Káº¿t quáº£: ${score}/${total} cÃ¢u (${percentage}%)</h3>
          ${
            percentage >= 80
              ? '<p class="text-green-600 font-medium">âœ“ Xuáº¥t sáº¯c! Báº¡n Ä‘Ã£ náº¯m vá»¯ng ngá»¯ phÃ¡p \\'ì—\\'.</p>'
              : percentage >= 60
              ? '<p class="text-blue-600 font-medium">Tá»‘t! HÃ£y xem láº¡i pháº§n cÃ²n sai vÃ  luyá»‡n thÃªm Section 2 & 3.</p>'
              : '<p class="text-red-600 font-medium">HÃ£y xem láº¡i Section 2 & 3 trÆ°á»›c khi lÃ m láº¡i bÃ i test nÃ y.</p>'
          }
          <div class="mt-4 p-4 bg-white rounded">
            <p class="font-semibold mb-2">Gá»£i Ã½:</p>
            <p class="text-sm text-gray-700">Viáº¿t 3 cÃ¢u vá» báº£n thÃ¢n dÃ¹ng 'ì—':</p>
            <ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1">
              <li>Báº¡n Ä‘ang á»Ÿ Ä‘Ã¢u?</li>
              <li>Báº¡n sá»‘ng á»Ÿ Ä‘Ã¢u?</li>
              <li>Trong phÃ²ng báº¡n cÃ³ gÃ¬?</li>
            </ul>
          </div>
        </div>
      `;

    if (percentage >= 70) {
      window.completeSection(5);
    }

    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  };
</script>

<style>
  .section-btn.active {
    background-color: #3b82f6;
    color: white;
  }
  .section-btn.completed {
    background-color: #10b981;
    color: white;
  }
  .question-item {
    transition: transform 0.2s;
  }
  .question-item:hover {
    transform: translateY(-2px);
  }
  .word-card {
    transition: all 0.2s;
  }
  .word-card:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .question-item label,
  .question-item label span {
    color: #111827;
  }
</style>

