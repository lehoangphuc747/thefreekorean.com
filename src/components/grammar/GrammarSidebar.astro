---
import { getCollection } from 'astro:content';
import './GrammarSidebar.css';

/**
 * GrammarSidebar Component
 * 
 * Displays a collapsible sidebar with a list of grammar points grouped by level.
 * Features:
 * - Search functionality (client-side)
 * - Accordion-style level grouping
 * - Active state highlighting
 * - Auto-scroll to active item
 */

// 1. Fetch Data
const allGrammarRaw = await getCollection('grammar');

// 2. Filter valid entries (exclude drafts)
const allGrammar = allGrammarRaw.filter(entry => {
  return !entry.slug.endsWith('-draft') && 
         !entry.slug.endsWith('-original');
});

// 3. Sort entries (Level > Order)
const sortedGrammar = allGrammar.sort((a, b) => {
  const levelOrder = { beginner: 1, intermediate: 2, advanced: 3 };
  if (levelOrder[a.data.level] !== levelOrder[b.data.level]) {
    return levelOrder[a.data.level] - levelOrder[b.data.level];
  }
  return a.data.order - b.data.order;
});

// 4. Data Structures
const levelMap = {
  beginner: 'S∆° c·∫•p',
  intermediate: 'Trung c·∫•p',
  advanced: 'Cao c·∫•p'
};

type LevelKey = keyof typeof levelMap;
const levelKeys: LevelKey[] = ['beginner', 'intermediate', 'advanced'];

const groupedGrammar: Record<LevelKey, typeof sortedGrammar> = {
  beginner: [],
  intermediate: [],
  advanced: []
};

sortedGrammar.forEach((entry) => {
  const level = entry.data.level as LevelKey;
  if (groupedGrammar[level]) {
    groupedGrammar[level].push(entry);
  }
});

const totalCount = sortedGrammar.length;
---

<aside class="grammar-sidebar w-[300px] bg-white border border-slate-200 rounded-2xl flex flex-col overflow-hidden shadow-sm z-30 transition-[width] duration-300 ease-in-out group/sidebar relative" id="grammar-sidebar">
  
  <!-- 1. Collapsed State View -->
  <div 
    id="sidebar-expand-trigger"
    class="hidden group-[.collapsed]/sidebar:flex w-12 flex-col items-center py-4 h-full bg-slate-50 border-r border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors"
    title="M·ªü danh s√°ch"
  >
    <button class="p-2 mb-4 text-slate-400 hover:text-indigo-600 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m13 17 5-5-5-5"/><path d="m6 17 5-5-5-5"/></svg>
    </button>
    <div class="grow flex items-center justify-center">
      <span class="[writing-mode:vertical-rl] rotate-180 text-xs font-bold text-slate-400 tracking-widest whitespace-nowrap uppercase">Danh s√°ch ng·ªØ ph√°p</span>
    </div>
  </div>

  <!-- 2. Expanded State Wrapper -->
  <div class="flex flex-col h-full w-[300px] group-[.collapsed]/sidebar:hidden">
    
    <!-- Header Section (Fixed) -->
    <div class="p-5 border-b border-slate-100 bg-white z-10 relative">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-lg font-bold text-slate-800">Ng·ªØ ph√°p</h2>
          <span class="text-xs text-slate-500 font-medium">{totalCount} m·∫´u c√¢u</span>
        </div>
        
        <div class="flex items-center">
          <!-- Collapse Button (Desktop) -->
          <button id="sidebar-collapse-btn" class="hidden lg:flex p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 rounded-lg transition-colors mr-1" title="Thu g·ªçn">
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>
          </button>

          <!-- Mobile Close Button (Visible only on mobile when open) -->
          <button id="sidebar-close-mobile" class="lg:hidden p-2 text-slate-400 hover:text-slate-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
  
      <!-- Search Box -->
      <div class="relative group">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-4 w-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </div>
        <input 
          id="sidebar-search-input" 
          type="text" 
          class="block w-full pl-9 pr-8 py-2 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-100 focus:border-indigo-400 transition-all outline-none text-slate-700 placeholder:text-slate-400"
          placeholder="T√¨m ki·∫øm..." 
          autocomplete="off"
        />
        <!-- Clear Button -->
        <button id="sidebar-search-clear" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-rose-500 hidden cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  
    <!-- List Content (Scrollable) -->
    <div class="sidebar-content flex-1 overflow-y-auto p-3 space-y-4" id="sidebar-content">
      {levelKeys.map((level) => (
        <div class="level-section" data-level-section={level}>
          
          <!-- Level Header (Accordion Toggle) -->
          <button 
            class="level-header w-full flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 transition-colors group text-left sticky top-0 bg-white/95 backdrop-blur-none z-10" 
            data-level-toggle={level}
            aria-expanded="true"
          >
            <div class="flex items-center gap-2">
              <span class={`text-[10px] uppercase font-bold px-2 py-0.5 rounded border ${
                level === 'beginner' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' :
                level === 'intermediate' ? 'bg-amber-50 text-amber-600 border-amber-100' :
                'bg-rose-50 text-rose-600 border-rose-100'
              }`}>
                {levelMap[level]}
              </span>
              <span class="text-xs text-slate-400 font-medium">({groupedGrammar[level].length})</span>
            </div>
            <svg class="w-4 h-4 text-slate-400 group-hover:text-slate-600 transition-transform duration-200 level-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
  
          <!-- Grammar Items List -->
          <ul class="grammar-list mt-1 space-y-0.5" data-level-list={level}>
            {groupedGrammar[level].map((grammar) => {
              const slug = grammar.data.slug || grammar.slug;
              return (
                <li>
                  <a
                    href={`/grammar/${grammar.data.level}/${slug}`}
                    class="grammar-item block px-3 py-2 rounded-lg text-sm text-slate-600 hover:bg-slate-50 hover:text-indigo-600 transition-all border-l-2 border-transparent hover:border-indigo-200 group"
                    data-level={grammar.data.level}
                    data-slug={slug}
                  >
                    <div class="item-title font-medium group-hover:translate-x-1 transition-transform" data-original-text={grammar.data.title}>{grammar.data.title}</div>
                    <div class="item-meaning text-xs text-slate-400 truncate mt-0.5 group-hover:text-indigo-400" data-original-text={grammar.data.meaning}>{grammar.data.meaning}</div>
                    
                    {/* Hidden metadata for search */}
                    <span class="hidden item-tags">{grammar.data.tags?.join(' ')}</span>
                  </a>
                </li>
              );
            })}
          </ul>
        </div>
      ))}
  
      <!-- Empty State -->
      <div class="hidden flex-col items-center justify-center py-10 text-center" data-empty-state>
        <div class="text-4xl mb-2">üîç</div>
        <p class="text-sm text-slate-500 font-medium">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>
        <p class="text-xs text-slate-400 mt-1">Th·ª≠ t√¨m b·∫±ng t·ª´ kho√° kh√°c xem sao</p>
      </div>
    </div>
  </div>
</aside>

<script>
  /**
   * GrammarSidebar Client-side Logic
   * Handles:
   * 1. Search filtering
   * 2. Accordion toggling
   * 3. Active item highlighting
   * 4. Mobile responsive behavior
   */

  document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('grammar-sidebar');
    if (!sidebar) return;

    // Elements
    const searchInput = document.getElementById('sidebar-search-input') as HTMLInputElement;
    const clearButton = document.getElementById('sidebar-search-clear');
    const emptyState = sidebar.querySelector('[data-empty-state]');
    
    // --- 1. Accordion Logic ---
    const toggleLevel = (level: string, show: boolean) => {
      const list = sidebar.querySelector(`[data-level-list="${level}"]`);
      const header = sidebar.querySelector(`[data-level-toggle="${level}"]`);
      const chevron = header?.querySelector('.level-chevron');
      
      if (list && list instanceof HTMLElement) {
        list.style.display = show ? 'block' : 'none';
        header?.setAttribute('aria-expanded', String(show));
        
        if (chevron) {
          chevron.style.transform = show ? 'rotate(0deg)' : 'rotate(-90deg)';
        }
      }
    };

    sidebar.querySelectorAll('[data-level-toggle]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const header = e.currentTarget as HTMLElement;
        const level = header.dataset.levelToggle;
        const isExpanded = header.getAttribute('aria-expanded') === 'true';
        if (level) toggleLevel(level, !isExpanded);
      });
    });

    // --- 2. Active Item Highlighting ---
    const highlightActiveItem = () => {
      const currentPath = window.location.pathname.replace(/\/$/, '');
      const items = sidebar.querySelectorAll('.grammar-item');
      
      let activeFound = false;
      let activeLevel = null;

      items.forEach(item => {
        const href = item.getAttribute('href')?.replace(/\/$/, '');
        if (href === currentPath) {
          item.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-500', 'font-semibold');
          item.classList.remove('text-slate-600', 'border-transparent');
          activeFound = true;
          activeLevel = (item as HTMLElement).dataset.level;
          
          // Scroll active item into view
          setTimeout(() => {
            item.scrollIntoView({ block: 'center', behavior: 'smooth' });
          }, 200);
        } else {
          // Reset styles
          item.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-500', 'font-semibold');
          item.classList.add('text-slate-600', 'border-transparent');
        }
      });

      // Expand the level containing the active item
      if (activeLevel) {
        toggleLevel(activeLevel, true);
        // Collapse others (optional, maybe keep all open for exploration?)
        // For now: keep others as is, only ensure active is open.
      }
    };

    highlightActiveItem(); // Run on load

    // --- 3. Search Logic ---
    const normalizeText = (text: string) => text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    const handleSearch = () => {
      const query = normalizeText(searchInput.value.trim());
      const hasQuery = query.length > 0;
      let hasResults = false;

      // Show/Hide clear button
      if (clearButton) clearButton.classList.toggle('hidden', !hasQuery);

      sidebar.querySelectorAll('[data-level-section]').forEach(section => {
        const items = section.querySelectorAll('.grammar-item');
        let hasVisibleItems = false;
        const level = (section as HTMLElement).dataset.levelSection;

        items.forEach(item => {
          const el = item as HTMLElement;
          const title = normalizeText(el.querySelector('.item-title')?.textContent || '');
          const meaning = normalizeText(el.querySelector('.item-meaning')?.textContent || '');
          const tags = normalizeText(el.querySelector('.item-tags')?.textContent || '');

          const matches = !hasQuery || title.includes(query) || meaning.includes(query) || tags.includes(query);
          
          el.parentElement!.style.display = matches ? 'block' : 'none';
          if (matches) hasVisibleItems = true;
        });

        // Toggle section visibility based on items
        (section as HTMLElement).style.display = (hasVisibleItems || !hasQuery) ? 'block' : 'none';
        
        // Auto expand if researching
        if (hasQuery && hasVisibleItems && level) {
          toggleLevel(level, true);
        }

        if (hasVisibleItems) hasResults = true;
      });

      // Empty state
      if (emptyState && emptyState instanceof HTMLElement) {
        emptyState.classList.toggle('hidden', hasResults);
        emptyState.classList.toggle('flex', !hasResults);
      }
    };

    searchInput.addEventListener('input', handleSearch);
    
    if (clearButton) {
      clearButton.addEventListener('click', () => {
        searchInput.value = '';
        handleSearch();
        searchInput.focus();
      });
    }

    // --- 4. Mobile Close Button ---
    const closeBtn = document.getElementById('sidebar-close-mobile');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        sidebar.classList.remove('open');
        window.dispatchEvent(new CustomEvent('tfk:panel-state-change'));
      });
    }

    // --- 5. Collapse/Expand Logic ---
    const collapseBtn = document.getElementById('sidebar-collapse-btn');
    const expandTrigger = document.getElementById('sidebar-expand-trigger');

    const setCollapsed = (collapsed: boolean) => {
       if (collapsed) {
         sidebar.classList.add('collapsed');
         sidebar.classList.remove('w-[300px]');
         sidebar.classList.add('w-12');
       } else {
         sidebar.classList.remove('collapsed');
         sidebar.classList.add('w-[300px]');
         sidebar.classList.remove('w-12');
       }
       // Save preference
       localStorage.setItem('tfk:grammar-sidebar-collapsed', String(collapsed));
    };

    if (collapseBtn) {
      collapseBtn.addEventListener('click', () => setCollapsed(true));
    }

    expandTrigger?.addEventListener('click', () => setCollapsed(false));

    // Restore preference
    const savedState = localStorage.getItem('tfk:grammar-sidebar-collapsed');
    if (savedState === 'true') {
      setCollapsed(true);
    }
  });
</script>
