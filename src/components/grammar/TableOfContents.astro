---
/**
 * TableOfContents Component
 * 
 * Displays a sticky table of contents for the grammar post.
 * Features:
 * - Nested levels (h2, h3)
 * - Scrollspy (Active highlighting)
 * - Collapsible state
 */

export interface Props {
  headings: Array<{
    id: string;
    text: string;
    level: number;
  }>;
}

const { headings } = Astro.props;
---

<!-- TOC Container -->
<nav 
  id="toc-container" 
  class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden transition-all duration-300 w-full"
  aria-label="Table of Contents"
>
  <!-- Header -->
  <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-white">
    <h3 class="font-bold text-slate-700 text-sm uppercase tracking-wide">Mục lục</h3>
    <button 
      id="toc-toggle" 
      class="text-slate-400 hover:text-indigo-600 transition-colors p-1 rounded-md hover:bg-slate-50"
      title="Thu gọn/Mở rộng"
    >
      <svg class="w-4 h-4 transform transition-transform duration-300" id="toc-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </button>
  </div>

  <!-- List -->
  <div id="toc-content" class="max-h-[calc(100vh-200px)] overflow-y-auto overflow-x-hidden p-3 transition-all duration-300">
    <ul class="space-y-1">
      {headings.map(heading => (
        <li 
          class:list={[
            'transition-colors duration-200 rounded-lg',
            heading.level === 2 ? 'pl-0' : 'pl-4',
            heading.level === 3 ? 'pl-8' : '',
            'toc-item'
          ]}
        >
          <a
            href={`#${heading.id}`}
            class="block py-1.5 px-3 text-sm text-slate-500 hover:text-indigo-600 hover:bg-slate-50 rounded-md transition-all truncate border-l-2 border-transparent"
            data-heading-link={heading.id}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
    
    {headings.length === 0 && (
      <p class="text-xs text-slate-400 text-center py-4">Bài viết chưa có mục lục</p>
    )}
  </div>
</nav>

<script>
  /**
   * TOC Client Logic
   * Handles scrollspy active state and collapse toggling.
   */
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('toc-container');
    const content = document.getElementById('toc-content');
    const toggleBtn = document.getElementById('toc-toggle');
    const chevron = document.getElementById('toc-chevron');
    const links = document.querySelectorAll('[data-heading-link]');
    
    // --- 1. Collapse Logic ---
    let isCollapsed = false;

    const toggleToc = () => {
      isCollapsed = !isCollapsed;
      
      if (isCollapsed) {
        content?.classList.add('hidden');
        if (chevron) chevron.style.transform = 'rotate(-90deg)';
      } else {
        content?.classList.remove('hidden');
        if (chevron) chevron.style.transform = 'rotate(0deg)';
      }
    };

    toggleBtn?.addEventListener('click', toggleToc);

    // --- 2. Scrollspy (Active State) ---
    const observerCallback = (entries: IntersectionObserverEntry[]) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          
          // Remove active from all
          links.forEach(link => {
            link.classList.remove('text-indigo-600', 'bg-indigo-50', 'font-medium', 'border-indigo-500');
            link.classList.add('text-slate-500', 'border-transparent');
          });

          // Add active to current
          const activeLink = document.querySelector(`[data-heading-link="${id}"]`);
          if (activeLink) {
            activeLink.classList.remove('text-slate-500', 'border-transparent');
            activeLink.classList.add('text-indigo-600', 'bg-indigo-50', 'font-medium', 'border-indigo-500');
            
            // Auto scroll TOC
            activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        }
      });
    };

    const observer = new IntersectionObserver(observerCallback, {
      rootMargin: '-100px 0px -66% 0px', // Trigger when heading is near top
      threshold: 0.1
    });

    // Observe all headings
    headings.forEach(h => {
      const el = document.getElementById(h.id);
      if (el) observer.observe(el);
    });

    // Manual list of headings for observer context
    const headings = Array.from(document.querySelectorAll('h2, h3, h4')).filter(h => h.id);
    headings.forEach(h => observer.observe(h));
  });
</script>
