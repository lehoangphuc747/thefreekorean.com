---
export interface Props {
  choices: Array<{ type: string; text?: string; src?: string; alt?: string }>;
  answer: number;
  selectedIndex: number | null;
  onSelect: (index: number) => void;
}

const { choices, answer, selectedIndex, onSelect } = Astro.props;

// Xáo trộn thứ tự các đáp án
function shuffleArray<T>(array: T[]): { shuffled: T[]; mapping: number[] } {
  // Tạo mảng indices và copy của array
  const indices = array.map((_, i) => i);
  const shuffled = [...array];
  
  // Fisher-Yates shuffle algorithm
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    [indices[i], indices[j]] = [indices[j], indices[i]];
  }
  
  // Tạo mapping từ index mới -> index gốc
  const mapping = new Array(shuffled.length);
  indices.forEach((originalIndex, newIndex) => {
    mapping[newIndex] = originalIndex;
  });
  
  return { shuffled, mapping };
}

const { shuffled: shuffledChoices, mapping: originalIndices } = shuffleArray(choices);
// Tìm vị trí mới của đáp án đúng
const shuffledAnswerIndex = originalIndices.findIndex((origIdx) => origIdx === answer);
---

<div class="space-y-2" data-choice-list data-original-answer={answer}>
  {shuffledChoices.map((choice, index) => {
    const choiceLetter = String.fromCharCode(65 + index);
    const originalIndex = originalIndices[index];
    const isSelected = selectedIndex === index;
    const isCorrect = index === shuffledAnswerIndex;
    const isSelectedAndCorrect = isSelected && isCorrect;
    const isSelectedAndWrong = isSelected && !isCorrect;
    const isCorrectAnswerButNotSelected = isCorrect && selectedIndex !== null && !isSelected;
    
    // Xác định class màu sắc
    let choiceClasses = "choice-item p-3 border-2 rounded-lg transition-colors cursor-pointer";
    
    if (selectedIndex === null) {
      // Chưa chọn - bình thường
      choiceClasses += " border-gray-200 hover:border-blue-400";
    } else {
      // Đã chọn
      if (isSelectedAndCorrect) {
        // User chọn đúng - màu xanh
        choiceClasses += " bg-green-100 border-green-400";
      } else if (isSelectedAndWrong) {
        // User chọn sai - màu đỏ
        choiceClasses += " bg-red-100 border-red-400";
      } else if (isCorrectAnswerButNotSelected) {
        // Đáp án đúng nhưng user không chọn (user đã chọn sai) - xanh viền
        choiceClasses += " bg-green-50 border-green-400 border-2";
      } else {
        // Các lựa chọn khác - disabled
        choiceClasses += " border-gray-200 opacity-60";
      }
    }
    
    return (
      <div 
        class={choiceClasses}
        data-choice-index={index}
        data-original-index={originalIndex}
        data-choice-letter={choiceLetter}
        data-choice-is-correct={isCorrect}
      >
        <span class="font-medium text-gray-700 mr-2">
          {choiceLetter}.
        </span>
        {choice.type === 'text' ? (
          <span class="text-gray-800">{choice.text}</span>
        ) : choice.type === 'image' ? (
          <img 
            src={choice.src} 
            alt={choice.alt || `Choice ${choiceLetter}`} 
            class="rounded-lg max-w-xs mt-2" 
          />
        ) : (
          // Fallback cho format cũ
          <span class="text-gray-800">
            {typeof choice === 'string' ? choice : choice.text || ''}
          </span>
        )}
      </div>
    );
  })}
</div>

<script>
  // Hàm khởi tạo choice list
  function initializeChoiceList(choiceList) {
    if (!choiceList || choiceList.hasAttribute('data-initialized')) return;
    
    choiceList.setAttribute('data-initialized', 'true');
    
    const choiceItems = choiceList.querySelectorAll('.choice-item');
    let isDisabled = false;
    
    choiceItems.forEach((item) => {
      item.addEventListener('click', function(e) {
        // Kiểm tra xem đã disabled chưa (đã chọn rồi)
        if (isDisabled) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        if (this.style.pointerEvents === 'none') {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        if (this.hasAttribute('data-disabled')) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        
        const index = parseInt(this.getAttribute('data-choice-index') || '0');
        
        console.log('Choice clicked:', index);
        
        // Mark as disabled ngay lập tức để tránh double click
        isDisabled = true;
        choiceItems.forEach((choice) => {
          choice.setAttribute('data-disabled', 'true');
        });
        
        // Emit custom event để component cha nhận
        const event = new CustomEvent('choice-select', { 
          detail: { index },
          bubbles: true,
          cancelable: true
        });
        choiceList.dispatchEvent(event);
      });
    });
  }
  
  // Initialize on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', () => {
    const allChoiceLists = document.querySelectorAll('[data-choice-list]');
    allChoiceLists.forEach((choiceList) => {
      initializeChoiceList(choiceList);
    });
  });
  
  // Re-initialize for Astro view transitions
  document.addEventListener('astro:page-load', () => {
    const allChoiceLists = document.querySelectorAll('[data-choice-list]');
    allChoiceLists.forEach((choiceList) => {
      initializeChoiceList(choiceList);
    });
  });
  
  // Initialize immediately for any existing elements (fallback)
  if (document.readyState === 'loading') {
    // Wait for DOMContentLoaded
  } else {
    // DOM is already ready
    const allChoiceLists = document.querySelectorAll('[data-choice-list]');
    allChoiceLists.forEach((choiceList) => {
      initializeChoiceList(choiceList);
    });
  }
</script>

<style>
  .choice-item {
    transition: all 0.2s ease;
  }
  
  .choice-item:hover {
    transform: translateX(4px);
  }
  
  .choice-item[style*="pointer-events: none"] {
    cursor: not-allowed;
  }
</style>

