---
export interface Props {
  markdown: string;
  slug: string;
  title: string;
  meaning: string;
  level: string;
  description: string;
  tags: string[];
}

const { markdown, slug, title, meaning, level, description, tags } = Astro.props;

// Level mapping
const levelMap = {
  beginner: 'S∆° c·∫•p',
  intermediate: 'Trung c·∫•p',
  advanced: 'Cao c·∫•p'
};
---

<button 
  class="action-btn pdf-generator-btn" 
  id="pdf-generator-btn"
  data-slug={slug}
>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8Z"/>
    <polyline points="14,2 14,8 20,8"/>
    <line x1="16" y1="13" x2="8" y2="13"/>
    <line x1="16" y1="17" x2="8" y2="17"/>
    <polyline points="10,9 9,9 8,9"/>
  </svg>
  T·∫£i PDF
</button>

<style>
  .pdf-generator-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    color: #374151;
    text-align: center;
  }

  .pdf-generator-btn:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #f8fafc;
  }

  .pdf-generator-btn:active {
    transform: translateY(1px);
  }

  .pdf-generator-btn:disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  @media (max-width: 768px) {
    .pdf-generator-btn {
      width: 100%;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  import { jsPDF } from 'jspdf';
  import html2canvas from 'html2canvas';
  
  document.addEventListener('DOMContentLoaded', function() {
    const pdfBtn = document.getElementById('pdf-generator-btn') as HTMLButtonElement;
    
    if (!pdfBtn) return;
    
    pdfBtn.addEventListener('click', async function() {
      const slug = this.dataset.slug || 'document';
      
      // Save original state
      const originalHTML = this.innerHTML;
      
      try {
        // Show loading
        this.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 11-6.219-8.56"/>
          </svg>
          ƒêang t·∫°o PDF...
        `;
        this.disabled = true;

        // Get the main content
        const content = document.querySelector('.grammar-post') as HTMLElement;
        if (!content) {
          throw new Error('Kh√¥ng t√¨m th·∫•y n·ªôi dung');
        }

        // Create temporary container for PDF
        const pdfContainer = document.createElement('div');
        pdfContainer.style.position = 'fixed';
        pdfContainer.style.left = '-9999px';
        pdfContainer.style.top = '0';
        pdfContainer.style.width = '794px'; // A4 width in pixels at 96 DPI
        pdfContainer.style.padding = '40px';
        pdfContainer.style.background = 'white';
        pdfContainer.style.fontFamily = 'system-ui, -apple-system, sans-serif';
        
        // Add header
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.marginBottom = '30px';
        header.style.paddingBottom = '20px';
        header.style.borderBottom = '3px solid #3b82f6';
        header.innerHTML = `
          <div style="font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">
            üìö THE FREE KOREAN
          </div>
          <div style="font-size: 14px; color: #666;">
            Ng·ªØ ph√°p ti·∫øng H√†n
          </div>
        `;
        pdfContainer.appendChild(header);
        
        // Clone and add content
        const contentClone = content.cloneNode(true) as HTMLElement;
        
        // Remove unwanted elements
        const removeSelectors = [
          '.breadcrumb',
          '.back-button',
          '.action-buttons',
          '.navigation-buttons',
          '.related-grammar',
          'button',
          '.share-button'
        ];
        
        removeSelectors.forEach(selector => {
          contentClone.querySelectorAll(selector).forEach(el => el.remove());
        });
        
        pdfContainer.appendChild(contentClone);
        
        // Add footer watermark
        const footer = document.createElement('div');
        footer.style.marginTop = '30px';
        footer.style.paddingTop = '20px';
        footer.style.borderTop = '1px solid #e5e7eb';
        footer.style.textAlign = 'center';
        footer.style.fontSize = '12px';
        footer.style.color = '#999';
        footer.innerHTML = '¬© The Free Korean - thefreekorean.com';
        pdfContainer.appendChild(footer);
        
        document.body.appendChild(pdfContainer);

        // Capture as canvas
        const canvas = await html2canvas(pdfContainer, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });

        // Remove temporary container
        document.body.removeChild(pdfContainer);

        // --- LOGIC M·ªöI: C·∫ÆT ·∫¢NH TH√îNG MINH ƒê·ªÇ TR√ÅNH C·∫ÆT NGANG CH·ªÆ (SMART SPLIT) ---
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pageHeightMM = 297; // A4 height
        const pageWidthMM = 210;  // A4 width
        const marginTopMM = 15;   // L·ªÅ tr√™n 15mm
        const marginBottomMM = 15;// L·ªÅ d∆∞·ªõi 15mm
        const contentHeightMM = pageHeightMM - marginTopMM - marginBottomMM; // Chi·ªÅu cao n·ªôi dung kh·∫£ d·ª•ng

        // T√≠nh to√°n t·ª∑ l·ªá quy ƒë·ªïi t·ª´ px sang mm d·ª±a tr√™n chi·ªÅu r·ªông
        const pxToMm = pageWidthMM / canvas.width;
        
        // Chi·ªÅu cao c·ªßa m·ªôt trang n·ªôi dung t√≠nh theo pixel c·ªßa ·∫£nh g·ªëc
        const pageHeightPx = contentHeightMM / pxToMm; 
        const marginTopPx = marginTopMM / pxToMm;
        
        let currentYPx = 0; // V·ªã tr√≠ hi·ªán t·∫°i tr√™n ·∫£nh g·ªëc (px)
        const totalHeightPx = canvas.height;
        const originalCtx = canvas.getContext('2d');

        // H√†m ki·ªÉm tra d√≤ng tr·∫Øng (ho·∫∑c g·∫ßn tr·∫Øng)
        const isLineBlank = (ctx: CanvasRenderingContext2D, y: number, width: number): boolean => {
           // L·∫•y 1 d√≤ng pixel t·∫°i y
           try {
              const pixelData = ctx.getImageData(0, y, width, 1).data;
              // Ki·ªÉm tra xem c√≥ pixel n√†o KH√îNG ph·∫£i m√†u tr·∫Øng kh√¥ng
              // Duy·ªát qua t·ª´ng pixel (4 byte: r, g, b, a)
              for (let i = 0; i < pixelData.length; i += 4) {
                  const r = pixelData[i];
                  const g = pixelData[i + 1];
                  const b = pixelData[i + 2];
                  // N·∫øu pixel t·ªëi m√†u (t·ªïng m√†u < 750/765 ~ 98% tr·∫Øng), coi l√† c√≥ n·ªôi dung
                  // Ho·∫∑c ki·ªÉm tra ƒë∆°n gi·∫£n: r < 250 || g < 250 || b < 250
                  if (r < 250 || g < 250 || b < 250) {
                      return false; // C√≥ n·ªôi dung
                  }
              }
              return true; // D√≤ng tr·∫Øng
           } catch (e) {
              return false; // Fallback n·∫øu l·ªói (v√≠ d·ª• tainted canvas)
           }
        };

        // H√†m t√¨m v·ªã tr√≠ c·∫Øt an to√†n (qu√©t ng∆∞·ª£c t·ª´ d∆∞·ªõi l√™n)
        const findSafeCutY = (ctx: CanvasRenderingContext2D, startY: number, width: number, maxScan: number): number => {
             // Qu√©t ng∆∞·ª£c l√™n maxScan pixels
             for (let y = startY; y > startY - maxScan; y--) {
                 if (isLineBlank(ctx, Math.floor(y), width)) {
                     return y;
                 }
             }
             return startY; // Kh√¥ng t√¨m th·∫•y, ƒë√†nh c·∫Øt t·∫°i ch·ªó c≈©
        };

        while (currentYPx < totalHeightPx) {
          if (currentYPx > 0) {
            pdf.addPage();
          }

          // 1. T√≠nh to√°n v·ªã tr√≠ c·∫Øt (Slice Height)
          let sliceHeightPx = Math.min(pageHeightPx, totalHeightPx - currentYPx);

          // N·∫øu kh√¥ng ph·∫£i trang cu·ªëi, th·ª≠ t√¨m v·ªã tr√≠ c·∫Øt an to√†n ƒë·ªÉ kh√¥ng c·∫Øt ngang ch·ªØ
          if (originalCtx && currentYPx + sliceHeightPx < totalHeightPx) {
               // Qu√©t ng∆∞·ª£c l√™n 50px (kho·∫£ng 1-2 d√≤ng ch·ªØ) ƒë·ªÉ t√¨m ch·ªó tr·∫Øng
               const proposedCutY = currentYPx + sliceHeightPx;
               const safeCutY = findSafeCutY(originalCtx, proposedCutY, canvas.width, 60);
               
               // ƒêi·ªÅu ch·ªânh l·∫°i sliceHeight n·∫øu t√¨m ƒë∆∞·ª£c ch·ªó c·∫Øt m·ªõi
               if (safeCutY < proposedCutY) {
                   sliceHeightPx = safeCutY - currentYPx;
               }
          }

          // 2. T·∫°o canvas t·∫°m cho 1 trang A4
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = canvas.width;
          pageCanvas.height = pageHeightMM / pxToMm; // Chi·ªÅu cao A4 to√†n trang
          const ctx = pageCanvas.getContext('2d');
          
          if (ctx) {
            // T√¥ n·ªÅn tr·∫Øng
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);

            // 3. V·∫Ω watermark m·ªù ·ªü n·ªÅn (V·∫Ω tr∆∞·ªõc n·ªôi dung ƒë·ªÉ n·∫±m d∆∞·ªõi, ho·∫∑c sau ƒë·ªÉ n·∫±m tr√™n. V·∫Ω sau an to√†n h∆°n cho m·ª•c ƒë√≠ch watermark)
            ctx.save();
            ctx.globalAlpha = 0.08; // ƒê·ªô m·ªù r·∫•t th·∫•p
            ctx.font = 'bold 30px Arial, sans-serif';
            ctx.fillStyle = '#94a3b8'; // M√†u x√°m
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Xoay v√† v·∫Ω l·∫∑p l·∫°i ho·∫∑c v·∫Ω 1 c√°i to ·ªü gi·ªØa
            // C√°ch 1: M·ªôt d√≤ng ch·ªØ ch√©o ·ªü gi·ªØa trang
            const centerX = pageCanvas.width / 2;
            const centerY = pageCanvas.height / 2;
            ctx.translate(centerX, centerY);
            ctx.rotate(-45 * Math.PI / 180); // Xoay -45 ƒë·ªô
            ctx.fillText('THEFREEKOREAN.COM', 0, 0);
            
            // V·∫Ω th√™m d√≤ng nh·ªè h∆°n ·ªü d∆∞·ªõi
            ctx.font = '20px Arial, sans-serif';
            ctx.fillText('T√†i li·ªáu mi·ªÖn ph√≠', 0, 40);
            
            ctx.restore();

            // 4. V·∫Ω ph·∫ßn c·∫Øt ƒë√≥ v√†o canvas trang (v·ªã tr√≠ b·∫Øt ƒë·∫ßu t·ª´ l·ªÅ tr√™n)
            ctx.drawImage(
              canvas, 
              0, currentYPx, canvas.width, sliceHeightPx, // Source
              0, marginTopPx, canvas.width, sliceHeightPx // Dest
            );

            // ƒê∆∞a v√†o PDF
            const pageData = pageCanvas.toDataURL('image/jpeg', 0.95);
            pdf.addImage(pageData, 'JPEG', 0, 0, pageWidthMM, pageHeightMM);
          }

          currentYPx += sliceHeightPx;
        }

        // Save PDF
        const fileName = `thefreekorean.com-${slug}.pdf`;
        pdf.save(fileName);

      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('C√≥ l·ªói khi t·∫°o PDF. Vui l√≤ng th·ª≠ l·∫°i sau!');
      } finally {
        this.innerHTML = originalHTML;
        this.disabled = false;
      }
    });
  });
</script>
