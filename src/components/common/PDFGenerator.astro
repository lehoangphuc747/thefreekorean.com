---
export interface Props {
  markdown: string;
  slug: string;
  title: string;
  meaning: string;
  level: string;
  description: string;
  tags: string[];
}

const { markdown, slug, title, meaning, level, description, tags } = Astro.props;

// Level mapping
const levelMap = {
  beginner: 'S∆° c·∫•p',
  intermediate: 'Trung c·∫•p',
  advanced: 'Cao c·∫•p'
};
---

<button 
  class="action-btn pdf-generator-btn" 
  id="pdf-generator-btn"
  data-slug={slug}
>
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8Z"/>
    <polyline points="14,2 14,8 20,8"/>
    <line x1="16" y1="13" x2="8" y2="13"/>
    <line x1="16" y1="17" x2="8" y2="17"/>
    <polyline points="10,9 9,9 8,9"/>
  </svg>
  T·∫£i PDF
</button>

<style>
  .pdf-generator-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    color: #374151;
    text-align: center;
  }

  .pdf-generator-btn:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    background: #f8fafc;
  }

  .pdf-generator-btn:active {
    transform: translateY(1px);
  }

  .pdf-generator-btn:disabled {
    cursor: not-allowed;
    opacity: 0.7;
  }

  @media (max-width: 768px) {
    .pdf-generator-btn {
      width: 100%;
    }
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
  import { jsPDF } from 'jspdf';
  import html2canvas from 'html2canvas';
  
  document.addEventListener('DOMContentLoaded', function() {
    const pdfBtn = document.getElementById('pdf-generator-btn') as HTMLButtonElement;
    
    if (!pdfBtn) return;
    
    pdfBtn.addEventListener('click', async function() {
      const slug = this.dataset.slug || 'document';
      
      // Save original state
      const originalHTML = this.innerHTML;
      
      try {
        // Show loading
        this.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 11-6.219-8.56"/>
          </svg>
          ƒêang t·∫°o PDF...
        `;
        this.disabled = true;

        // Get the main content
        const content = document.querySelector('.grammar-post') as HTMLElement;
        if (!content) {
          throw new Error('Kh√¥ng t√¨m th·∫•y n·ªôi dung');
        }

        // Create temporary container for PDF
        const pdfContainer = document.createElement('div');
        pdfContainer.style.position = 'fixed';
        pdfContainer.style.left = '-9999px';
        pdfContainer.style.top = '0';
        pdfContainer.style.width = '794px'; // A4 width in pixels at 96 DPI
        pdfContainer.style.padding = '40px';
        pdfContainer.style.background = 'white';
        pdfContainer.style.fontFamily = 'system-ui, -apple-system, sans-serif';
        
        // Add header
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.marginBottom = '30px';
        header.style.paddingBottom = '20px';
        header.style.borderBottom = '3px solid #3b82f6';
        header.innerHTML = `
          <div style="font-size: 24px; font-weight: bold; color: #3b82f6; margin-bottom: 5px;">
            üìö THE FREE KOREAN
          </div>
          <div style="font-size: 14px; color: #666;">
            Ng·ªØ ph√°p ti·∫øng H√†n
          </div>
        `;
        pdfContainer.appendChild(header);
        
        // Clone and add content
        const contentClone = content.cloneNode(true) as HTMLElement;
        
        // Remove unwanted elements
        const removeSelectors = [
          '.breadcrumb',
          '.back-button',
          '.action-buttons',
          '.navigation-buttons',
          '.related-grammar',
          'button',
          '.share-button'
        ];
        
        removeSelectors.forEach(selector => {
          contentClone.querySelectorAll(selector).forEach(el => el.remove());
        });
        
        pdfContainer.appendChild(contentClone);
        
        // Add footer watermark
        const footer = document.createElement('div');
        footer.style.marginTop = '30px';
        footer.style.paddingTop = '20px';
        footer.style.borderTop = '1px solid #e5e7eb';
        footer.style.textAlign = 'center';
        footer.style.fontSize = '12px';
        footer.style.color = '#999';
        footer.innerHTML = '¬© The Free Korean - thefreekorean.com';
        pdfContainer.appendChild(footer);
        
        document.body.appendChild(pdfContainer);

        // Capture as canvas
        const canvas = await html2canvas(pdfContainer, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });

        // Remove temporary container
        document.body.removeChild(pdfContainer);

        // --- LOGIC M·ªöI: C·∫ÆT ·∫¢NH ƒê·ªÇ T·∫†O L·ªÄ (MARGIN) ---
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pageHeightMM = 297; // A4 height
        const pageWidthMM = 210;  // A4 width
        const marginTopMM = 15;   // L·ªÅ tr√™n 15mm
        const marginBottomMM = 15;// L·ªÅ d∆∞·ªõi 15mm
        const contentHeightMM = pageHeightMM - marginTopMM - marginBottomMM; // Chi·ªÅu cao n·ªôi dung kh·∫£ d·ª•ng

        // T√≠nh to√°n t·ª∑ l·ªá quy ƒë·ªïi t·ª´ px sang mm d·ª±a tr√™n chi·ªÅu r·ªông
        const pxToMm = pageWidthMM / canvas.width;
        
        // Chi·ªÅu cao c·ªßa m·ªôt trang n·ªôi dung t√≠nh theo pixel c·ªßa ·∫£nh g·ªëc
        const pageHeightPx = contentHeightMM / pxToMm; 
        const marginTopPx = marginTopMM / pxToMm;
        
        let currentYPx = 0; // V·ªã tr√≠ hi·ªán t·∫°i tr√™n ·∫£nh g·ªëc (px)
        const totalHeightPx = canvas.height;

        while (currentYPx < totalHeightPx) {
          if (currentYPx > 0) {
            pdf.addPage();
          }

          // 1. T·∫°o canvas t·∫°m cho 1 trang A4
          const pageCanvas = document.createElement('canvas');
          pageCanvas.width = canvas.width;
          pageCanvas.height = pageHeightMM / pxToMm; // Chi·ªÅu cao A4 t√≠nh theo pixel t∆∞∆°ng ·ª©ng t·ª∑ l·ªá ·∫£nh
          const ctx = pageCanvas.getContext('2d');
          
          if (ctx) {
            // 2. T√¥ n·ªÅn tr·∫Øng cho to√†n b·ªô trang (ƒë·ªÉ t·∫°o l·ªÅ tr·∫Øng)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, pageCanvas.width, pageCanvas.height);

            // 3. T√≠nh to√°n ph·∫ßn ·∫£nh c·∫ßn c·∫Øt t·ª´ canvas g·ªëc
            // Chi·ªÅu cao ph·∫ßn c·∫ßn c·∫Øt: l·∫•y chi·ªÅu cao trang n·ªôi dung, ho·∫∑c ph·∫ßn c√≤n l·∫°i n·∫øu n·ªè h∆°n
            const sliceHeightPx = Math.min(pageHeightPx, totalHeightPx - currentYPx);

            // 4. V·∫Ω ph·∫ßn c·∫Øt ƒë√≥ v√†o canvas trang (v·ªã tr√≠ b·∫Øt ƒë·∫ßu t·ª´ l·ªÅ tr√™n)
            ctx.drawImage(
              canvas, 
              0, currentYPx, canvas.width, sliceHeightPx, // Source: x, y, w, h
              0, marginTopPx, canvas.width, sliceHeightPx // Dest: x, y, w, h
            );

            // 5. ƒê∆∞a canvas trang n√†y v√†o PDF
            const pageData = pageCanvas.toDataURL('image/jpeg', 0.95); // D√πng JPEG ƒë·ªÉ gi·∫£m dung l∆∞·ª£ng
            pdf.addImage(pageData, 'JPEG', 0, 0, pageWidthMM, pageHeightMM);
          }

          currentYPx += pageHeightPx;
        }

        // Save PDF
        const fileName = `thefreekorean.com-${slug}.pdf`;
        pdf.save(fileName);

      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('C√≥ l·ªói khi t·∫°o PDF. Vui l√≤ng th·ª≠ l·∫°i sau!');
      } finally {
        this.innerHTML = originalHTML;
        this.disabled = false;
      }
    });
  });
</script>
